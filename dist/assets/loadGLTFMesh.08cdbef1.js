import{ab as e,a8 as t,aj as r,j0 as o,kV as n,fI as s,lh as a,lL as i,lf as l,H as c,gx as u,b$ as f,kT as m,gv as p,mK as d,mL as x,mM as g,s3 as b}from"./vendor.c9efa5f2.js";import{m as v,c as h,y as w,f as y}from"./MeshComponent.1b3d2d95.js";import{e as C,f as A,t as j,r as M,a as T,n as B}from"./vec33.e99e2659.js";import{n as F,l as I,r as E,o as L,a as R,t as S,b as O,g as k,f as D,e as N,h as q,i as G,c as K,d as V}from"./DefaultMaterial_COLOR_GAMMA.8f5492de.js";import{k as _}from"./georeference.4de298f3.js";import"./Version.79deacb4.js";import"./axisAngleDegrees.f2f09ac8.js";import"./projection.8026eb34.js";async function z(m,p,d){const x=new F(function(r){return null!=r&&r.resolveFile?{busy:!1,request:async(o,n,s)=>{const a=r.resolveFile(o),i="image"===n?"image":"binary"===n?"array-buffer":"json";return(await e(a,{responseType:i,signal:t(s)?s.signal:null})).data}}:null}(d)),g=(await I(x,p,d,!0)).model,b=g.lods.shift(),y=new Map,C=new Map;g.textures.forEach(((e,t)=>y.set(t,function(e){return new v({data:e.data,wrap:Q(e.parameters.wrap)})}(e)))),g.materials.forEach(((e,t)=>C.set(t,function(e,t){const n=new c(function(e,t){return u($(e[0]),$(e[1]),$(e[2]),t)}(e.color,e.opacity)),s=e.emissiveFactor?new c((a=e.emissiveFactor,f($(a[0]),$(a[1]),$(a[2])))):null;var a;return new h({color:n,colorTexture:r(o(e.textureColor,(e=>t.get(e)))),normalTexture:r(o(e.textureNormal,(e=>t.get(e)))),emissiveColor:s,emissiveTexture:r(o(e.textureEmissive,(e=>t.get(e)))),occlusionTexture:r(o(e.textureOcclusion,(e=>t.get(e)))),alphaMode:P(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r(o(e.textureMetallicRoughness,(e=>t.get(e))))})}(e,y))));const A=function(e){let t=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1};for(const{attributes:{position:o,normal:n,color:s,tangent:a,texCoord0:i}}of e.parts)t+=o.count,n&&(r.normal=!0),s&&(r.color=!0),a&&(r.tangent=!0),i&&(r.texCoord0=!0);return{writeIndex:0,vertexAttributes:{position:E(n,t),normal:r.normal?E(s,t):null,tangent:r.tangent?E(a,t):null,color:r.color?E(i,t):null,texCoord0:r.texCoord0?E(l,t):null},components:[]}}(b);for(const e of b.parts)H(A,e,C);const{position:j,normal:M,tangent:T,color:B,texCoord0:L}=A.vertexAttributes,R={position:j.typedBuffer,normal:t(M)?M.typedBuffer:null,tangent:t(T)?T.typedBuffer:null,uv:t(L)?L.typedBuffer:null,color:t(B)?B.typedBuffer:null},S=_(R,m,d);return{transform:S.transform,components:A.components,spatialReference:m.spatialReference,vertexAttributes:new w({position:S.vertexAttributes.position,normal:S.vertexAttributes.normal,tangent:S.vertexAttributes.tangent,color:R.color,uv:R.uv})}}function H(e,r,o){const{position:n,normal:l,tangent:c,color:u,texCoord0:f}=e.vertexAttributes,v=e.writeIndex,h=r.attributes.position.count;if(C(n.slice(v,h),r.attributes.position,r.transform),t(r.attributes.normal)&&t(l)){const e=m(p(),r.transform);A(l.slice(v,h),r.attributes.normal,e)}else t(l)&&j(l,0,0,1,{dstIndex:v,count:h});if(t(r.attributes.tangent)&&t(c)){const e=m(p(),r.transform);R(c.slice(v,h),r.attributes.tangent,e)}else t(c)&&S(c,0,0,1,1,{dstIndex:v,count:h});if(t(r.attributes.texCoord0)&&t(f)?O(f.slice(v,h),r.attributes.texCoord0):t(f)&&k(f,0,0,{dstIndex:v,count:h}),t(r.attributes.color)&&t(u)){const e=r.attributes.color,t=u.slice(v,h);if(4===e.elementCount)e instanceof a?D(t,e,255):e instanceof i?N(t,e):e instanceof d&&q(t,e,8);else{S(t,255,255,255,255);const r=x.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof s?M(r,e,255):e instanceof x?T(r,e):e instanceof g&&B(r,e,8)}}else t(u)&&S(u.slice(v,h),255,255,255,255);const w=function(e,t){switch(t){case 4:return V(e,b);case 5:return K(e);case 6:return G(e)}}(r.indices||h,r.primitiveType);if(v)for(let t=0;t<w.length;t++)w[t]+=v;e.components.push(new y({faces:w,material:o.get(r.material).clone(),trustSourceNormals:!0})),e.writeIndex+=h}function P(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Q(e){return{horizontal:U(e.s),vertical:U(e.t)}}function U(e){switch(e){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function $(e){return e**(1/L)*255}export{z as loadGLTFMesh};
