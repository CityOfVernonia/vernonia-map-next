var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,n=(t,i,a)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[i]=a,o=(e,t)=>{for(var i in t||(t={}))s.call(t,i)&&n(e,i,t[i]);if(a)for(var i of a(t))r.call(t,i)&&n(e,i,t[i]);return e},l=(e,a)=>t(e,i(a));import{J as h,eU as c,eV as p,eW as d,cE as u,a6 as g,y as m,n as v,p as f,ab as y,bh as _,eX as M,eY as b,bu as w,dZ as S,eZ as x,e_ as E,e$ as O,f0 as D,f1 as G,bY as A,am as R,f2 as P,f3 as T,b_ as C,f4 as z,f5 as I,f6 as H,f7 as V,f8 as L,f9 as F,fa as k,fb as j,bX as B,fc as U,fd as W,fe as q,ff as Z,fg as N,fh as Y,fi as X,fj as Q,fk as K,fl as J,fm as $,fn as ee,fo as te,fp as ie,fq as ae,fr as se,fs as re,ft as ne,fu as oe,fv as le,fw as he,fx as ce,fy as pe,fz as de,fA as ue,fB as ge,fC as me,fD as ve,fE as fe,fF as ye,fG as _e,fH as Me,fI as be,fJ as we,fK as Se,fL as xe,fM as Ee,fN as Oe,fO as De,fP as Ge,fQ as Ae,bT as Re,fR as Pe,by as Te,o as Ce,fS as ze,fT as Ie,fU as He,fV as Ve,fW as Le,fX as Fe,E as ke,bF as je,fY as Be,fZ as Ue,f_ as We,c9 as qe,f$ as Ze,g0 as Ne,g1 as Ye,z as Xe,g2 as Qe,c1 as Ke,g3 as Je,g4 as $e,g5 as et,g6 as tt,g7 as it,g8 as at,g9 as st,ga as rt,gb as nt,gc as ot,gd as lt,ge as ht,gf as ct,gg as pt,gh as dt,gi as ut,gj as gt,gk as mt,gl as vt,gm as ft,gn as yt,go as _t,gp as Mt,gq as bt,gr as wt,cR as St,gs as xt,gt as Et,gu as Ot,gv as Dt,gw as Gt,gx as At,gy as Rt,gz as Pt,gA as Tt,gB as Ct,gC as zt,gD as It,gE as Ht,gF as Vt,gG as Lt,gH as Ft,gI as kt,gJ as jt,gK as Bt,gL as Ut,gM as Wt,gN as qt,gO as Zt,gP as Nt,gQ as Yt,gR as Xt,gS as Qt,gT as Kt,gU as Jt,bZ as $t,gV as ei,gW as ti,gX as ii,gY as ai,gZ as si,cc as ri,g_ as ni,g$ as oi,h0 as li,h1 as hi,h2 as ci,h3 as pi,h4 as di,c2 as ui,h5 as gi,h6 as mi,h7 as vi,h8 as fi,h9 as yi,ha as _i,bP as Mi,b9 as bi,hb as wi,L as Si,hc as xi,hd as Ei,aF as Oi,he as Di,hf as Gi,hg as Ai,hh as Ri,hi as Pi,hj as Ti,hk as Ci,hl as zi,hm as Ii,hn as Hi,ho as Vi,hp as Li,hq as Fi,hr as ki,hs as ji,B as Bi,ht as Ui,hu as Wi,hv as qi,bD as Zi,hw as Ni,hx as Yi,hy as Xi,hz as Qi,hA as Ki,hB as Ji,hC as $i,hD as ea,hE as ta,hF as ia,hG as aa,hH as sa,hI as ra,hJ as na,hK as oa,hL as la,hM as ha,hN as ca,hO as pa,hP as da,hQ as ua,hR as ga,a8 as ma,ai as va,hS as fa,hT as ya,aq as _a,hU as Ma,hV as ba,hW as wa,hX as Sa,hY as xa,hZ as Ea,dw as Oa,c4 as Da,dx as Ga,bi as Aa,h_ as Ra,h$ as Pa,i0 as Ta,i1 as Ca,i2 as za,dy as Ia,i3 as Ha,i4 as Va,i5 as La,i6 as Fa,i7 as ka,ef as ja,i8 as Ba,bA as Ua}from"./vendor.9770a310.js";import{e as Wa,z as qa,l as Za,b as Na,g as Ya,h as Xa,J as Qa,H as Ka}from"./NativeLineMaterial.099d45a3.js";import{createSquare as Ja,createRectangle as $a,createCircle as es,createEllipse as ts,createPolygon as is,createPolyline as as}from"./createUtils.6ccf0d5b.js";import"./verticalOffsetUtils.af9dc1e7.js";import{v as ss}from"./GraphicManipulator.8aa8a59e.js";import{v as rs,l as ns}from"./axisAngleDegrees.427db55f.js";import{K as os,G as ls,D as hs}from"./boundedPlane.a89fa710.js";import"./earcut.b5c0cad1.js";import{g as cs}from"./persistable.1595c0fc.js";const ps={main:new h([255,127,0]),selected:new h([255,255,255]),staged:new h([12,207,255]),outline:new h([0,0,0,.5]),selectedOutline:new h([255,255,255])};function ds(e,t){const i=e.clone();return i.a*=t,i}function us(e,t){const i=e.clone(),a=p(i);a.s*=t;const s=d(a);return i.r=s.r,i.g=s.g,i.b=s.b,i}function gs(e,t){if(t)for(const i in t)e[i]=t[i]}class ms{constructor(e){this.color=ps.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=16,gs(this,e)}}class vs{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=ps.main,this.outlineColor=ps.outline,this.renderOccluded=16,this.hoverOutlineColor=ps.selectedOutline,gs(this,e)}apply(e,t){const i=this[e];t.setParameterValues({color:Os(i),transparent:"color"!==e||i.a<1,renderOccluded:this.renderOccluded})}}class fs{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=ds(ps.main,.5),this.hoverColor=ps.main,this.renderOccluded=2,this.minSquaredEdgeLength=900,gs(this,e)}apply(e,t){const i=this[e];t.setParameterValues({color:Os(i),transparent:i.a<1,renderOccluded:this.renderOccluded})}}class ys{constructor(e){this.vertex=new vs({color:ps.main,outlineColor:ps.outline}),this.edge=new vs({color:us(ds(ps.main,2/3),.5),outlineColor:ds(ps.outline,.5),size:8,collisionPadding:8}),this.selected=new vs({color:ps.selected,outlineColor:ps.outline}),this.edgeOffset=new fs,gs(this,e)}}class _s{constructor(e){this.color=ps.selected,this.width=1.5,this.stipplePattern=Wa([5,5]),this.stippleOffColor=ps.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=ps.selected,this.renderOccluded=4,gs(this,e)}apply(e){e.color=Os(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=Os(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=Os(this.innerColor),e.renderOccluded=this.renderOccluded}}class Ms{constructor(e){this.color=ps.selected,this.size=4,this.outlineSize=1,this.outlineColor=ps.outline,this.shape="square",gs(this,e)}apply(e){e.color=Os(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=Os(this.outlineColor),e.primitive=this.shape}}class bs{constructor(e){this.innerColor=ps.selected,this.innerWidth=1,this.glowColor=ps.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.3,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=ps.main,gs(this,e)}apply(e,t=1){const i={glowColor:h.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:h.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*t,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=i:e.laserlineStyle=i}}class ws{constructor(e){this.outline=new _s({color:ps.outline,renderOccluded:8,stippleOffColor:ps.selected,stipplePattern:Wa([5,5]),width:1.5,innerWidth:0}),this.staged=new _s({color:ps.selected,renderOccluded:8,innerColor:ps.staged,stippleOffColor:ps.outline,stipplePattern:Wa([5,5]),width:1.5}),this.shadowStyle=new bs({globalAlpha:.3,glowColor:ps.main,glowFalloff:8,glowWidth:8,innerColor:ps.selected,innerWidth:1}),gs(this,e)}}class Ss{constructor(e){this.outline=new Ms({color:ps.selected,outlineColor:ps.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new bs({globalAlpha:.3,glowColor:ps.main,glowFalloff:1.5,glowWidth:6,innerColor:ps.selected,innerWidth:1,radius:2}),gs(this,e)}}class xs extends _s{constructor(e){super(),this.extensionType=2,gs(this,e)}}class Es{constructor(e){this.lineGraphics=new ws,this.pointGraphics=new Ss,this.heightPlane=new bs({globalAlpha:.3,glowColor:ps.main,glowFalloff:8,glowWidth:8,innerColor:ps.selected,innerWidth:1}),this.heightBox=new bs({globalAlpha:.3,glowColor:ps.main,glowFalloff:8,glowWidth:8,innerColor:ps.selected,innerWidth:0,heightFillColor:ps.main}),this.zVerticalLine=new xs({color:ds(ps.main,.5),falloff:2,innerColor:ds(ps.selected,0),renderOccluded:4,stipplePattern:null,width:5,extensionType:2}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,gs(this,e)}}function Os(e){return c(h.toUnitRGBA(e))}const Ds=new class{constructor(e){this.visualElements=new Es,this.reshapeManipulators=new ys,this.zManipulator=new ms,gs(this,e)}colorToVec4(e){return Os(e)}};class Gs{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return y(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?_(this._resources)||(this.ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?_(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var e;this._destroyResources();const t=this.resourceFactory.createResources();this._resources={layerView:new As({view:this.resourceFactory.view}),external:t,geometriesAdded:!1},this._syncGeometriesToRenderer();const i=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;i&&i.registerDrapeSource(this._resources.layerView)}_destroyResources(){var e;if(_(this._resources))return;this.ensureRenderGeometriesRemoved();const t=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;t&&t.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this.ensureRenderGeometriesAdded():this.ensureRenderGeometriesRemoved()}ensureRenderGeometriesRemoved(){var e;!_(this._resources)&&null!=(e=this.resourceFactory.view)&&e.basemapTerrain&&this._resources.geometriesAdded&&(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.removeGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!1)}ensureRenderGeometriesAdded(){_(this._resources)||this._resources.geometriesAdded||(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.addGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!0)}}let As=class extends(u(f)){constructor(e){super(e),this.drapeSourceType=1,this.updatePolicy=1}};g([m({constructOnly:!0})],As.prototype,"view",void 0),g([m({readOnly:!0})],As.prototype,"drapeSourceType",void 0),As=g([v("DrapedVisualElementLayerView")],As);class Rs{constructor(e){this.view=null,this._attachmentOrigin=b(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new w,this._isDraped=!1,this._geometry=null,this._width=1,this._color=S(1,0,1,1),this._innerWidth=0,this._innerColor=S(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=8,this.resources=new x({view:e.view,createResources:e=>this.createResources(e),recreateGeometry:(e,t)=>(e.geometries.length=0,this.recreateGeometry(t,e.material,e.geometries),e.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new Gs({view:e.view,createResources:()=>this.createDrapedResources(),recreateGeometry:e=>{e.geometries=this.createRenderGeometriesDraped(e.material),this.attachmentOriginChanged()}});let t=!0;this._laserline=new E({view:e.view});for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&y(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(e){this.updateAttached(e)}updateAttached(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this.attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get color(){return this._color}set color(e){O(e,this._color)||(D(this._color,e),this.updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){O(e,this._innerColor)||(D(this._innerColor,e),this.updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=y(e)!==y(this._stipplePattern);this._stipplePattern=e,t?this.resources.recreate():this.updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&O(e,this._stippleOffColor)||(this._stippleOffColor=e?G(e):null,this.updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,y(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=y(this.resources.resources)?this.resources.resources.geometries:null;if(!e||0===e.length)return null;A(Cs,0,0,0);let t=0;for(const i of e){const e=i.vertexAttributes.get("position"),a=i.indices.get("position"),s=R(this.resources.resources).material.isClosed(e.data,a);P(e,a,s,Ts)&&(T(Cs,Cs,Ts),t++)}return 0===t?null:(C(Cs,Cs,1/t),this.view.renderCoordsHelper.fromRenderCoords(Cs,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}updateMaterial(){y(this.resources.resources)&&this.resources.resources.material.setParameterValues(this.materialParameters),y(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameterValues(this.materialParameters)}get isClosed(){return y(this.geometry)&&"polygon"===this.geometry.type}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",stippleIntegerRepeats:!0,polygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&8===this._renderOccluded?4:this._renderOccluded}recreateGeometry(e,t,i){const a=this.createRenderGeometries();for(const s of a)e.addGeometry(s,t),i.push(s);this.attachmentOriginChanged()}attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}createResources(e){const t=new z(this.materialParameters),i=[];return this.recreateGeometry(e,t,i),{material:t,geometries:i,forEach:e=>{e(t),i.forEach(e)}}}createDrapedResources(){const e=new z(this.materialParameters);return{material:e,geometries:this.createRenderGeometriesDraped(e)}}createRenderGeometriesDraped(e){const t=this.geometry;if(_(t))return[];const i=qa(t,this.view.basemapTerrain.spatialReference),a=[];for(const{position:s}of i.lines){const t={attributeData:{position:s},removeDuplicateStartEnd:this.isClosed?1:0},i=new Za(Na(t),e),r=I(Ps);H(r,s),V(i.boundingSphere,.5*(r[0]+r[3]),.5*(r[1]+r[4]),0,.5*Math.sqrt((r[3]-r[0])*(r[3]-r[0])+(r[4]-r[1])*(r[4]-r[1]))),a.push(i)}return a}calculateMapBounds(e){if(_(this.resources.resources))return!1;const t=this.view.renderCoordsHelper;for(const i of this.resources.resources.geometries){const a=i.vertexAttributes.get("position"),s=new Float64Array(a.data.length);L(a.data,t.spatialReference,0,s,this.view.spatialReference,0,a.data.length/3),H(e,s)}return!0}createRenderGeometries(){var e;const t=this.geometry;if(_(t))return[];const i=Ya(t,this.view.elevationProvider,this.view.renderCoordsHelper,F.fromElevationInfo(null!=(e=this.elevationInfo)?e:new k({mode:j(t,null)}))),a=[],s=[];for(const{position:r,mapPosition:n}of i.lines){const e={attributeData:{position:r,mapPosition:n},removeDuplicateStartEnd:this.isClosed?1:0};a.push(Na(e)),s.push(r)}return this._laserline.pathVerticalPlane=s,a}}const Ps=M(),Ts=B(),Cs=B();function zs(e){e.vertex.uniforms.add("camPos","vec3").add("perScreenPixelRatio","float").add("screenSize","float"),e.vertex.code.add(U`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - camPos));
return viewDirectionDistance*perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSize * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function Is(e){const t=new W;return t.include(q,{linearDepth:!1}),t.include(zs,{}),t.include(Z,e),t.fragment.include(N),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.fragment.uniforms.add("color","vec4"),t.attributes.add("position","vec3"),t.varyings.add("vWorldPosition","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),e.screenSizeEnabled&&t.attributes.add("offset","vec3"),e.shadingEnabled&&(t.vertex.uniforms.add("viewNormal","mat4"),t.fragment.uniforms.add("shadedColor","vec4").add("shadingDirection","vec3"),t.attributes.add("normal","vec3"),t.varyings.add("vViewNormal","vec3")),t.vertex.code.add(U`
    void main(void) {
      vWorldPosition = ${e.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),e.shadingEnabled&&t.vertex.code.add(U`vec3 worldNormal = normal;
vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`),t.vertex.code.add(U`
    ${e.multipassTerrainEnabled?"depth = (view * vec4(vWorldPosition, 1.0)).z;":""}
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),e.multipassTerrainEnabled&&(t.fragment.include(Y),t.include(X,e)),t.fragment.code.add(U`
    void main() {
      discardBySlice(vWorldPosition);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    `),e.shadingEnabled?t.fragment.code.add(U`vec3 viewNormalNorm = normalize(vViewNormal);
float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
vec4 finalColor = mix(color, shadedColor, shadingFactor);`):t.fragment.code.add(U`vec4 finalColor = color;`),t.fragment.code.add(U`
      if (finalColor.a < ${U.float(Q)}) {
        discard;
      }
      ${7===e.output?U`gl_FragColor = vec4(finalColor.a);`:""}

      ${0===e.output?U`gl_FragColor = highlightSlice(finalColor, vWorldPosition); ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    }
    `),t}var Hs=Object.freeze({__proto__:null,build:Is});class Vs extends ${initializeProgram(e){const t=Vs.shader.get(),i=this.configuration,a=t.build({output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,screenSizeEnabled:i.screenSizeEnabled,shadingEnabled:i.shadingEnabled,OITEnabled:0===i.transparencyPassType,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new ee(e.rctx,a,Fs)}bindPass(e,t){const{screenSizeEnabled:i,shadingEnabled:a}=this.configuration,{color:s,shadingTint:r,shadingDirection:n}=e;te(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("color",s),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),ie(this.program,t)),a&&(this.program.setUniform4fv("shadedColor",this.blendColor(ks,r,s)),this.program.setUniform3fv("shadingDirection",n),this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix)),i&&function(e,t,i){e.setUniform1f("perScreenPixelRatio",i.camera.perScreenPixelRatio),e.setUniform1f("screenSize",t.screenSize)}(this.program,e,t)}bindDraw(e){ae(this.program,e),se(this.program,e.origin,e.camera.viewInverseTransposeMatrix),re(this.program,this.configuration,e),this.program.rebindTextures()}blendColor(e,t,i){const a=1-t[3],s=t[3]+i[3]*a;return 0===s?(e[3]=s,e):(e[0]=(t[0]*t[3]+i[0]*i[3]*a)/s,e[1]=(t[1]*t[3]+i[1]*i[3]*a)/s,e[2]=(t[2]*t[3]+i[2]*i[3]*a)/s,e[3]=i[3],e)}setPipelineState(e){const t=this.configuration,i=3===e,a=2===e;return ne({blending:0!==t.output&&7!==t.output||!t.transparent?null:i?oe:le(e),culling:he(t.cullFace),depthTest:{func:a?513:t.shadingEnabled?515:513},depthWrite:i?t.writeDepth&&ce:pe(e),colorWrite:de,polygonOffset:i||a?null:ue})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Vs.shader=new ge(Hs,(()=>import("./ShadedColorMaterial.glsl.27e7274b.js")));class Ls extends J{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}g([K({count:8})],Ls.prototype,"output",void 0),g([K({count:3})],Ls.prototype,"cullFace",void 0),g([K()],Ls.prototype,"slicePlaneEnabled",void 0),g([K()],Ls.prototype,"transparent",void 0),g([K()],Ls.prototype,"writeDepth",void 0),g([K()],Ls.prototype,"screenSizeEnabled",void 0),g([K()],Ls.prototype,"shadingEnabled",void 0),g([K({count:4})],Ls.prototype,"transparencyPassType",void 0),g([K()],Ls.prototype,"multipassTerrainEnabled",void 0),g([K()],Ls.prototype,"cullAboveGround",void 0);const Fs=new Map([["position",0],["normal",1],["offset",2]]),ks=me();class js extends ye{constructor(e){super(e,Us),this.supportsEdges=!0,this.techniqueConfig=new Ls,this._vertexAttributeLocations=Fs}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.screenSizeEnabled=this.params.screenSizeEnabled,this.techniqueConfig.shadingEnabled=this.params.shadingEnabled,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,a,s,r,n){if(this.params.screenSizeEnabled){const i=e.vertexAttributes.get("offset"),o={applyToVertex:(e,t,s,r)=>{const n=A(qs,i.data[3*r+0],i.data[3*r+1],i.data[3*r+2]),o=A(Zs,e,t,s);return C(n,n,this.params.screenSize*a.camera.computeRenderPixelSizeAt(n)),T(o,o,n),[o[0],o[1],o[2]]},applyToAabb:e=>{const t=Oe(e,qs);return De(e,this.params.screenSize*a.camera.computeRenderPixelSizeAt(t))}};_e(e,t,a,s,r,o,n)}else _e(e,t,a,s,r,void 0,n)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output?new Bs(e):void 0}createBufferWriter(){return new Ws(this.params.screenSizeEnabled)}}class Bs extends Me{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(Vs,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){if(4===this._output)return 3===e;let t=3;return this._technique.configuration.transparent&&(t=this._technique.configuration.writeDepth?5:8),e===t}ensureParameters(e){this.updateParameters(e)}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}}const Us=o({color:[1,1,1,1],shadingTint:[0,0,0,.25],shadingDirection:ve(B(),[.5,-.5,-.5]),transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:0,screenSizeEnabled:!1,screenSize:14,shadingEnabled:!0},fe);class Ws{constructor(e){this.screenSizeEnabled=e;const t=be().vec3f("position").vec3f("normal");this.screenSizeEnabled&&t.vec3f("offset"),this.vertexBufferLayout=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,a){if(we(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,a),this.screenSizeEnabled){if(!t.vertexAttributes.has("offset"))throw new Error("offset vertex attribute required for screenSizeEnabled ShadedColorMaterial");{const s=t.vertexAttributes.get("offset"),r=t.indices.get("offset");Se(3===s.size);const n=i.getField("offset",xe);if(!n)throw new Error("unable to acquire view for offset");Ee(r,s.data,e.invTranspTransformation,n,a)}}}}const qs=B(),Zs=B();class Ns extends Ge{constructor(e){super(e),this.view=null,this._renderOccluded=4,this._vertices=null,this._spatialReference=null,this._color=Ds.colorToVec4(Ds.reshapeManipulators.vertex.color),this._size=Ds.reshapeManipulators.vertex.size,this._outlineColor=Ds.colorToVec4(Ds.reshapeManipulators.vertex.outlineColor),this._outlineSize=Ds.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial(),this.updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){O(e,this._color)||(D(this._color,e),this.updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){O(e,this._outlineColor)||(D(this._outlineColor,e),this.updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}updateMaterial(){this.attached&&this.vertexMaterial.setParameterValues(this.vertexMaterialParameters)}updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameterValues(this.vertexOutlineMaterialParameters)}createRenderGeometries(){const e=this.vertices;if(_(e)||0===e.length)return[];const t=Xa(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,F.fromElevationInfo(this.elevationInfo)),i=[],a=t.numVertices,s=t.position;for(let r=0;r<a;++r){const e=A(Ys,s[3*r+0],s[3*r+1],s[3*r+2]),t=Xs(.5,e),a=Xs(.5,e);i.push({vertexGeometry:t,vertexOutlineGeometry:a})}return i}createGeometries(e){const t=this.createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:a}of t)e.addGeometry(i,this.vertexMaterial),e.addGeometry(a,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new js(l(o({},this.vertexMaterialParameters),{writeDepth:!0,cullFace:2,screenSizeEnabled:!0})),this.vertexOutlineMaterial=new js(l(o({},this.vertexOutlineMaterialParameters),{transparent:!0,writeDepth:!0,cullFace:1,screenSizeEnabled:!0,shadingEnabled:!1}))}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const Ys=B();function Xs(e,t){return Ae.createSphereGeometry(e,16,16,{offset:t})}let Qs=class extends w.EventedAccessor{constructor(e){super(e),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};g([m({constructOnly:!0})],Qs.prototype,"graphic",void 0),g([m()],Qs.prototype,"tracking",void 0),g([m()],Qs.prototype,"displaying",void 0),g([m()],Qs.prototype,"isDraped",void 0),Qs=g([v("esri.views.3d.layers.graphics.GraphicState")],Qs);let Ks=class extends(Re(w.EventedMixin(Pe))){constructor(e){super(e),this.drawOperation=null,this._createGraphic=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._activeVertexVisualElement=null,this.hasZ=!0,this.defaultZ=0,this.elevationInfo=null,this.snapToScene=!1,this.snappingManager=null,this.mode=null,this.geometryType=null,this.type="draw-3d"}get updating(){var e,t;return null!=(e=null==(t=this.drawOperation)?void 0:t.updating)&&e}initialize(){const e=Te(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this._internalGraphicsLayer=new Ce({elevationInfo:e,listMode:"hide",internal:!0}),this.view.map.layers.add(this._internalGraphicsLayer),this.drawOperation=new ze({view:this.view,manipulators:this.manipulators,geometryType:Js(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,sceneDrawSurface:new Ie(this.view,e,[this._internalGraphicsLayer]),elevationDrawSurface:new He(e,this.defaultZ,this.view,this._internalGraphicsLayer),hasM:!1,elevationInfo:e,snappingManager:this.snappingManager}),this.drawOperation.on("vertex-add",(e=>this.onVertexAdd(e))),this.drawOperation.on("vertex-remove",(e=>this.onVertexRemove(e))),this.drawOperation.on("vertex-update",(e=>this.onVertexUpdate(e))),this.drawOperation.on("cursor-update",(e=>this.onCursorUpdate(e))),this.drawOperation.on("complete",(e=>this.onComplete(e))),this.complete()}destroy(){this.drawOperation.destroy(),this.drawOperation=null,this._destroyAllVisualisations(),this.view.map.remove(this._internalGraphicsLayer),this._set("view",null)}onInputEvent(e){this.drawOperation.onInputEvent(e)}_getCreateGeometry(e={operationComplete:!1}){if(null==this.drawOperation||0===this.drawOperation.numVertices)return null;const t=this.drawOperation.stagedVertex,i=this.drawOperation.committedVertices,a=i.slice();y(t)&&a.push(this.drawOperation.coordinateHelper.pointToArray(t));const s=y(t)?this.drawOperation.coordinateHelper.pointToArray(t):i.splice(-1)[0],r={regularVertices:null,activeVertex:null,full:null,outline:null},n=a.length,o=this.drawOperation.spatialReference,l="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":r.regularVertices=i,r.activeVertex=s,r.full=this.drawOperation.coordinateHelper.createPointFromArray(a[0]);break;case"polyline":r.regularVertices=i,r.activeVertex=s,n>0&&(r.full=as([a],o,l));break;case"polygon":r.regularVertices=i,r.activeVertex=s,n>0&&(r.full=is([a],o,l,!0));break;case"circle":if(n>0){const t=Ve(this.view,a[0]);if(1===n&&e.operationComplete){const e=a[0],i=t.makeMapPoint(e[0]+$s*this.view.resolution,e[1]);r.full=es([e,i],t,!0)}else 2===n&&(r.full=this.forceUniformSize?es(a,t,this.centered):ts(a,t,this.centered))}break;case"rectangle":if(n>0){const t=Ve(this.view,a[0]);if(1===n&&e.operationComplete){const e=a[0],i=t.makeMapPoint(e[0]+$s*this.view.resolution,e[1]);r.full=Ja([e,i],t,!0)}else 2===n&&(r.full=this.forceUniformSize?Ja(a,t,this.centered):$a(a,t,this.centered))}break;default:return null}switch(this.geometryType){case"point":break;case"polyline":case"polygon":n>1&&(r.outline=as([a],o,l));break;case"circle":case"rectangle":y(r.full)&&"polygon"===r.full.type&&(r.outline=is(r.full.rings,o,l))}return r}_destroyAllVisualisations(){this._destroyCreateGraphic(),this._destroyOutlineVisualElement(),this._destroyVerticesVisualElement(),this._destroyStagedVerticesVisualElement()}_destroyCreateGraphic(){y(this._createGraphic)&&(this._internalGraphicsLayer.remove(this._createGraphic),this._createGraphic=Le(this._createGraphic)),this._createGraphicState=null,this.handles.remove(er)}_destroyOutlineVisualElement(){this._outlineVisualElement=Le(this._outlineVisualElement)}_destroyVerticesVisualElement(){this._verticesVisualElement=Le(this._verticesVisualElement)}_destroyStagedVerticesVisualElement(){this._activeVertexVisualElement=Le(this._activeVertexVisualElement)}_updateCreateGraphic(){const e=this._getCreateGeometry();if(_(e))return void this._destroyAllVisualisations();const t=this._internalGraphicsLayer.elevationInfo;y(e.outline)?_(this._outlineVisualElement)?(this._outlineVisualElement=new Rs({view:this.view,geometry:e.outline,elevationInfo:t,isDraped:y(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===Fe(this.hasZ,t),attached:!1}),Ds.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),Ds.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0):this._outlineVisualElement.geometry=e.outline:this._destroyOutlineVisualElement(),y(e.regularVertices)?_(this._verticesVisualElement)?(this._verticesVisualElement=new Ns({view:this.view,spatialReference:this.view.spatialReference,vertices:e.regularVertices,elevationInfo:t,renderOccluded:Ds.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0):this._verticesVisualElement.vertices=e.regularVertices:this._destroyVerticesVisualElement(),y(e.activeVertex)?_(this._activeVertexVisualElement)?(this._activeVertexVisualElement=new Ns({view:this.view,spatialReference:this.view.spatialReference,vertices:[e.activeVertex],elevationInfo:t,renderOccluded:Ds.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=Ds.colorToVec4(Ds.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0):this._activeVertexVisualElement.vertices=[e.activeVertex]:this._destroyStagedVerticesVisualElement(),y(e.full)?_(this._createGraphic)?(this._createGraphic=new ke(o({geometry:e.full,symbol:this.createGraphicSymbol,sourceLayer:this._internalGraphicsLayer},this.graphicProperties)),this._internalGraphicsLayer.add(this._createGraphic),this.view.maskOccludee(this._createGraphic),this._createGraphicState=new Qs({graphic:this._createGraphic}),this.handles.add([this.view.trackGraphicState(this._createGraphicState),je(this._createGraphicState,"isDraped",(e=>{y(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=e)}))],er),this.notifyChange("createGraphic")):this._createGraphic.geometry=e.full:this._destroyCreateGraphic()}get createGraphic(){return this._createGraphic}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set centered(e){this._set("centered",e),this._updateCreateGraphic()}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateCreateGraphic()}reset(){}get canRedo(){return this.drawOperation.canRedo}redo(){this.drawOperation.redo()}get canUndo(){return this.drawOperation.canUndo}undo(){this.drawOperation.undo()}completeCreateOperation(){this.drawOperation.complete()}activate(){}deactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.vertices}onVertexAdd(e){this._updateCreateGraphic(),this.emit("vertex-add",e)}onVertexRemove(e){this._updateCreateGraphic(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateCreateGraphic(),this.emit("vertex-update",e)}onCursorUpdate(e){this._updateCreateGraphic(),this.emit("cursor-update",e)}onComplete(e){this._updateCreateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateGeometry({operationComplete:!0});y(e)&&(t=new ke(o({geometry:e.full,symbol:this.createGraphicSymbol,sourceLayer:this._internalGraphicsLayer},this.graphicProperties)))}this.emit("complete",o({graphic:t},e))}};function Js(e){switch(e){case"point":case"polyline":case"polygon":return e;case"circle":case"rectangle":return"segment";default:return null}}g([m()],Ks.prototype,"drawOperation",void 0),g([m({readOnly:!0})],Ks.prototype,"updating",null),g([m({constructOnly:!0,nonNullable:!0})],Ks.prototype,"view",void 0),g([m()],Ks.prototype,"createGraphicSymbol",void 0),g([m()],Ks.prototype,"createGraphic",null),g([m({value:!0})],Ks.prototype,"enabled",null),g([m({value:!0})],Ks.prototype,"centered",null),g([m({value:!0})],Ks.prototype,"forceUniformSize",null),g([m({constructOnly:!0})],Ks.prototype,"graphicProperties",void 0),g([m({constructOnly:!0})],Ks.prototype,"hasZ",void 0),g([m({nonNullable:!0})],Ks.prototype,"defaultZ",void 0),g([m({constructOnly:!0})],Ks.prototype,"elevationInfo",void 0),g([m()],Ks.prototype,"snapToScene",void 0),g([m()],Ks.prototype,"snappingManager",void 0),g([m({constructOnly:!0})],Ks.prototype,"mode",void 0),g([m({constructOnly:!0})],Ks.prototype,"geometryType",void 0),g([m({readOnly:!0})],Ks.prototype,"type",void 0),Ks=g([v("esri.views.3d.interactive.editingTools.draw3D.DrawTool")],Ks);const $s=48,er="create-graphic";function tr(e,t,i=We()){return function(e,t,i=We()){const a=Be(qe(Ue.get(),t));if(a[2]=0,!e.unprojectFromRenderScreen(a,i.origin))return null;const s=Be(qe(Ue.get(),t));s[2]=1;const r=e.unprojectFromRenderScreen(s,Ue.get());return _(r)?null:(Ze(i.direction,r,i.origin),i)}(e,e.screenToRender(t,Be(Ue.get())),i)}class ir{constructor(e){this.idHint=0,this.camera=new Qa,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=Qe(),this._worldFrame=null,this._renderLocation=B(),this._renderLocationDirty=!0,this._location=new Xe({x:0,y:0,z:0}),this._elevationAlignedLocation=new Xe,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=0,this._focused=!1,this.events=new w.EventEmitter,this._screenLocation={screenPointArray:Ke(),renderScreenPointArray:Je(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayer=null,this._materialIdReferences=null,this._location.spatialReference=e.view.spatialReference;for(const t in e)this[t]=e[t];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}destroy(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),{remove:$e((()=>{this._noDisplayCount--,0===this._noDisplayCount&&this._updateEngineObject()}))}}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){ar(e)&&(this._screenLocationDirty=!0),et(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=Qe()),function(e,t,i){switch(e.viewingMode){case"local":return At(i),!0;case"global":{const a=Et(e.renderCoordsHelper.spatialReference);Ot(t,0,pr,0,a.radius),Dt(Gt(pr[1]),Gt(pr[0]),i)}}}(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){tt(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){tt(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;const e=y(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:!0===e?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this.ensureScreenLocation(),this._screenLocation}ensureScreenLocation(){if(!this._screenLocationDirty)return;let e;if(this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1,ar(this._modelTransform)){const t=this._calculateModelTransformOffset(vr);e=T(t,t,this.renderLocation)}else e=this.renderLocation;this.camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}intersectionDistance(e,t){if(!this.available)return null;const i=it(e,sr),a=this._getCollisionRadius(t),s=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(vt(this.screenLocation.screenPointArray,i)<a*a)return this.screenLocation.renderScreenPointArray[2]+s;break;case"line":{const e=this.collisionType.paths,t=this._getWorldToScreenObjectScale(),r=this._calculateObjectTransform(t,hr),n=a*this.screenLocation.pixelSize,o=tr(this.camera,i,nr);if(_(o))return null;for(const i of e){if(0===i.length)continue;const e=lt(pr,i[0],r);for(let t=1;t<i.length;t++){const a=lt(dr,i[t],r),l=mt(ct(e,a,rr),o);if(null!=l&&l<n*n){const t=T(Ue.get(),e,a);C(t,t,.5);const i=pt(Ue.get());return this.camera.projectToRenderScreen(t,i),i[2]+s}dt(e,a)}}break}case"disc":{var r;const e=this.collisionType.direction,t=null!=(r=this.collisionType.offset)?r:ut,n=this._getWorldToScreenObjectScale(),o=this._calculateObjectTransform(n,hr),l=a*this.screenLocation.pixelSize,h=tr(this.camera,i,nr);if(_(h))return null;const c=st(or,o),p=rt(gr,e,c),d=lt(mr,t,o);nt(d,p,cr);const u=ur;if(ot(cr,h,u)&&gt(u,d)<l*l)return this.screenLocation.renderScreenPointArray[2]+s;break}case"ribbon":{const{paths:e,direction:t}=this.collisionType,r=this._getWorldToScreenObjectScale(),n=this._calculateObjectTransform(r,hr),o=a*this.camera.computeScreenPixelSizeAt(this.renderLocation),l=tr(this.camera,i,nr);if(_(l))return null;const h=st(or,n),c=rt(gr,t,h),p=this._calculateModelTransformPosition(mr);nt(p,c,cr);const d=ur;if(!ot(cr,l,d))break;for(const i of e){if(0===i.length)continue;const e=lt(pr,i[0],n);for(let t=1;t<i.length;t++){const a=lt(dr,i[t],n),r=ht(ct(e,a,rr),d);if(null!=r&&r<o*o){const t=T(Ue.get(),e,a);C(t,t,.5);const i=pt(Ue.get());return this.camera.projectToRenderScreen(t,i),i[2]+s}dt(e,a)}}break}default:at(this.collisionType)}return null}attach(e={manipulator3D:{}}){var t;if(!this.view._stage)return;const i=e.manipulator3D;if(_(i.engineLayerId)){const e=new ft({isPickable:!1,updatePolicy:1});this.view._stage.add(e),i.engineLayerId=e.id,this._engineLayer=e}else null!=(t=this.view._stage)&&t.getObject&&(this._engineLayer=this.view._stage.getObject(i.engineLayerId));i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,_(this._materialIdReferences)&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),yt(this._location.spatialReference,this.view.spatialReference)||(this.location=new Xe({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const i=0===t.engineLayerReferences;i&&(t.engineLayerId=null),this._removeResourcesFromStage(i),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){_t(this.location,fr,e.spatialReference),Mt(e.extent,fr)&&(this.location=this._location)}_evaluateElevationAlignment(e=this.location){if(_(this.elevationInfo))return!1;let t=null,i=0;const a=Te(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":t=Te(bt(this.view.elevationProvider,e,"ground"),0);break;case"relative-to-ground":i=Te(bt(this.view.elevationProvider,e,"ground"),0)+a;break;case"relative-to-scene":i=Te(bt(this.view.elevationProvider,e,"scene"),0)+a;break;case"absolute-height":i=a}return(i!==this._elevation.offset||t!==this._elevation.override)&&(this._elevation.offset=i,this._elevation.override=t,!0)}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=hr;if(!0===this.autoScaleRenderObjects){const i=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(i,t)}else this._calculateObjectTransform(e,t);const{objectsByState:i}=this._ensureEngineResources(),a=(this.focused?2:1)|(this.selected?8:4),s=this._noDisplayCount>0;for(const{stateMask:r,objects:n}of i){if(s){for(const e of n)e.setVisible(!1);continue}const e=!(0!=(15&r))||(a&r)==(15&r),i=!(0!=(65520&r))||(this.state&r)==(65520&r);if(e&&i)for(const a of n)a.setVisible(!0),a.transformation=t;else for(const t of n)t.setVisible(!1)}}_ensureEngineResources(){if(_(this._engineResources)){const e=R(this._engineLayer),t=[],i=new Set;this.renderObjects.forEach((({material:e})=>{i.has(e)||(t.push(e),i.add(e))}));const a=(e,t)=>{const{geometry:i,material:a,transform:s}=t;Array.isArray(i)?i.forEach((t=>e.addGeometry(t,a,s))):e.addGeometry(i,a,s)},s=new Map;this._renderObjects.forEach((e=>{const t=new wt({castShadow:!1});a(t,e);const i=e.stateMask||0,r=s.get(i)||[];r.push(t),s.set(i,r)}));const r=[];s.forEach(((e,t)=>r.push({stateMask:t,objects:e}))),this._engineResources={objectsByState:r,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){if(this._engineResourcesAddedToStage||_(this._engineResources))return;const{objectsByState:e,layer:t,materials:i}=this._engineResources;i.forEach((e=>{const t=R(this._materialIdReferences),i=t.get(e.id)||0;0===i&&this.view._stage.add(e),t.set(e.id,i+1)})),e.forEach((({objects:e})=>{t.addMany(e),this.view._stage.addMany(e)})),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(e=!1){if(!this._engineResourcesAddedToStage||_(this._engineResources))return;const{objectsByState:t,layer:i,materials:a}=this._engineResources;t.forEach((({objects:e})=>{i.removeMany(e),this.view._stage.removeMany(e)})),a.forEach((e=>{const t=R(this._materialIdReferences),i=t.get(e.id);1===i?(this.view._stage.remove(e),t.delete(e.id)):t.set(e.id,i-1)})),e&&this.view._stage.remove(i),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,lr);return A(e,i[12],i[13],i[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return Ze(e,t,this.renderLocation)}_calculateObjectTransform(e,t){return St(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&xt(t,t,this._worldFrame),xt(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,y(this._applyObjectTransform)&&this._applyObjectTransform(t),t}get test(){let e=!1;if(y(this._engineResources))for(const t in this._engineResources.objectsByState){const i=this._engineResources.objectsByState[t];for(const t of i.objects)if(t.isVisible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}function ar(e){return 0!==e[12]||0!==e[13]||0!==e[14]}const sr=Ke(),rr=Ne(),nr=We(),or=Rt(),lr=Qe(),hr=Qe(),cr=Ye(),pr=B(),dr=B(),ur=B(),gr=B(),mr=B(),vr=B(),fr=new Xe({x:0,y:0,z:0,spatialReference:null});function yr(e,t=4,i=!0){const a=Tt(e[0],e[1],e[2],e.length>3?e[3]:1),s=e[3]<1;return i?new js({color:a,transparent:s,writeDepth:!0,cullFace:2,renderOccluded:t}):new Pt({color:a,transparent:s,writeDepth:!0,cullFace:2,renderOccluded:t})}function _r(e,t=4){const i=Tt(e[0],e[1],e[2],4===e.length?e[3]:1);return new Pt({color:i,transparent:!0,writeDepth:!0,cullFace:1,renderOccluded:t})}function Mr(e,t,i,a){const s=Ze(Ue.get(),e,i),r=br(s,zt(Ue.get(),a,s),i,Ct.get());It(r,r);const n=lt(Ue.get(),t,r);return Math.atan2(n[1],n[0])}function br(e,t,i,a){const s=ve(Ue.get(),e),r=ve(Ue.get(),t),n=zt(Ue.get(),s,r);return a[0]=s[0],a[1]=s[1],a[2]=s[2],a[3]=0,a[4]=r[0],a[5]=r[1],a[6]=r[2],a[7]=0,a[8]=n[0],a[9]=n[1],a[10]=n[2],a[11]=0,a[12]=i[0],a[13]=i[1],a[14]=i[2],a[15]=1,a}function wr(e,t){const i=e.getViewForGraphic(t);return y(i)&&"computeAttachmentOrigin"in i?i.computeAttachmentOrigin(t,e.spatialReference):null}function Sr(e,t,i){const a=wr(e,i);y(a)?t.elevationAlignedLocation=a:function(e,t){if(_(t))return;const i="mesh"===t.type?t.anchor:Ht(t);_(i)||(e.location=Vt(i))}(t,i.geometry)}function xr(e,t=Lt(e)){return"on-the-ground"!==t.mode&&!(_(e.geometry)||!e.geometry.hasZ)}class Er{constructor(){this.grabbingState=0,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=0,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator(((e,t)=>{if(0===t&&(this.zManipulator=e),e instanceof ir&&(e.selected&&(0===this.numSelected&&(this.firstSelected=e),this.numSelected++),_(this.firstGrabbedXY)&&e.grabbing&&1===t&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=1,t){case 0:this.grabbingState|=2;break;case 1:this.grabbingState|=4}}))}}function Or(e){const{view:t,graphic:i}=e,a=new Qs({graphic:i}),s=function(e,t){const{view:i,graphic:a}=e,s=new Rs({view:i,geometry:Gr(a)?a.geometry:null,elevationInfo:Lt(a),attached:!1});Ds.visualElements.lineGraphics.shadowStyle.apply(s);const r=()=>{s.attached=t.displaying};Ds.visualElements.lineGraphics.outline.apply(s);const n=[t.watch("displaying",r),t.watch("isDraped",(e=>s.isDraped=e)),t.on("changed",(()=>s.geometry=Gr(a)?a.geometry:null)),jt(s)];return r(),{visualElement:s,remove:()=>Ft(n).remove()}}(e,a),r=[s,Dr(e,s.visualElement,a),t.maskOccludee(i),t.trackGraphicState(a)];return{visualElement:s.visualElement,remove:()=>Ft(r).remove()}}function Dr(e,t,i){const{graphic:a,view:s}=e,r=[],n=Lt(a),o="on-the-ground"===n.mode||!n.offset&&"absolute-height"!==n.mode,l=new Er,h=new Bt({view:s,extensionType:Ds.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});Ds.visualElements.pointGraphics.shadowStyle.apply(h);const c=Gt(Ds.visualElements.heightPlaneAngleCutoff),p=new E({view:s,attached:!1,angleCutoff:c});Ds.visualElements.heightPlane.apply(p);let d=1,u=1;const g=()=>{if(l.update(e),!i.displaying||o&&(i.isDraped||!Gr(a)||!a.geometry.hasZ))return t.laserlineEnabled=!1,h.attached=!1,void(p.attached=!1);t.laserlineEnabled=!0;{const e=4&l.grabbingState?Ds.visualElements.laserlineAlphaMultiplier:1;e!==d&&(d=e,Ds.visualElements.lineGraphics.shadowStyle.apply(t,e),Ds.visualElements.pointGraphics.shadowStyle.apply(h,e))}{const e=2&l.grabbingState?Ds.visualElements.laserlineAlphaMultiplier:1;e!==u&&(u=e,Ds.visualElements.heightPlane.apply(p,e))}(function(e,t){const i=1===t.numSelected?t.firstSelected:t.numSelected>1&&y(t.firstGrabbedXY)?t.firstGrabbedXY:null;y(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1})(h,l),function(e,t,i,a){if(a.numSelected>0){A(Ar,0,0,0);let t=0;e.forEachManipulator(((e,i)=>{1===i&&e.selected&&e instanceof ir&&(T(Ar,Ar,e.renderLocation),t++)})),t>0?(i.heightManifoldTarget=C(Ar,Ar,1/t),i.attached=!0):i.attached=!1}else{const a=t.attachmentOrigin;y(a)&&e.view.renderCoordsHelper.toRenderCoords(a,Ar)?(i.heightManifoldTarget=Ar,i.attached=!0):i.attached=!1}}(e,t,p,l)};Ds.visualElements.zVerticalLine.apply(h),r.push(i.on("changed",g),i.watch("displaying",g),t.events.on("attachment-origin-changed",g),jt(h),jt(p));const m=[],v=()=>{Ft(m).remove(),m.length=0,e.forEachManipulator((e=>m.push(e.events.on("grab-changed",g)))),e.forEachManipulator((e=>m.push(e.events.on("select-changed",g)))),g()};return v(),r.push(e.onManipulatorsChanged(v),kt((()=>Ft(m)))),Ft(r)}function Gr(e){return y(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const Ar=B();function Rr(e){const{view:t,graphic:i}=e,a=new Qs({graphic:i}),s=[],r=function(e,t,i){const{view:a,graphic:s}=e,r=new Ut({view:a,geometry:Pr(s),elevationInfo:Lt(s),attached:!1});return function(e,t,i,a){const s=()=>t.attached=i.displaying;(function(e,t,i,a){const{view:s,graphic:r}=e;let n=null;const o=e=>{y(n)&&(n.remove(),n=null),i.isDraped&&y(e)&&(n=function(e,t,i){const a=e.elevationProvider.spatialReference;Yt(t,Tr,a);const s=Tr[0],r=Tr[1];return e.elevationProvider.on("elevation-change",(e=>{Nt(e.extent,s,r)&&i()}))}(s,e,(()=>{t.geometry=e})))},l=()=>{const e=Pr(r);o(e),t.geometry=e};a.push(i.on("changed",l),kt((()=>n))),l()})(e,t,i,a),Ds.visualElements.pointGraphics.outline.apply(t),a.push(je(i,"displaying",s))}(e,r,t,i),i.push(jt(r)),r}(e,a,s);return function(e,t,i,a){const{view:s,graphic:r}=e,n=new Bt({view:s,extensionType:Ds.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});Ds.visualElements.zVerticalLine.apply(n);const o=new E({view:s,intersectsLineInfinite:!0,attached:!1});Ds.visualElements.pointGraphics.shadowStyle.apply(o);const l=Gt(Ds.visualElements.heightPlaneAngleCutoff),h=new E({view:s,attached:!1,angleCutoff:l});Ds.visualElements.heightPlane.apply(h);const c=Lt(e.graphic),p=F.fromElevationInfo(c),d="on-the-ground"===c.mode||!c.offset&&"absolute-height"!==c.mode,u=new Er;let g=1,m=1;const v=()=>{u.update(e);const i=Pr(r),l=d&&(t.isDraped||_(i)||!i.hasZ);let c=!0;if(!l&&y(i)){const e=Wt(i,s.elevationProvider,p,s.renderCoordsHelper);A(Tr,i.x,i.y,e),qt(Tr,i.spatialReference,Tr,s.renderCoordsHelper.spatialReference),n.setStartEndFromWorldDownAtLocation(Tr),o.intersectsWorldUpAtLocation=Tr}else c=!1;const v=2&u.grabbingState?Ds.visualElements.laserlineAlphaMultiplier:1;v!==g&&(g=v,Ds.visualElements.heightPlane.apply(h,v));const f=I(Cr);!l&&t.displaying&&a.calculateMapBounds(f)&&qt(Zt(f,Tr),s.spatialReference,Tr,s.renderCoordsHelper.spatialReference)?(h.heightManifoldTarget=Tr,h.attached=!0):h.attached=!1;const M=4&u.grabbingState?Ds.visualElements.laserlineAlphaMultiplier:1;M!==m&&(m=M,Ds.visualElements.pointGraphics.shadowStyle.apply(o,M));const b=c&&t.displaying&&!l;o.attached=b,n.attached=b};i.push(t.watch(["displaying","isDraped"],v),t.on("changed",v)),e.forEachManipulator((e=>{i.push(e.events.on("grab-changed",v))})),i.push(jt(o)),i.push(jt(n)),i.push(jt(h)),v()}(e,a,s,r),s.push(t.trackGraphicState(a)),{visualElement:r,remove(){Ft(s).remove()}}}function Pr(e){const t=e.geometry;return _(t)?null:"point"===t.type?t:"mesh"===t.type?t.anchor.clone():null}const Tr=B(),Cr=M();function zr(e){switch(R(e.graphic.geometry).type){case"point":case"mesh":return Rr(e);case"polygon":case"polyline":return Or(e);default:return null}}const Ir=[1,.5,0],Hr=70,Vr=Math.ceil(Hr/3*2),Lr=5*Math.PI/12,Fr=1*Math.PI/3;class kr{constructor(){this._available=!0}set location(e){this.forEachManipulator3D((t=>t.location=e))}set elevationAlignedLocation(e){this.forEachManipulator3D((t=>t.elevationAlignedLocation=e))}set elevationInfo(e){this.forEachManipulator3D((t=>t.elevationInfo=e))}get renderLocation(){let e;return this.forEachManipulator3D((t=>{e||(e=t.renderLocation)})),e}get available(){return this._available}set available(e){this._available=e,this.forEachManipulator3D((t=>t.available=e))}get grabbing(){return this.someManipulator((e=>e.grabbing))}get dragging(){return this.someManipulator((e=>e.dragging))}hasManipulator(e){return this.someManipulator((t=>t===e))}someManipulator(e){let t=!1;return this.forEachManipulator((i=>{!t&&e(i)&&(t=!0)})),t}forEachManipulator3D(e){this.forEachManipulator(((t,i)=>{t instanceof ir&&e(t,i)}))}}function jr(e,t){return Br(e,(()=>t))}function Br(e,t){const i=B(),a=B();let s=!1;return r=>{const n=t(r);if("start"===r.action){const t=it(r.screenStart,Qt(Kt.get())),a=tr(e.state.camera,t,Xr);y(a)&&(s=ot(n,a,i))}if(!s)return null;const h=it(r.screenEnd,Qt(Kt.get())),c=tr(e.state.camera,h,Xr);return _(c)?null:ot(n,c,a)?l(o({},r),{renderStart:i,renderEnd:a,plane:n,ray:c}):null}}function Ur(e,t,i,a=null,s=null){return function(e,t,i,a=null,s=null){let r=null;return n=>{if("start"===n.action&&(r=e.sceneIntersectionHelper.intersectElevationFromScreen(Ke(n.screenStart.x,n.screenStart.y),t,i,s),y(r)&&y(a)&&!_t(r,r,a)))return null;if(_(r))return null;const h=e.sceneIntersectionHelper.intersectElevationFromScreen(Ke(n.screenEnd.x,n.screenEnd.y),t,i,s);return y(h)?y(a)&&!_t(h,h,a)?null:l(o({},n),{mapStart:r,mapEnd:h}):null}}(e,i,Xt(t,e,i),a,s)}function Wr(e,t,i,a=null,s=null){return Ur(e,i,Lt(t),a,s)}function qr(e,t,i){let a=null;const s=new Jt;return s.next(jr(e,function(e,t){const i=Nr,a=Yr,s=Ye();e.renderCoordsHelper.worldUpAtPosition(t,i);const r=zt(s,i,Ze(a,t,e.state.camera.eye));return zt(r,r,i),nt(t,r,s)}(e,t))).next(function(e,t){const i=B(),a=$t(t);e.renderCoordsHelper.worldUpAtPosition(t,i);const s=B(),r=B(),n=s=>(Ze(s,s,t),ei(i,s,s),"global"===e.viewingMode&&$t(s)*ti(ii(i,s))<.001-a&&Ze(s,C(s,i,.001),t),T(s,s,t),s);return e=>(e.renderStart=n(dt(s,e.renderStart)),e.renderEnd=n(dt(r,e.renderEnd)),e)}(e,t)).next(Zr(e,i)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,a=e})),e=>(a=null,s.execute(e),a)}function Zr(e,t){const i=e.renderCoordsHelper;return e=>{const a=i.fromRenderCoords(e.renderStart,t),s=i.fromRenderCoords(e.renderEnd,t);return y(a)&&y(s)?l(o({},e),{mapStart:a,mapEnd:s}):null}}const Nr=B(),Yr=B(),Xr=We();function Qr(e,t,i,a){const s=e.graphic,r=(e,i)=>t({action:e,graphic:s,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((e,t,i)=>{const n=t.next((e=>("start"===e.action&&r("start",e),e))).next(ai(s,a)).next((e=>{switch(e.action){case"start":case"update":(e.translationX||e.translationY||e.translationZ)&&r("update",e);break;case"end":r("end",e)}return e}));return i.next(si(s)).next((()=>{r("end",{screenDeltaX:0,screenDeltaY:0})})),n}))}function Kr(e){if(_(e)||"polyline"!==e.type&&"polygon"!==e.type)return 0;const t=("polyline"===e.type?e.paths:e.rings)[0];if(!t||t.length<2)return 0;const i=t[0],a=t[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class Jr extends kr{constructor(e){super(),this._handles=new ri,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this.createMaterial(),this._transparentMaterial=this.createMaterial(.5),this._angle=0,this._scale=1,this._radius=Hr,this._updateAfterDrag=!1,this.events=new w,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._handles.removeAll(),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){this._arrowManipulatorInfos.map((({manipulator:t})=>e(t,1)))}createGraphicDragPipeline(e,t,i){const a=t.graphic,s=Lt(a),r=R(a.geometry).spatialReference;return Qr(t,i,(t=>this.createDragPipeline(((i,a,s,r,n)=>t(i,e(i,a,s,r,n),s)),s,r,a)),this._view.state.viewingMode)}createDragPipeline(e,t,i,a){return Ft(this._arrowManipulatorInfos.map((({manipulator:s},r)=>ni(s,((s,n,h,c,p)=>{const d=n.next((e=>l(o({},e),{manipulatorType:1}))).next(oi(this._view,s.elevationAlignedLocation)).next(Ur(this._view,s.elevationAlignedLocation,t,i,a)).next(li(s.location,this.angle+(r+1)*Math.PI*.5)).next(hi());e(s,d,h,c,p)})))))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:t},i){const a=this._radius/Hr,s=54*a,r=s*Math.sqrt(3)/2,n=Ae.createExtrudedTriangle(r,s/2,s/2,.02);Ae.transformInPlace(n,ci(Ct.get(),A(Ue.get(),0,-r/3,0))),e.renderObjects=[{geometry:n,material:this._opaqueMaterial,stateMask:2},{geometry:n,material:this._transparentMaterial,stateMask:1}],e.radius=r/3*2*1.2;const o=At(Ct.get());pi(o,i*Math.PI/2);const l=At(Ct.get());ci(l,A(Ue.get(),0,100*a,0)),xt(t,o,l)}_createManipulators(){for(let e=0;e<4;e++){const t=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,t=At(Ct.get());di(t,t,e,ui(0,0,1));const i=gi(Ct.get(),A(Ue.get(),this.displayScale,this.displayScale,this.displayScale)),a=At(Ct.get());xt(a,i,t);for(const s of this._arrowManipulatorInfos){const e=xt(Ct.get(),a,s.transform);s.manipulator.modelTransform=e}}_createArrowManipulator(e){const t=new ir({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:ui(0,0,1)}}),i={manipulator:t,transform:Qe()};return this._updateArrowManipulator(i,e),this._handles.add(t.events.on("drag",(e=>{this._updateAfterDrag&&"end"===e.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}createMaterial(e=1){const t=h.toUnitRGBA(ps.main);return t[3]*=e,new Pt({color:t,transparent:1!==e,cullFace:2,renderOccluded:2})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:e})=>e))}}}class $r{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Jt,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&y(this.lastDragEvent)){const t=this.lastDragEvent.mapEnd,i=this.snap(this.lastDragEvent.screenEnd);if(y(i)){const a={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===e?i:t,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(a)}}this._enabled=e}snap(e){const t=y(this.view)?this.view.toMap(e,{exclude:[]}):null;return y(t)&&y(this.view)&&(t.z=Xt(t,this.view,this.elevationInfo)),t}createDragEventPipelineStep(e,t){return this.view=e,this.elevationInfo=t,this.lastDragEvent=null,e=>{if(this.lastDragEvent="end"!==e.action?o({},e):null,this._enabled){const t=this.snap(e.screenEnd);return y(t)?{action:e.action,mapStart:e.mapStart,mapEnd:t,screenStart:e.screenStart,screenEnd:e.screenEnd}:null}return{action:e.action,mapStart:e.mapStart,mapEnd:e.mapEnd,screenStart:e.screenStart,screenEnd:e.screenEnd}}}}class en extends kr{constructor(e){super(),this._handles=new ri,this._snapToScene=new $r,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=Hr,this._view=e.view,this._tool=e.tool,null!=e.snapToScene&&(this.snapToScene=e.snapToScene),null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,t,i){const a=t.graphic,s=Lt(a),r=R(a.geometry).spatialReference;return Qr(t,i,(t=>this.createDragPipeline(((i,a,s,r,n)=>t(i,e(i,a,s,r,n),s)),s,r,a)),this._view.state.viewingMode)}createDragPipeline(e,t,i,a){const s=this._view;return ni(this._manipulator,((r,n,h,c,p)=>{const d=n.next(oi(s,r.elevationAlignedLocation)).next(Ur(s,r.elevationAlignedLocation,t,i,a)).next(this._snapToScene.createDragEventPipelineStep(s,t),this._snapToScene.next).next((e=>l(o({},e),{manipulatorType:1}))).next(hi());e(r,d,h,c,p)}))}_updateManipulatorTransform(){const e=gi(Ct.get(),A(Ue.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new ir({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:ui(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=Ae.createCylinderGeometry(.02,1,128,ui(0,0,1),ui(0,0,0)),t=gi(Qe(),ui(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:t,stateMask:2},{geometry:e,material:this._discMaterialTransparent,transform:t,stateMask:1}],this._manipulator.radius=this._radius/Hr*80}_createMaterial(e=1){const t=h.toUnitRGBA(ps.main);return t[3]*=e,new Pt({color:t,transparent:1!==e,cullFace:2,renderOccluded:2})}get test(){return{discManipulator:this._manipulator}}}class tn extends kr{constructor(e){super(),this._handles=new ri,this._radius=Hr,this.events=new w,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this.createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))}forEachManipulator(e){e(this._manipulator,0)}createGraphicDragPipeline(e,t,i){const a=R(t.graphic.geometry).spatialReference;return Qr(t,i,(t=>this.createDragPipeline(((i,a,s,r,n)=>t(i,e(i,a,s,r,n),s)),a)),this._view.state.viewingMode)}createDragPipeline(e,t){const i=this._view;return ni(this._manipulator,((a,s,r,n,h)=>{const c=s.next((e=>l(o({},e),{manipulatorType:0}))).next(qr(i,a.renderLocation,t)).next(hi());e(a,c,r,n,h)}))}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this.updateManipulator())}updateManipulator(){const e=this._radius/Hr,t=Ds.zManipulator.height*e,i=Ds.zManipulator.coneHeight*e,a=Ds.zManipulator.coneWidth*e,s=Ds.zManipulator.width*e,r=[ui(0,0,0),ui(0,0,t)],n=Ae.createTubeGeometry(r,s/2,16,!1),o=Ae.createConeGeometry(i,a/2,16,!1),l=[ui(0,0,0),ui(0,0,t+i)],h=(e=>{const i=Qe();return mi(i,i,[0,0,t]),vi(i,i,Math.PI/2),i})(),c=(e,t)=>{const i=_i(Ds.zManipulator.color,t);return[i.r/255,i.g/255,i.b/255,Ds.zManipulator.color.a*e]},p=yr(c(1,.25),1),d=yr(c(1,0),1),u=yr(c(.7,0),Ds.zManipulator.renderOccluded),g=yr(c(.85,0),Ds.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:o,transform:h,material:p,stateMask:1},{geometry:n,material:p,stateMask:1},{geometry:o,transform:h,material:d,stateMask:2},{geometry:n,material:d,stateMask:2},{geometry:o,transform:h,material:u,stateMask:1},{geometry:n,material:u,stateMask:1},{geometry:o,transform:h,material:g,stateMask:2},{geometry:n,material:g,stateMask:2}],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}createManipulator(){const e=new ir({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const t=this._view.state.camera,i=an;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const a=yi(t.eye,i),s=t.computeRenderPixelSizeAtDist(a),r=Ze(sn,i,t.eye);ve(r,r);const n=rn;this._view.renderCoordsHelper.worldUpAtPosition(an,n);const o=Math.abs(ii(r,n)),l=zt(sn,r,n),h=zt(sn,l,n),c=Mi(o,.01,1),p=1-Math.sqrt(1-c*c)/c/t.fullWidth,d=this._radius/Hr,u=Ds.zManipulator.width*d;C(h,ve(h,h),(1/p-1)*a+s*u),e[12]-=sn[0],e[13]-=sn[1],e[14]-=sn[2]},this._manipulator=e,this.updateManipulator()}get test(){return{manipulator:this._manipulator}}}const an=B(),sn=B(),rn=B();class nn extends kr{constructor(e){super(),this._handles=new ri,this._angleDeferred=null,this._interactive=!0;const{tool:t,view:i,snapToScene:a,radius:s}=e;this._view=i,this.xyManipulation=new en({tool:t,view:i,snapToScene:a,radius:s}),this.xyAxisManipulation=new Jr({tool:t,view:i,radius:s}),this.zManipulation=new tn({tool:t,view:i,radius:s}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this.autoHideXYAxis(),this.forEachManipulator((e=>{this._handles.add(e.events.on("grab-changed",(()=>this.updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,t,i){return Ft([this.xyManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(0,t,i,a,s,r)),t,i),this.xyAxisManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(1,t,i,a,s,r)),t,i),this.zManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(2,t,i,a,s,r)),t,i)])}createDragPipeline(e,t,i,a){return Ft([this.xyManipulation.createDragPipeline(((t,i,a,s,r)=>e(0,t,i,a,s,r)),t,i,a),this.xyAxisManipulation.createDragPipeline(((t,i,a,s,r)=>e(1,t,i,a,s,r)),t,i,a),this.zManipulation.createDragPipeline(((t,i,a,s,r)=>e(2,t,i,a,s,r)),i)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this.updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator((t=>e(t,1))),this.xyAxisManipulation.forEachManipulator((t=>e(t,1))),this.zManipulation.forEachManipulator((t=>e(t,0)))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator((e=>e.focused))||this.xyAxisManipulation.someManipulator((e=>e.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||e}autoHideXYAxis(){const e=this.xyAxisManipulation,t=this.xyManipulation;if(bi("esri-mobile"))return;const i=[];t.forEachManipulator((e=>i.push(e))),e.forEachManipulator((e=>i.push(e)));const a=()=>{const t=[];this.xyAxisVisible?y(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator((e=>t.push(e.disableDisplay()))),this._handles.remove(on),this._handles.add(t,on)};for(const s of i)this._handles.add(s.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",a)),a()}updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator((t=>{t.interactive=!e&&this._interactive||t.grabbing}))}static radiusForSymbol(e){const t=y(e)&&"point-3d"===e.type&&e.symbolLayers;return t&&t.length>0&&t.some((e=>"icon"===e.type))?Vr:Hr}}const on="disable-xy-axis-display";class ln extends kr{constructor(e){super(),this._handles=new ri,this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,1)}createGraphicDragPipeline(e){return Qr(this._graphicState,e,(e=>this.createDragPipeline(e)),this._view.state.viewingMode)}createDragPipeline(e){const t=this._view,i=this._graphicState.graphic,a=y(i.geometry)?i.geometry.spatialReference:null;return ni(this._manipulator,((s,r,n,o,l)=>{const h=r.next(function(e,t,i,a){const s=t.toMap(e.screenStart,{include:[i]});return y(s)?Wr(t,i,s,a):null}(l,t,i,a)).next(wi()).next(hi());e(s,h,n,o,l)}))}_createManipulator(){const e=this._view,t=this._graphicState.graphic;this._manipulator=new ss({graphic:t,view:e,selectable:!0,cursor:"move"})}}class hn{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class cn{constructor(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"}}class pn{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let dn=class extends(Re(w.EventedMixin(Pe))){constructor(e){super(e),this.graphics=new Si,this.enableZ=!0,this.type="move-3d",this._toolHandles=new ri,this.snappingPipeline=new xi}initialize(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators(),this.complete()}destroy(){this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>0===Ei(e))).map((e=>new un(e)));e.length&&(this.createManipulators(e),this.createVisualElements(e),this.handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this.updateMoveManipulation(e))}createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new ln({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",l(o({},e),{graphic:i.graphic})),e.stopPropagation()}))))),this.handles.add(t.manipulationXY.createDragPipeline(((t,i,a,s)=>this.buildDragEventPipeline(e,0,t,i,a,s))))}this.createMoveManipulation(e)}createMoveManipulation(e){const t=new nn({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?nn.radiusForSymbol(e[0].graphic.symbol):Hr});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this.handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",l(o({},i),{graphic:this.graphics.getItemAt(0)})),i.stopPropagation()})))}));const i=()=>this.updateMoveManipulation(e);for(const s of e)this.handles.add([s.state.on("changed",i),s.state.watch("displaying",i)]);const a=e[e.length-1];this.handles.add(a.state.on("changed",(()=>this.updateMoveManipulationAngle(a)))),this.handles.add(t.createDragPipeline(((t,i,a,s,r)=>this.buildDragEventPipeline(e,t,i,a,s,r)),Lt(a.graphic),R(a.graphic.geometry).spatialReference,a.graphic)),this.updateMoveManipulationAngle(a)}createVisualElements(e){for(const t of e){const i=t.graphic,a=zr({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>Oi()});_(a)||(t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof Rs&&this.handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this.updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this.updateMoveManipulation(e)))]),this.handles.add(a))}}updateMoveManipulationAngle(e){this._moveManipulation.angleDeferred=()=>Kr(e.graphic.geometry)}updateMoveManipulation(e){const t=b(0,0,0,this.view.spatialReference);let i=0,a=!1;const s=this._moveManipulation;for(const r of e){if(!r.state.displaying)continue;const e=r.state.graphic;this.enableZ&&xr(e)&&(a=!0);const s=r.geometryRepresentation instanceof Rs&&!r.state.isDraped?r.geometryRepresentation.attachmentOrigin:wr(this.view,e);y(s)&&(t.x+=s.x,t.y+=s.y,t.z+=s.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,s.location=t,s.xyManipulation.available=!0,s.xyAxisManipulation.available=!0,s.zManipulation.available=a):s.available=!1}buildDragEventPipeline(e,t,i,a,s,r){const n=[],o=[];let l=null,h=null;const c=()=>{for(const e of n)e.dragging=!1;n.length=0,o.length=0,l=null,h=null,this._moveManipulation.interactive=!0};if(1===e.length&&0===t){const t=e[0].graphic;a=this.buildSnappingPipelineSteps(t,Lt(t),a,s,r)}const p=a.next((t=>{if("start"===t.action){n.length=0,o.length=0;for(const t of e)t.dragging||!t.manipulationXY.hasManipulator(i)&&t.manipulationXY.grabbing||(n.push(t),o.push(t.graphic),t.dragging=!0);if(0!==o.length&&(this._moveManipulation.interactive=!1,l=Di(o,this.view.state.viewingMode),h=Gi(o),this.emit("graphic-move-start",new hn(o)),this.destroyed))return null}return 0!==o.length?t:null})).next((e=>l(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),a=i.x-t.x,s=i.y-t.y;if(this.emit("graphic-move",new cn(a,s,o)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new pn(o)),this.destroyed)return null;c()}}));return s.next((e=>h(e))).next((()=>{if(this.emit("graphic-move-stop",new pn(o)),this.destroyed)return null;c()})),p}buildSnappingPipelineSteps(e,t,i,a,s){const r=e.geometry;if(_(r)||"point"!==r.type&&"mesh"!==r.type)return i;const n=("point"===r.type?r:r.anchor).clone(),h=new Ai({elevationInfo:t,pointer:s,geometry:Ri.fromGeometry(n,this.view.viewingMode),visualizer:new Pi,excludeFeature:e}),c=this.snappingManager;return i.next((t=>(n.z=Ti(this.view,n,Lt(e),{mode:"absolute-height",offset:0}),l(o({},t),{snapOrigin:h.coordinateHelper.fromPoint(n)})))).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:h,snappingManager:c,cancel:a,updatingHandles:this.updatingHandles}),this.snappingPipeline.next)}};g([m({constructOnly:!0,nonNullable:!0})],dn.prototype,"view",void 0),g([m({readOnly:!0})],dn.prototype,"graphics",void 0),g([m({constructOnly:!0,nonNullable:!0})],dn.prototype,"enableZ",void 0),g([m({constructOnly:!0})],dn.prototype,"snappingManager",void 0),g([m({readOnly:!0})],dn.prototype,"type",void 0),g([m({readOnly:!0})],dn.prototype,"updating",null),dn=g([v("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],dn);class un{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Qs({graphic:e})}get graphic(){return this.state.graphic}}function gn(e,t,i){const a="on-the-ground"===i.mode?1:0;return new Ci(e,a,t,0)}function mn(e,t,i){const a=B();if(!e.renderCoordsHelper.toRenderCoords(t,a))return null;const s=vn(e,t,Ii(i.plane)),r=vn(e,t,i.edgeDirection);if(_(s)||_(r))return null;const n=zt(B(),s,r);return nt(a,n,Ye())}function vn(e,t,i){const a=b(t.x+i[0],t.y+i[1],t.z+i[2],t.spatialReference),s=B(),r=B();return e.renderCoordsHelper.toRenderCoords(t,s)&&e.renderCoordsHelper.toRenderCoords(a,r)?Hi(r,s,r):null}let fn=class extends(w.EventedMixin(Li)){constructor(e){super(e),this._vertexManipulatorMaterial=yr(Ds.colorToVec4(Ds.reshapeManipulators.vertex.color),Ds.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=_r(Ds.colorToVec4(Ds.reshapeManipulators.vertex.outlineColor),Ds.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=_r(Ds.colorToVec4(Ds.reshapeManipulators.vertex.hoverOutlineColor),Ds.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=yr(Ds.colorToVec4(Ds.reshapeManipulators.edge.color),Ds.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=_r(Ds.colorToVec4(Ds.reshapeManipulators.edge.outlineColor),Ds.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=yr(Ds.colorToVec4(Ds.reshapeManipulators.edgeOffset.color),Ds.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=yr(Ds.colorToVec4(Ds.reshapeManipulators.edgeOffset.hoverColor),Ds.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=yr(Ds.colorToVec4(Ds.reshapeManipulators.selected.color),Ds.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=_r(Ds.colorToVec4(Ds.reshapeManipulators.selected.outlineColor),Ds.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=_r(Ds.colorToVec4(Ds.reshapeManipulators.selected.hoverOutlineColor),Ds.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new ri,this._manipulatorInfos=[],this._editGeometryHelper=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=0,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._snappingPipeline=new xi,this._snappingPipelineHandle=new xi,this._vertexLaserLineVisualElement=null}initialize(){const e=new Qs({graphic:this.graphic});this._graphicState=e,this.handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])}destroy(){this._clear()}get inputGeometry(){return y(this._editGeometryHelper)?this._editGeometryHelper.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}removeSelectedVertices(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_clear(){this._removeManipulators(),this._resetGrabbingDragging(),this._editGeometryHelper=Le(this._editGeometryHelper)}_removeManipulators(){this._moveManipulation=Le(this._moveManipulation),this._graphicMoveManipulation=Le(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(_(this._editGeometryHelper))return;const e=Lt(this.graphic);for(const t of this._editGeometryHelper.editGeometry.components){for(const i of t.vertices)this._createVertexOrEdgeManipulator(i,e);for(const i of t.edges)this._createVertexOrEdgeManipulator(i,e)}this._createGraphicMoveManipulators(e)}get canRedo(){return y(this._editGeometryHelper)&&this._editGeometryHelper.canRedo}get canUndo(){return y(this._editGeometryHelper)&&this._editGeometryHelper.canUndo}redo(){if(_(this._editGeometryHelper))return null;const e=this._editGeometryHelper.redo();return y(e)&&(this.outputGeometry=this._editGeometryHelper.geometry,this._recreateManipulators()),e}undo(){if(_(this._editGeometryHelper))return null;this.emit("undo");const e=this._editGeometryHelper.undo();return y(e)&&(this.outputGeometry=this._editGeometryHelper.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._createManipulators()}_recreateEditGeometryAndManipulators(e=this.inputGeometry){this._clear(),_(e)||(Le(this._editGeometryHelper),this._editGeometryHelper=Ri.fromGeometry(e,this.view.viewingMode),this._createManipulators())}_perGraphicManipulatorDragAction(e,t){if("end"===t.action)return;let i=0;const a=[],s=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),r=1===e&&s;for(const n of this._manipulatorInfos)_n(n)&&(n.manipulator.grabbing||r&&!n.manipulator.selected||a.push(n),i++);if(0!==a.length)if(this._moveVertices(a,t),a.length===i){if(this._updateEventState(1),this.destroyed)return;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(2),this.destroyed)return;this.emit("reshape",{type:"reshape",mover:this.graphic})}}isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)_n(t)&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(2),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const s=[];for(const r of this._manipulatorInfos)_n(r)&&(r.manipulator.selected&&!r.manipulator.grabbing||r===e.info)&&s.push(r);this._moveVertices(s,e,1),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulators(e){if(this._graphicMoveManipulation=new ln({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic){let e=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((t,i,a)=>{i.next((e=>this._trackNumDragging(e))).next((t=>("start"===t.action&&(e=R(this._editGeometryHelper).createUndoGroup()),t))).next((t=>{this._perGraphicManipulatorDragAction(0,t),"end"===t.action&&(e=Fi(e))})),a.next(this._cancelDragOperation((()=>e=Fi(e))))})))}else this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null}));this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",l(o({},e),{graphic:this.graphic})),e.stopPropagation()}))]))),this._moveManipulation=new nn({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&xr(this.graphic),snapToScene:!1,radius:nn.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this.handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click",l(o({},t),{graphic:this.graphic})),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=R(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline(((t,i,a,s,r)=>{const n=a.next((e=>this._trackNumDragging(e))).next((e=>{const t=this._manipulatorInfos.filter((e=>_n(e)&&e.manipulator.selected));return 1===e.manipulatorType&&1===t.length?l(o({},e),{info:t[0],snapOrigin:t[0].handle.pos}):l(o({},e),{info:null})})).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:e=>!!e.info,cancel:s,snappingManager:this.tool.snappingManager,snappingContext:new Ai({geometry:R(this._editGeometryHelper),elevationInfo:e,pointer:r,excludeFeature:this.graphic,visualizer:new Pi}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(wi()).next((e=>(this._perGraphicManipulatorDragAction(1,e),e)));return s.next(this._cancelDragOperation()),n}),e,t,this.graphic),je(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),je(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this.handles.remove(e)}))]),this._updateMoveManipulationPosition();const i=zr({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){y(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,1);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});y(i)&&(this._outlineVisualElement=i.visualElement instanceof Rs?i.visualElement:null),y(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(e,t=Lt(this.graphic)){const i=Ds.reshapeManipulators.edgeOffset,a=i.size/2,s=a+i.collisionPadding;if(_(this._edgeOffsetManipulatorGeometryInside)||_(this._edgeOffsetManipulatorGeometryOutside)){const e=a/s,t=e*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=Ae.createExtrudedTriangle(t,e/2,e/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=Ae.createExtrudedTriangle(-t,e/2,e/2,i.height,-i.offset)}const r=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2}],n=new ir({view:this.view,renderObjects:r,elevationInfo:"on-the-ground"!==t.mode||ki(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,touchMultiplier:1,radius:s,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:ui(0,0,1)},collisionPriority:1}),h=new ir({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:"default"});h.grabbable=!1;const c={manipulator:n,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,visibilityManipulator:h,elevationInfo:t,visibilityHandle:null},p=()=>{Fi(c.visibilityHandle);(!n.focused&&!h.focused||(()=>function(e,t,i){const a=i.projectToRenderScreen(e,Je()),s=i.projectToRenderScreen(t,Je());return Vi(Ze(a,a,s))}(this._getManipulatorInfoFromHandle(c.handle.left).manipulator.renderLocation,this._getManipulatorInfoFromHandle(c.handle.right).manipulator.renderLocation,this.view.state.camera)<i.minSquaredEdgeLength)())&&(n.grabbable=!1,c.visibilityHandle=Ft([n.disableDisplay(),{remove:()=>{n.grabbable=!0}}]))};this._manipulatorHandles.add([n.events.on("focus-changed",(()=>p())),h.events.on("focus-changed",(()=>p())),{remove:()=>{Fi(c.visibilityHandle),this.manipulators.remove(c.visibilityManipulator)}}],n),p(),this._updateEdgeOffsetManipulator(c);const d=this._getManipulatorInfoFromHandle(c.handle.left).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c))),u=this._getManipulatorInfoFromHandle(c.handle.right).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c)));c.locationUpdateHandle=Ft([d,u]),this._manipulatorHandles.add(c.locationUpdateHandle,n),this._manipulatorHandles.add(this._watchAndUpdateGrabState(n,!0),n);const g=ni(n,((e,i,a)=>{this._clearSelection();const{step:s,cleanup:r}=this._initializeEdgeOffset(c,t);i.next((e=>this._trackNumDragging(e))).next(oi(this.view,e.elevationAlignedLocation)).next(s).next(function(e){return Br(e,(e=>e.plane))}(this.view)).next(Zr(this.view,R(this._editGeometryHelper).editGeometry.coordinateHelper.spatialReference)).next(wi()).next(this._applyEdgeOffsetStep(c)).next((e=>{"end"===e.action&&r()})),a.next((e=>(r(),e))).next(this._cancelDragOperation())}));return this._manipulatorHandles.add(g,n),this._manipulatorHandles.add([n.events.on("immediate-click",(e=>{e.shiftKey||this._clearSelection(),e.stopPropagation()})),h.events.on("immediate-click",(e=>this.emit("immediate-click",l(o({},e),{graphic:this.graphic}))))],n),this._manipulatorInfos.push(c),this.manipulators.add(n),this.manipulators.add(h),this.emit("manipulators-changed"),c}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const t=R(this._editGeometryHelper).editGeometry.coordinateHelper,i=mn(this.view,e.manipulator.elevationAlignedLocation,gn(t,e.handle,R(e.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(e.handle.left).manipulator.renderLocation,s=this._getManipulatorInfoFromHandle(e.handle.right).manipulator.renderLocation,r=y(i)?function(e,t,i){const a=Ii(e),s=Hi(B(),t,i),r=zt(B(),s,a),n=zt(B(),s,r);return zi(s[0],s[1],s[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],0,0,0,0,1)}(i,a,s):ji;e.manipulator.modelTransform=r,e.visibilityManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.visibilityManipulator.modelTransform=r;const n=$t(Ze(wn,a,s))/2;e.visibilityManipulator.collisionType={type:"line",paths:[[[-n,0,0],[n,0,0]]]}}_initializeEdgeOffset(e,t){const i=R(this._editGeometryHelper),a=gn(i.editGeometry.coordinateHelper,e.handle,t),s=i.createUndoGroup(),r=mn(this.view,e.manipulator.elevationAlignedLocation,a);a.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.left.left),1),a.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.right.right),0);const n=()=>new Bi({paths:[[e.handle.left.pos,e.handle.right.pos]],spatialReference:R(this._editGeometryHelper).editGeometry.coordinateHelper.spatialReference}),h=new Rs({view:this.view,isDraped:this._graphicState.isDraped,geometry:n(),elevationInfo:e.elevationInfo,width:Ds.visualElements.lineGraphics.outline.width,color:Ds.colorToVec4(ps.main),attached:!0});let c;const p=()=>{this._cleanEdgeOffsetCollapsedEdges(e),c=Fi(c)},d=this.on("undo",p);return c=Ft([jt(h),this._graphicState.watch("isDraped",(e=>h.isDraped=e)),this._graphicState.on("changed",(()=>h.geometry=n())),s,d]),{step:e=>_(a)||_(r)?(p(),null):l(o({},e),{operation:a,plane:r}),cleanup:p}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||_(t.operation))return t;this._updateEventState(2);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:s}=t;return(i||a||s)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_cleanEdgeOffsetCollapsedEdges(e){var t,i;const a=null==(t=e.handle.left.left)?void 0:t.left,s=e.handle.left,r=null==(i=e.handle.right.right)?void 0:i.right,n=e.handle.right,o=R(this._editGeometryHelper).editGeometry.coordinateHelper,l=1e-6,h=[];a&&o.distance(a.pos,s.pos)<l&&h.push(this._getManipulatorInfoFromHandle(s)),(o.distance(s.pos,n.pos)<l||r&&o.distance(r.pos,n.pos)<l)&&h.push(this._getManipulatorInfoFromHandle(n)),h.length&&this._removeVertices(h)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e,t=Lt(this.graphic)){if("edge"===e.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(_(this._vertexManipulatorGeometry)||_(this._vertexManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(Ds.reshapeManipulators.vertex);this._vertexManipulatorGeometry=Ae.createSphereGeometry(e,16,16),this._vertexManipulatorOutlineGeometry=Ae.createSphereGeometry(t,16,16)}if(_(this._edgeManipulatorGeometry)||_(this._edgeManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(Ds.reshapeManipulators.edge);this._edgeManipulatorGeometry=Ae.createSphereGeometry(e,16,16),this._edgeManipulatorOutlineGeometry=Ae.createSphereGeometry(t,16,16)}const i=y(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|Sn.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|Sn.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|Sn.Vertex},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|Sn.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|Sn.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|Sn.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|Sn.Edge});const a=new ir({view:this.view,renderObjects:i,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,e,t);const s="edge"===e.type?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(s),this.manipulators.add(a),this._updateManipulatorPosition(s),"edge"===s.type){const e=this._getManipulatorInfoFromHandle(s.handle.left).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(s))),t=this._getManipulatorInfoFromHandle(s.handle.right).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(s)));s.locationUpdateHandle=Ft([e,t]),this._manipulatorHandles.add(s.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const r=ni(a,((e,i,a,r)=>{let n=null;i.next((e=>this._trackNumDragging(e))).next((e=>{if("start"===e.action&&(n=R(this._editGeometryHelper).createUndoGroup()),Mn(s)){const t=this._splitEdgeManipulator(s);return l(o({},e),{info:t,snapOrigin:t.handle.pos})}return l(o({},e),{info:s,snapOrigin:s.handle.pos})})).next(oi(this.view,e.elevationAlignedLocation)).next(Wr(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this.isMultiVertexSelection(),cancel:a,snappingManager:this.tool.snappingManager,snappingContext:new Ai({geometry:R(this._editGeometryHelper),elevationInfo:t,pointer:r,excludeFeature:this.graphic,visualizer:new Pi}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(wi()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(n=Fi(n))})),a.next(this._cancelDragOperation((()=>n=Fi(n))))}));return this._manipulatorHandles.add(r,a),this._manipulatorHandles.add([a.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,s))),a.events.on("select-changed",(()=>{s.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))],a),this.emit("manipulators-changed"),s}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_cancelDragOperation(e){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=y(this._editGeometryHelper)?this._editGeometryHelper.geometry:null,y(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case 0:break;case 1:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(0)}}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=Sn.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=Ds.reshapeManipulators.vertex.size/2+Ds.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i,e.interactive=y(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;break;case"edge":e.state=Sn.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=Ds.reshapeManipulators.edge.size/2+Ds.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"!==i.mode||ki(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",(i=>{if("start"===i.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing}))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null}_updateManipulatorPosition(e){if(!e)return;const t=R(this._editGeometryHelper);if("vertex"===e.handle.type)e.manipulator.location=t.editGeometry.coordinateHelper.toPoint(e.handle.pos,bn),e.manipulator.grabbing&&y(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const i=this._getManipulatorInfoFromHandle(e.handle.left).manipulator,a=this._getManipulatorInfoFromHandle(e.handle.right).manipulator;if(y(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const s=i.location,r=a.location,n=.5,o=s.x+n*(r.x-s.x),l=s.y+n*(r.y-s.y),h=s.hasZ&&r.hasZ?0:void 0;e.manipulator.location=b(o,l,h,t.geometry.spatialReference)}else Ui(wn,i.renderLocation,a.renderLocation,.5),e.manipulator.renderLocation=wn}}_splitEdgeManipulator(e,t=.5){const i=R(this._editGeometryHelper),a=R(i.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const s=Lt(this.graphic);let r;this.enableEdgeOffset?(this._removeManipulator(e),r=this._createVertexOrEdgeManipulator(a)):(r=e,r.handle=a,r.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,s)),a.left&&this._createVertexOrEdgeManipulator(a.left),a.right&&this._createVertexOrEdgeManipulator(a.right),this.outputGeometry=i.geometry,this._updateManipulatorPosition(r),this._updateSelection(e.manipulator);const n=this._updateEventState(2),o=i.editGeometry.coordinateHelper.toArray(r.handle.pos),l=i.editGeometry.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:o,componentIndex:l,vertexIndex:R(a.index)}],added:o}),n&&this._updateEventState(0),r}_updateMoveManipulationPosition(){const e=A(wn,0,0,0);let t=0,i=!1,a=null,s=null;for(const r of this._manipulatorInfos)_n(r)&&(r.manipulator.selected?(t++,T(e,e,r.manipulator.renderLocation),_(a)||r.selectedIndex>a.selectedIndex?(s=a,a=r):(_(s)||r.selectedIndex>s.selectedIndex)&&(s=r)):i=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZVertex&&xr(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZShape&&xr(this.graphic)}if(0!==t){let e=0;if(y(a)){const t=a.handle.pos,i=y(s)?s.handle.pos:a.handle.left&&a.handle.left.left?a.handle.left.left.pos:null,r=!y(s)&&a.handle.right&&a.handle.right.right?a.handle.right.right.pos:null;i&&r?this._moveManipulation.xyAxisManipulation.available=!1:i?e=yn(i,t):r&&(e=yn(t,r))}this._moveManipulation.angle=e,this._moveManipulation.radius=Vr}else this._moveManipulation.angleDeferred=()=>Kr(R(this.graphic.geometry)),this._moveManipulation.radius=nn.radiusForSymbol(this.graphic.symbol);0!==t&&i?(C(e,e,1/t),bn.spatialReference=R(this._editGeometryHelper).geometry.spatialReference,bn.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,bn),this._moveManipulation.elevationAlignedLocation=bn):y(this._outlineVisualElement)&&!this._graphicState.isDraped&&y(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Sr(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=R(this._editGeometryHelper);for(const a of e)if("vertex"===a.handle.type&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.right));const e=R(i.removeVertices([a.handle]).removedVertices[0].createdEdge);e&&this._createVertexOrEdgeManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=i.editGeometry.components.indexOf(e.component);return{coordinates:i.editGeometry.coordinateHelper.toArray(e.pos),componentIndex:t,vertexIndex:R(e.index)}}));this.outputGeometry=i.geometry;const a=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(a&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,i=("start"===t.action?0:1)){const a=R(this._editGeometryHelper);a.moveVertices(e.map((e=>e.handle)),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.geometry;for(const s of e)this._updateManipulatorPosition(s)}_offsetEdge(e,t){if(_(t.operation))return;const i=R(this._editGeometryHelper),a=t.operation.clone();a.distance=t.operation.signedDistanceToPoint(t.mapEnd),i.updateVertices([e.handle.left,e.handle.right],a),this.outputGeometry=i.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.left)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.right))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),Mn(t)&&0===e.button&&this._splitEdgeManipulator(t),e.stopPropagation()}};function yn(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function _n(e){return"vertex"===e.handle.type}function Mn(e){return"edge"===e.handle.type}g([m({constructOnly:!0})],fn.prototype,"tool",void 0),g([m()],fn.prototype,"inputGeometry",null),g([m()],fn.prototype,"outputGeometry",void 0),g([m({readOnly:!0})],fn.prototype,"updating",null),fn=g([v("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],fn);const bn=b(0,0,null,null),wn=B();var Sn,xn;(xn=Sn||(Sn={})).Vertex=16,xn.Edge=32;let En=class extends(w.EventedMixin(Pe)){constructor(e){super(e),this._handles=new ri,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.snappingManager=null}destroy(){this._handles.removeAll(),this._reshapeOperation=Le(this._reshapeOperation),this._set("view",null),this._set("graphic",null)}get updating(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.updating)&&e}get selectionManagementDisabled(){return!0}_updateGeometry(){const e=Wi(this.graphic);this._reshapeOperation.inputGeometry=y(e)?e.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),0!==qi(this.graphic))return;const e=this.watch("graphic.geometry",(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),!0);this._handles.add(e,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(e){this._internalGeometryUpdate=!0,this.graphic.geometry=e,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){_(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}initialize(){this._reshapeOperation=new fn({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",(e=>{"reshape"===e.type&&this._onReshapeGeometryChanged(),this.emit("reshape",e)})),this._reshapeOperation.on("move",(e=>{"move"===e.type&&this._onReshapeGeometryChanged(),this.emit("move",e)})),this._reshapeOperation.on("vertex-add",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)})),this._reshapeOperation.on("vertex-remove",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)})),this._reshapeOperation.on("immediate-click",(e=>this.emit("immediate-click",e))),this.view.on("pointer-down",["Shift"],(e=>{e.stopPropagation()})),je(this,"graphic",(()=>{this._updateGraphic()}),!0)]),this.complete()}get canUndo(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.canUndo)&&e}undo(){y(this.snappingManager)&&this.snappingManager.doneSnapping(),y(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.canRedo)&&e}redo(){y(this.snappingManager)&&this.snappingManager.doneSnapping(),y(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(e){"key-down"!==e.type||"Delete"!==e.key&&"Backspace"!==e.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager}}};var On,Dn;g([m()],En.prototype,"_reshapeOperation",void 0),g([m({constructOnly:!0,nonNullable:!0})],En.prototype,"view",void 0),g([m({constructOnly:!0})],En.prototype,"graphic",void 0),g([m({constructOnly:!0,nonNullable:!0})],En.prototype,"enableZShape",void 0),g([m({constructOnly:!0,nonNullable:!0})],En.prototype,"enableZVertex",void 0),g([m({constructOnly:!0,nonNullable:!0})],En.prototype,"enableMoveGraphic",void 0),g([m({constructOnly:!0,nonNullable:!0})],En.prototype,"enableMidpoints",void 0),g([m({constructOnly:!0,nonNullable:!0})],En.prototype,"enableEdgeOffset",void 0),g([m({readOnly:!0})],En.prototype,"type",void 0),g([m({constructOnly:!0})],En.prototype,"snappingManager",void 0),g([m({readOnly:!0})],En.prototype,"updating",null),En=g([v("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],En),(Dn=On||(On={})).ScaleIn=32,Dn.ScaleOut=64,Dn.RotateLeft=128,Dn.RotateRight=256,Dn.Unlocked=1024,Dn.DelayedFocused=2048,Dn.TouchInput=32768;class Gn{constructor(e){this.mode=null,this._handles=new ri,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new w,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>y(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this.adapter.scale:1,this.tool=e.tool,this.mode=e.mode,this.adapter=e.adapter,this.createManipulator(),this.updateDragState(),this.updateManipulatorTransform()}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this.ringManipulator.location=e}set elevationAlignedLocation(e){this.ringManipulator.elevationAlignedLocation=e}get grabbing(){return this.ringManipulator.grabbing}set interactive(e){this.ringManipulator.interactive=e}destroy(){y(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles.removeAll(),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(e){this.cancelActiveAnimation(),e.start();const t=Zi({update:({deltaTime:t})=>{e.update(t)&&this.cancelActiveAnimation()}});this._activeAnimation=l(o({},e),{frameTask:t})}cancelActiveAnimation(){y(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)}forEachManipulator(e){e(this.ringManipulator,4)}createManipulator(){this.ringManipulator=this.createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const e=this.ringManipulator,t=this.tool.graphicState.graphic,i=ni(e,((e,i,a)=>{this._scaleRotateDragData=null,this.adapter.restart();const s={mode:"none",origin:Ni(e.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=s,this.updateDragState();const r=Ue.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,r),i.next(jr(this.tool.view,nt(e.renderLocation,r,Ye()))).next((e=>{const i=Ii(e.plane),a=Mr(e.renderStart,e.renderEnd,s.origin,i),r=Yi.shortestSignedDiff(s.angle,a);s.angleDir=Mi(s.angleDir+r,-.3,.3),s.angle=a;const n=function(e,t){const i=Ze(Ue.get(),t.renderStart,e.origin),a=Ze(Ue.get(),t.renderEnd,e.origin),s=$t(i),r=$t(a);return 0===s?0:r/s}(s,e),o=n-this.adapter.scale;if(s.scaleDir=Mi(s.scaleDir+o,-.2,.2),this.onScaleChanged(),"none"===s.mode){const i=this.mode||function(e,t,i,a){const{renderStart:s,renderEnd:r}=e,n=An(s,a,Ue.get()),o=An(r,a,Ue.get());if(gt(n,o)<100)return null;const l=Ze(Ue.get(),s,i),h=zt(Ue.get(),l,Ii(t)),c=s,p=T(Ue.get(),c,h),d=An(i,a,Ue.get()),u=n,g=An(p,a,Ue.get()),m=Ze(Ue.get(),g,u),v=Ze(Ue.get(),n,d),f=Qi(u,m),y=Qi(d,v);return Ki(f,o)<Ki(y,o)?"rotate":"scale"}(e,e.plane,s.origin,this.tool.view.state.camera);if(y(i)){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}s.mode=i}}switch(s.mode){case"rotate":this.adapter.angle=s.initialAngle+a;break;case"scale":this.adapter.scale=n,this.onScaleChanged()}switch(this.updateDragState(),this.updateManipulatorTransform(),e.action){case"start":case"update":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:Xi(s.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,xScale:n,yScale:n})}break;case"end":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:Xi(s.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:n,yScale:n});break;default:case"none":}}"end"===e.action&&(this.startAnimation(Rn(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState())})),a.next((()=>{if(this.adapter.cancel(),y(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:1,yScale:1})}this.startAnimation(Rn(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState()}}))}));this._handles.add(i),this._handles.add([this.ringManipulator.events.on("focus-changed",(e=>{"focus"===e.action?this.startAnimation(function(e,t){let i=0,a=null;const s=()=>!1;return{start:()=>{a=e.getFocused,e.getFocused=s,i=0,t()},update:e=>(i+=e,!a()||i>200?1:0),destroy:()=>{e.getFocused=a,t()}}}(this,(()=>this.updateDelayedFocusedState()))):this.updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(e=>{e.stopPropagation()})),je(this.tool.graphicState,"displaying",(e=>this.ringManipulator.available=e))])}onScaleChanged(){this.events.emit("scale-changed"),this.updateManipulatorTransform()}updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(On.DelayedFocused,this.getFocused())}updateDragState(){if(this.ringManipulator.updateStateEnabled(On.Unlocked,!(y(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),y(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(On.ScaleIn|On.ScaleOut,!1),this.ringManipulator.updateStateEnabled(On.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(On.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(On.RotateLeft|On.RotateRight,!1),this.ringManipulator.updateStateEnabled(On.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(On.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(On.ScaleIn|On.ScaleOut|On.RotateLeft|On.RotateRight,!1)}updateManipulatorTransform(){const e=At(Ct.get()),t=this.adapter.angle;di(e,e,t,ui(0,0,1));const i=this.getScale(),a=gi(Ct.get(),A(Ue.get(),i,i,i)),s=At(Ct.get());xt(s,a,e),this.ringManipulator.modelTransform=s}createRingManipulator(){const e=(e,t,i)=>{const a=[],s=Math.ceil(128*(t-e)/(2*Math.PI));for(let r=0;r<s+1;r++){const n=e+r*(t-e)/s;a.push(ui(i*Math.cos(n),i*Math.sin(n),0))}return a},t=t=>e(0,2*Math.PI,t),i=(e,t)=>Ae.createPathExtrusionGeometry((e=>[[-e/2,0],[e/2,0],[e/2,.25],[-e/2,.25]])(t),e,[],[],!1),a=t(160),s=i(a,24),r={left:[],right:[]},n=[];for(let w=0;w<2;w++){const t=w*Math.PI-Math.PI/4,a=Math.PI/2-Lr,s=t+a,o=t+Math.PI/2-a,l=e(s,o,190),h=i(l,9);n.push(l),n.push(e(s,o,201)),r.left.push(h),r.right.push(h);for(let e=0;e<2;e++){const t=0===e,i=Qe();if(t){fi(i,i,[1,-1,1]),di(i,i,-s,[0,0,1]);const e=Math.round(.2*(l.length-1));i[12]=l[e][0],i[13]=l[e][1],i[14]=l[e][2]}else{di(i,i,o,[0,0,1]);const e=Math.round(.8*(l.length-1));i[12]=l[e][0],i[13]=l[e][1],i[14]=l[e][2]}const a=Ae.createExtrudedTriangle(60,0,23,.5);Ae.transformInPlace(a,i),(t?r.left:r.right).push(a)}}const o=[];for(let w=0;w<2;w++){const t=w*Math.PI-Math.PI/4,a=Math.PI/2-Fr,s=t+a,r=t+Math.PI/2-a,n=e(s,r,213);o.push(i(n,9))}const l=t(190),h=t(213),c=i(l,9),p=i(h,9),d=t(130),u=t(107),g=i(d,9),m=i(u,9),v=this.createMaterial(),f=this.createMaterial(.66),y=this.createMaterial(.5),_=this.createMaterial(.33);let M=[{geometry:s,material:v,stateMask:On.DelayedFocused},{geometry:s,material:y,stateMask:0}];this.mode&&"scale"!==this.mode||(M=M.concat([{geometry:o,material:v,stateMask:On.DelayedFocused|On.Unlocked},{geometry:c,material:f,stateMask:On.DelayedFocused|On.ScaleIn},{geometry:p,material:_,stateMask:On.DelayedFocused|On.ScaleIn},{geometry:g,material:f,stateMask:On.DelayedFocused|On.ScaleOut},{geometry:m,material:_,stateMask:On.DelayedFocused|On.ScaleOut}])),this.mode&&"rotate"!==this.mode||(M=M.concat([{geometry:r.right,material:v,stateMask:On.DelayedFocused|On.Unlocked},{geometry:r.left,material:v,stateMask:On.DelayedFocused|On.RotateLeft},{geometry:r.right,material:v,stateMask:On.DelayedFocused|On.RotateRight}]));const b=[a,...n];return new ir({view:this.tool.view,renderObjects:M,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:Lt(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:b,direction:ui(0,0,1)}})}createMaterial(e=1){const t=[...Ir,e];return new Pt({color:t,transparent:1!==e,cullFace:2,renderOccluded:2})}get test(){return{ringManipulator:this.ringManipulator}}}function An(e,t,i){return t.projectToScreen(e,Pn),A(i,Pn[0],Pn[1],0)}function Rn(e,t){let i=null,a=1;const s=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=s,t()},update:e=>(a+=((a+1)/2-a)*Math.min(3*e,1),t(),Math.abs(a-1)<.01?1:0),destroy:()=>{e.getScale=i,t()}}}const Pn=Ke();function Tn(e){return y(e.geometry)&&"mesh"===e.geometry.type?function(e){return y(e.transform)?function(e,t){let i=t.clone(),a=null;return{undo:t=>{a=y(e.transform)?e.transform.clone():null,e.transform=i,t.notifyGeometryChanged()},redo:t=>{i=y(e.transform)?e.transform.clone():null,e.transform=a,t.notifyGeometryChanged()}}}(e,e.transform):function(e){let t,i=e.vertexAttributes.clonePositional();return{undo:a=>{t=e.vertexAttributes.clonePositional(),e.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=e.vertexAttributes.clonePositional(),e.vertexAttributes=t,a.notifyGeometryChanged()}}}(e)}(e.geometry):function(e){let t=e.geometry,i=Ji;return{undo(e){i=e.geometry,e.geometry=t},redo(e){t=e.geometry,e.geometry=i}}}(e)}let Cn=class extends Li{constructor(e){super(e),this.angle=0,this.scale=1,this.initialAngle=0,this.previousAngle=0,this.previousScale=1}initialize(){this.restart()}restart(){this.handles.remove(zn);const e=this.geometry.transform;if(this.scale=1,y(e)){const t=rs(e.rotation)[2];Math.abs(t)>.999999&&(this.angle=Gt(ns(e.rotation))*Math.sign(t))}this.initialAngle=this.angle,this.previousAngle=this.angle,this.previousScale=this.scale,this.handles.add($i((()=>({angle:this.angle,scale:this.scale})),(e=>this.update(e))),zn)}cancel(){this.scale=1,this.angle=this.initialAngle}createUndoRecord(){return Tn(this.graphic)}update({scale:e,angle:t}){const i=this.geometry.anchor,a=1===this.viewingMode;e!==this.previousScale&&(this.geometry.scale(e/this.previousScale,{origin:i,geographic:a}),this.previousScale=e,this.graphic.notifyGeometryChanged()),t!==this.previousAngle&&(this.geometry.rotate(0,0,Xi(t-this.previousAngle),{origin:i,geographic:a}),this.previousAngle=t,this.graphic.notifyGeometryChanged())}};g([m({constructOnly:!0})],Cn.prototype,"graphic",void 0),g([m({constructOnly:!0})],Cn.prototype,"geometry",void 0),g([m({constructOnly:!0})],Cn.prototype,"viewingMode",void 0),g([m()],Cn.prototype,"angle",void 0),g([m()],Cn.prototype,"scale",void 0),Cn=g([v("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],Cn);const zn="scale-heading-update-key";let In=class extends Li{constructor(e){super(e),this.angle=0,this.scale=1,this.symbol=null,this.initialAngle=0}initialize(){this.restart()}restart(){this.handles.remove(Hn);const e=y(this.graphic.symbol)&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:Ji;if(this.symbol=y(e)?e.clone():null,this.initialSizes=[],y(e)){const t=this.findLayerView();y(t)&&(this.initialSizes=e.symbolLayers.map((i=>"object"===i.type?t.getSymbolLayerSize(e,i):null)).toArray())}this.angle=0,y(e)&&e.symbolLayers.some((e=>!("object"!==e.type||!y(e.heading)||(this.angle=-Gt(e.heading),0)))),this.initialAngle=this.angle,this.scale=1,this.handles.add($i((()=>({angle:this.angle,scale:this.scale})),(e=>this.updateSymbol(e))),Hn)}cancel(){this.graphic.symbol=this.symbol}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:i=>{t=i.symbol,i.symbol=e,this.restart()},redo:i=>{e=i.symbol,i.symbol=t,this.restart()}}}updateSymbol({scale:e,angle:t}){const i=this.graphic.symbol;if(_(this.symbol)||_(i)||"point-3d"!==i.type)return;const a=i.clone(),s=-Xi(t-this.initialAngle);let r=!1;this.forEachObjectSymbolLayerPair(this.symbol,a,((t,i,a)=>{const n=Te(t.heading,0)+s;i.heading!==n&&(i.heading=n,r=!0);const o=this.initialSizes[a];if(y(o)&&"width"in o){o.width=this.sizeFilter(o.width),o.height=this.sizeFilter(o.height),o.depth=this.sizeFilter(o.depth);const t=o.width*e;i.width!==t&&(i.width=t,r=!0);const a=o.depth*e;i.depth!==a&&(i.depth=a,r=!0);const s=o.height*e;i.height!==s&&(i.height=s,r=!0)}})),r&&(this.graphic.symbol=a)}forEachObjectSymbolLayerPair(e,t,i){e.symbolLayers.forEach(((e,a)=>{const s=t.symbolLayers.getItemAt(a);"object"===e.type&&"object"===s.type&&i(e,s,a)}))}};g([m()],In.prototype,"angle",void 0),g([m()],In.prototype,"scale",void 0),g([m({constructOnly:!0})],In.prototype,"graphic",void 0),g([m()],In.prototype,"symbol",void 0),g([m({constructOnly:!0})],In.prototype,"findLayerView",void 0),g([m({constructOnly:!0})],In.prototype,"sizeFilter",void 0),In=g([v("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],In);const Hn="scale-heading-update-key";let Vn=class extends(Re(w.EventedMixin(Pe))){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.scaleRotate=null,this.snappingPipeline=new xi}initialize(){this.graphicState=new Qs({graphic:this.graphic}),this.moveManipulation=new nn({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&xr(this.graphic),radius:nn.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",l(o({},e),{graphic:this.graphicState.graphic})),e.stopPropagation()}))))),this.moveManipulation.elevationInfo=Lt(this.graphic);const e=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>(y(e)&&0===t&&(a=a.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new Ai({elevationInfo:Lt(this.graphic),pointer:r,geometry:Ri.fromGeometry(new Xe({spatialReference:e.spatialReference}),this.view.viewingMode),visualizer:new Pi,excludeFeature:this.graphic}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:s}),this.snappingPipeline.next)),a)),this.graphicState,(e=>{const{action:t,graphic:i,dxScreen:a,dyScreen:s}=e,r={graphic:i,dxScreen:a,dyScreen:s};switch(t){case"start":this.emit("graphic-translate-start",r),this.emit("record-undo",{record:this.createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",r);break;case"end":this.emit("graphic-translate-stop",r)}})),this.moveManipulation.angle=y(this.scaleRotate)?this.scaleRotate.angle:0,this.scaleRotateAdapter=this.createScaleRotateAdapter(),this.handles.add(this.scaleRotateAdapter.watch("angle",(()=>this.updateMoveAngle()))),this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new Gn({tool:this,mode:e,adapter:this.scaleRotateAdapter}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this.onScaleChanged())))}this.handles.add([zr({view:this.view,graphic:this.graphic,forEachManipulator:e=>this.forEachManipulator(e),onManipulatorsChanged:()=>Oi()}),this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this.updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this.onGeometryChanged(),this.updateMoveAngle(),this.forEachManipulator((e=>{e instanceof ir&&this.handles.add(e.events.on("grab-changed",(()=>this.updateManipulatorsInteractive())))})),this.complete()}updateManipulatorsInteractive(){_(this.scaleRotate)||(this.scaleRotate.interactive=!this.moveManipulation.grabbing,this.moveManipulation.interactive=!this.scaleRotate.grabbing)}createScaleRotateAdapter(){return y(this.graphic.geometry)&&"mesh"===this.graphic.geometry.type?new Cn({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new In({graphic:this.graphic,sizeFilter:e=>this.enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find((e=>e.layer===this.graphic.layer))})}forEachManipulator(e){this.moveManipulation.forEachManipulator(e),y(this.scaleRotate)&&this.scaleRotate.forEachManipulator(e)}hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(e=>{this.forEachManipulator((t=>t.available=e)),this.moveManipulation.zManipulation.available=e&&this.enableZ&&xr(this.graphic)}))}createGeometryUndoRecord(){return Tn(this.graphic)}destroy(){this.moveManipulation.destroy(),this.scaleRotate=Le(this.scaleRotate),this.scaleRotateAdapter=Le(this.scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}set snapToScene(e){this.moveManipulation&&(this.moveManipulation.snapToScene=e),this._set("snapToScene",e)}get updating(){return this.updatingHandles.updating}set location(e){this.moveManipulation.location=e,y(this.scaleRotate)&&(this.scaleRotate.location=e)}set elevationAlignedLocation(e){this.moveManipulation.elevationAlignedLocation=e,y(this.scaleRotate)&&(this.scaleRotate.elevationAlignedLocation=e)}reset(){}onDetach(){y(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onHide(){y(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onScaleChanged(){if(_(this.scaleRotate))return;const e=this.scaleRotate.getScale();this.moveManipulation.displayScale=e}updateMoveAngle(){"local"===this.view.viewingMode||this.view.scale<1e6?this.moveManipulation.angle=this.scaleRotateAdapter.angle:this.moveManipulation.angle=0}onGeometryChanged(){Sr(this.view,this,this.graphic)}enforceNonZeroSize(e){return e||this.view.state.camera.computeRenderPixelSizeAt(this.moveManipulation.renderLocation)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,zManipulator:this.moveManipulation.zManipulation.test.manipulator,ringManipulator:y(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};g([m({constructOnly:!0,nonNullable:!0})],Vn.prototype,"view",void 0),g([m({constructOnly:!0,nonNullable:!0})],Vn.prototype,"graphic",void 0),g([m({constructOnly:!0,nonNullable:!0})],Vn.prototype,"enableZ",void 0),g([m()],Vn.prototype,"enableRotation",void 0),g([m()],Vn.prototype,"enableScaling",void 0),g([m({value:!1})],Vn.prototype,"snapToScene",null),g([m({constructOnly:!0})],Vn.prototype,"snappingManager",void 0),g([m({readOnly:!0})],Vn.prototype,"type",void 0),g([m({readOnly:!0})],Vn.prototype,"updating",null),Vn=g([v("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],Vn),bi("mac");const Ln=[1,.5,0],Fn=[...Ln,1],kn=[1,1,1,1],jn=[1,.8,.6,1],Bn=[1,.93,.86,1],Un=[...Ln,1],Wn=[...Ln,1];function qn(){const e=new W;return e.extensions.add("GL_OES_standard_derivatives"),e.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),e.varyings.add("vUV","vec2"),e.vertex.code.add(U`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),e.fragment.uniforms.add("backgroundColor","vec4").add("gridColor","vec4").add("ratio","float").add("gridWidth","float"),e.fragment.code.add(U`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),e}var Zn=Object.freeze({__proto__:null,build:qn});class Nn extends ${initializeProgram(e){const t=Nn.shader.get().build();return new ee(e.rctx,t,ea)}bindPass(e,t){te(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("backgroundColor",e.backgroundColor),this.program.setUniform4fv("gridColor",e.gridColor),this.program.setUniform1f("gridWidth",e.gridWidth)}bindDraw(e){ae(this.program,e),this.program.rebindTextures()}initializePipeline(){return ne({blending:ta(1,1,771,771),depthTest:{func:513},colorWrite:de})}}Nn.shader=new ge(Zn,(()=>import("./SlicePlaneMaterial.glsl.31176afe.js")));function Yn(e){const t=new W;return t.include(q,{linearDepth:!1}),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.uniforms.add("textureCoordinateScaleFactor","vec2"),t.vertex.code.add(U`
    void main(void) {
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0 * textureCoordinateScaleFactor;
      gl_Position = transformPosition(proj, view, vpos);
    }
  `),t.include(Z,e),e.multipassTerrainEnabled&&(t.fragment.include(Y),t.include(X,e)),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("opacity","float"),t.varyings.add("vTexCoord","vec2"),7===e.output?t.fragment.code.add(U`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

      float alpha = texture2D(tex, vTexCoord).a * opacity;
      if (alpha  < ${U.float(aa)}) {
        discard;
      }

      gl_FragColor = vec4(alpha);
    }
    `):(t.fragment.include(N),t.fragment.code.add(U`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      gl_FragColor = texture2D(tex, vTexCoord) * opacity;

      if (gl_FragColor.a < ${U.float(aa)}) {
        discard;
      }

      gl_FragColor = highlightSlice(gl_FragColor, vpos);
      ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    }
    `)),t}g([ia()],class extends Me{constructor(e){super(e),this._technique=new Nn(this._techniqueRep.constructionContext,null),this.updateParameters()}updateParameters(){}beginSlot(e){return 8===e}bind(e){this._technique.bindPass(this._material.params,e)}}.prototype,"_technique",void 0);var Xn=Object.freeze({__proto__:null,build:Yn});class Qn extends ${initializeProgram(e){const t=Qn.shader.get(),i=this.configuration,a=t.build({output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,OITEnabled:0===i.transparencyPassType,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new ee(e.rctx,a,ea)}bindPass(e,t){te(this.program,t.camera.projectionMatrix),this.program.setUniform1f("opacity",e.opacity),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),ie(this.program,t))}bindDraw(e){ae(this.program,e),re(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e,t){const i=this.configuration,a=3===e,s=2===e;return ne({blending:0!==i.output&&7!==i.output||!i.transparent?null:a?Kn:le(e),culling:he(i.cullFace),depthTest:{func:ra(e)},depthWrite:a?i.writeDepth&&ce:pe(e),colorWrite:de,stencilWrite:i.sceneHasOcludees?na:null,stencilTest:i.sceneHasOcludees?t?oa:la:null,polygonOffset:a||s?null:ha(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}Qn.shader=new ge(Xn,(()=>import("./ImageMaterial.glsl.a6cf93d8.js")));const Kn=sa(1,771);class Jn extends J{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}g([K({count:8})],Jn.prototype,"output",void 0),g([K({count:3})],Jn.prototype,"cullFace",void 0),g([K()],Jn.prototype,"slicePlaneEnabled",void 0),g([K()],Jn.prototype,"transparent",void 0),g([K()],Jn.prototype,"enableOffset",void 0),g([K()],Jn.prototype,"writeDepth",void 0),g([K()],Jn.prototype,"sceneHasOcludees",void 0),g([K({count:4})],Jn.prototype,"transparencyPassType",void 0),g([K()],Jn.prototype,"multipassTerrainEnabled",void 0),g([K()],Jn.prototype,"cullAboveGround",void 0);class $n extends ye{constructor(e){super(e,to),this.supportsEdges=!0,this.techniqueConfig=new Jn}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<ca,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,a,s,r,n){_e(e,t,a,s,r,void 0,n)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output?new eo(e):void 0}createBufferWriter(){return new pa(da)}}class eo extends ua{constructor(e){super(o(o({},e),e.material.params)),this.updateParameters()}updateParameters(e){const t=this._material.params;this.updateTexture(t.textureId),this._technique=this._techniqueRep.releaseAndAcquire(Qn,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){return 4===this._output?3===e:e===(this._technique.configuration.transparent?this._technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters(e))}ensureParameters(e){0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e){this.bindTextures(this._technique.program),this.bindTextureScale(this._technique.program),this._technique.bindPass(this._material.params,e)}getPipelineState(e,t){return this._technique.getPipelineState(t)}}const to=o({transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,opacity:1,textureId:null,initTextureTransparent:!0},fe);var io;let ao=io=class extends ma{constructor(e){super(e),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}clone(){return new io({position:va(this.position),heading:this.heading,tilt:this.tilt,width:this.width,height:this.height})}equals(e){return this.heading===e.heading&&this.tilt===e.tilt&&y(this.position)&&y(e.position)&&this.position.equals(e.position)&&this.width===e.width&&this.height===e.height}};function so(e,t,i,a){const s=a.worldUpAtPosition(i.origin,Ue.get()),r=function(e,t){switch(t){case 0:return{basis:e.basis1,direction:1,position:T(Ue.get(),e.origin,e.basis1),edge:t};case 1:return{basis:e.basis2,direction:1,position:T(Ue.get(),e.origin,e.basis2),edge:t};case 2:return{basis:e.basis1,direction:-1,position:Ze(Ue.get(),e.origin,e.basis1),edge:t};case 3:return{basis:e.basis2,direction:-1,position:Ze(Ue.get(),e.origin,e.basis2),edge:t}}}(i,0),n=At(Ct.get());Ma(n,n,r.edge*Math.PI/2),vi(n,n,-function(e,t){return ba(t,e.basis2,e.basis1)+go}(i,s)),xt(n,t,n),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=r.position}function ro(e){const t=$t(e.basis1),i=$t(e.basis2);return.3*Math.min(t,i)}function no(e){return ro(e)}function oo(e){return 0!==e.direction[0]&&0!==e.direction[1]}function lo(e,t=1){const i=0===t?40:0,a=[ui(i,0,-24),ui(i,0,24)],s=function(e,t){const i=Ze(B(),e[e.length-1],e[e.length-2]);if(ve(i,i),C(i,i,12),T(i,i,e[e.length-1]),t){const t=Ze(B(),e[0],e[1]);return ve(t,t),C(t,t,12),T(t,t,e[0]),[t,...e,i]}return[...e,i]}(a,!0),r=(e,t)=>function(e,t,i){const a=a=>{const s=(a?t:e).slice(0),r=Ze(Ue.get(),s[0],s[1]);ve(r,r);const n=Ze(Ue.get(),s[s.length-1],s[s.length-2]);if(ve(n,n),i.padding>0){const e=C(B(),n,-i.padding);if(s[s.length-1]=T(e,e,s[s.length-1]),i.bothEnds){const e=C(B(),r,-i.padding);s[0]=T(e,e,s[0])}}const o=a?i.tipFocusMultiplier:1,l=i.tipLength*(i.focusTipLength?o:1),h=i.tipRadius*o,c=At(Ct.get());if(i.padding>0){const e=l/4,t=A(Ue.get(),0,e,0),a=1+i.padding/e;mi(c,c,t),fi(c,c,A(Ue.get(),a,a,a)),mi(c,c,C(t,t,-1/a))}const p=At(Qe()),d=ui(0,1,0),u=Sa(Qe(),xa(Ea.get(),d,n));u[12]=s[s.length-1][0],u[13]=s[s.length-1][1],u[14]=s[s.length-1][2],xt(u,u,c);const g=[{part:"tube",geometry:co(i.tubeRadius*(a?i.tubeFocusMultiplier:1)+i.padding,i.flat,s),transform:p}];let m,v;if(y(i.flat)?m=Ae.createExtrudedTriangle(l,h,h,i.flat.thickness):(m=Ae.createConeGeometry(l,h,24,!1,!1,!0),v=Ae.createConeGeometry(l,h,24,!1,!0,!1)),g.push({part:"tip",geometry:m,transform:u}),v&&g.push({part:"cap",geometry:v,transform:u}),i.bothEnds){const e=Sa(Qe(),xa(Ea.get(),d,r));e[12]=s[0][0],e[13]=s[0][1],e[14]=s[0][2],xt(e,e,c),g.push({part:"tip",geometry:m,transform:e}),v&&g.push({part:"cap",geometry:v,transform:e})}return g};return{normal:a(!1),focused:a(!0)}}(a,a,{tubeRadius:3,tipRadius:11,tipLength:22.5,tubeFocusMultiplier:1.15,tipFocusMultiplier:1.15,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t}),n=r(0,!1),o=r(2.25,!0),l=new Pt({color:kn,cullFace:2,renderOccluded:16}),h=new Pt({color:jn,cullFace:2,renderOccluded:16}),c=new Pt({color:Bn,cullFace:2,renderOccluded:16}),p=new Pt({color:Wn,transparent:!0,writeDepth:!1,cullFace:1,renderOccluded:2}),d=Ae.createPolylineGeometry([[i,0,0],[i-40,0,0]]),u=Ae.createPolylineGeometry([[i,0,0],[i-40,0,0]]),g=new Ka({color:Un,renderOccluded:4});return new ir({view:e,renderObjects:[...n.normal.map((({part:e,geometry:t,transform:i})=>({geometry:t,material:"tip"===e?l:"cap"===e?h:c,transform:i,stateMask:1|po}))),...o.normal.map((({geometry:e,transform:t})=>({geometry:e,material:p,transform:t,stateMask:1|po}))),{geometry:d,material:g,stateMask:1|po|uo},...n.focused.map((({part:e,geometry:t,transform:i})=>({geometry:t,material:"tip"===e?l:"cap"===e?h:c,transform:i,stateMask:2|po}))),...o.focused.map((({geometry:e,transform:t})=>({geometry:e,material:p,transform:t,stateMask:2|po}))),{geometry:u,material:g,stateMask:2|po|uo}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:11,state:po})}function ho(e,t){const i=oo(t),a=i?[ui(1,0,0),ui(0,0,0),ui(0,1,0)]:[ui(1,0,0),ui(-1,0,0)],s=Ae.createPolylineGeometry(a),r=[...Ln,1],n=i?4:1,o=2*n,l=e=>e>1?(e=>new z({color:r,width:e,renderOccluded:4}))(e):new Ka({color:r,renderOccluded:4}),h=[{geometry:s,material:l(n),stateMask:1|mo},{geometry:s,material:l(o),stateMask:2|mo},{geometry:s,material:l(1),stateMask:vo}],c=new ir({view:e,renderObjects:h,collisionType:{type:"line",paths:[a]},autoScaleRenderObjects:!1,worldSized:!0,radius:i?6:4,idHint:i?1:2});return c.state=mo,c}function co(e,t,i){const a=[];if(y(t))a.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else{const t=12;for(let i=0;i<t;i++){const s=i/t*2*Math.PI;a.push([Math.cos(s)*e,Math.sin(s)*e])}}return Ae.createPathExtrusionGeometry(a,i,[],[],!1)}g([m({readOnly:!0,json:{read:!1,write:!0}})],ao.prototype,"type",void 0),g([m({type:Xe}),cs()],ao.prototype,"position",void 0),g([m({type:Number,nonNullable:!0,range:{min:0,max:360}}),cs(),ga((e=>fa.normalize(ya(e),0,!0)))],ao.prototype,"heading",void 0),g([m({type:Number,nonNullable:!0,range:{min:0,max:360}}),cs(),ga((e=>fa.normalize(ya(e),0,!0)))],ao.prototype,"tilt",void 0),g([m({type:Number,nonNullable:!0}),cs()],ao.prototype,"width",void 0),g([m({type:Number,nonNullable:!0}),cs()],ao.prototype,"height",void 0),ao=io=g([v("esri.widgets.Slice.SlicePlane")],ao),_a.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");const po=16,uo=32;We();const go=Math.PI/2,mo=16,vo=32;class fo{constructor(){this.lastDragEvent=null,this.next=new Jt,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&y(this.lastDragEvent)){const t=l(o({},this.lastDragEvent),{action:"update"});e&&this.adjustScaleFactors(t),this.next.execute(t)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent="end"!==e.action?o({},e):null,this._enabled&&this.adjustScaleFactors(e),e)}adjustScaleFactors(e){const t=oo(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):0===e.handle.direction[0]?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-t:t,e.factor2=e.factor2<0?-t:t}get test(){return{adjustScaleFactors:e=>this.adjustScaleFactors(e)}}}function yo(e,t){return Mo(e,t,!1)}function _o(e,t){return Mo(e,t,!0)}function Mo(e,t,i){if(e instanceof Ra){if(e.operation instanceof Pa)return function(e,t,i=!1){const a=i?-1:1,s=ui(a*e.dx,a*e.dy,a*e.dz);T(t.origin,t.origin,s)}(e.operation,t,i),!0;if(e.operation instanceof Ta)return function(e,t,i=!1){const a=i?-e.angle:e.angle;za(t.basis1,t.basis1,ut,a),za(t.basis2,t.basis2,ut,a)}(e.operation,t,i),!0;if(e.operation instanceof Ca)return function(e,t,i=!1){const a=i?1/e.factor1:e.factor1,s=i?1/e.factor2:e.factor2;C(t.basis1,t.basis1,a),C(t.basis2,t.basis2,s),bo(t.origin,e.origin,e.axis1,a),bo(t.origin,e.origin,e.axis2,s)}(e.operation,t,i),!0}return!1}function bo(e,t,i,a){const s=Kt.get(),r=Oa(s,e,t),n=Ga(s,i,Ia(i,r));Ha(e,e,n,a-1)}let wo=class extends(w.EventedMixin(Pe)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this._preserveAspectRatio=new fo,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new ri,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=ls(),this.mapBoundsStart=ls(),this.displayBounds=ls(),this.displayBoundsStart=ls(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}]}initialize(){this.graphicState=new Qs({graphic:this.graphic});const e=this.graphic.geometry;this.editGeometryHelper=Ri.fromGeometry(e,this.view.viewingMode),this.graphicMoveManipulation=new ln({tool:this,view:this.view,graphicState:this.graphicState}),this.handles.add(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=lo(this.view,0),this.moveZManipulator.state|=uo,this.handles.add(this.watch("enableZ",(()=>this.updateManipulatorAvailability(this.moveZManipulator,0)))),this.handles.add(this._createMoveZDragPipeline()),this.manipulators.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map((e=>{const t=ho(this.view,e);return this.handles.add(this.watch("enableScaling",(()=>this.updateManipulatorAvailability(t,2)))),t.events.on("grab-changed",(e=>this._onResizeGrab(e))),this.handles.add(this._createResizeDragPipeline(t,e)),t})),this.manipulators.addMany(this.resizeManipulators),this.rotateManipulatorTexture=new Fa("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAACuFBMVEUAAAD/AAD/gAD/VQD/gAD/bQD/gAD/cQD/gAD/dAD/eAD/gAD/gAD/egD/gAD/ewD/gAD/fAD/gAD/fQD/gAD/fQD/fQD/egD/fQD/gAD/fQD/ewD/fQD/gAD/gAD/fQD/fAD/gAD/fgD/fgD/fAD/fgD/fAD/fgD/fAD/fgD/fAD/gAD/fgD/fAD/fQD/fgD/fgD/fQD/fgD/fgD/fQD/fgD/fQD/fQD/fgD/fgD/fQD/fQD/fgD/fQD/fgD/fQD/fgD/fQD/fgD/fgD/fgD/gAL/gAT/gAb/gQj/gwr/hAz/hA7/hxH/iBP/iRf/ixn/jBz/jR7/jyP/kCX/kyr/lCz/lS7/li//mTT/mTf/mjn/nDr/nTz/nT//n0H/oEL/oET/oEX/okf/o0r/o0v/pU3/pU//plH/qFL/qFP/qFX/qVb/q1n/rFz/rV3/rl7/rmD/rmH/sGL/s2v/tW3/tW7/tW//tnD/t3L/uHT/unb/unf/unn/vHv/vX3/vX7/v4D/w4n/xIv/xY3/xY3/x4//x5H/x5H/yZP/yJP/yZX/y5f/y5n/zZv/zJv/zZ3/z5//z6D/z6H/0KP/0aT/0qb/06j/06r/1av/1q3/1q//17H/2rb/2rb/2rj/3bz/38D/4MH/38H/4MT/4sX/4sb/48f/4sf/5Mr/5cz/5s3/5s3/59D/59D/6dP/6dT/6dT/6tX/6tb/6tf/69j/69n/7Nn/7dr/7dv/7dz/7t3/7t3/7t7/7+H/8eL/8eP/8uX/8+f/8+j/8+j/9On/9Or/9ez/9ez/9e3/9e3/9+7/9+//9+//+PD/+PD/+PH/+PH/+fL/+fT/+fT/+vX/+vX/+vb/+vb/+/b/+/j/+/j//Pn//Pr//fv//fv//fz//vz//v3//fz//v3//v3//v7///////9yfVyKAAAA53RSTlMAAQIDBgcICQoLERIYGRobKCkqKywtLzAxMjM4OTo+P0BAQUVGR0hPUFFSUlNUWlthYmNlZmdoamtvcHR1dnd4eXx9f4CAgYGCgoODhIWGhoeIiYqLjIyNjo+QkJGSkpOTlJSVlpaXmJiZmZqbnJydnZ6eoqKjo6Skpaanp6ipqqqvsLCxsbKzs7S1tbe3uLi5uru8vL2+wMDBwsTGx8jLzc3O0NDR0dLT1dXW19ja2tvc3N3e3t/f4ODh4uLl5ufn6urr6+zt7u7v8PDx8fLy8/P09fX29vf3+Pn6+vv8/Pz8/f3+/v7EBDCzAAADsUlEQVQYGZXBiUMUZRgH4JfW5fRosegCVoG10lVRgWUNBt39IUKSmAZdYpeVZYdm2Z2VpdGhkZ0WqWVSGVlWdtJNKWaUBZUlpcj7b7TfLDvfN8ssO/M8lEhG9oSppUEtFNKCpX5vdgY5Ms4XCMMkHPCNJZvceeWwVJ7npuTSCjQkpE1MoyRyKjAi7awUGkHWTCQ1I4sS8lTBhjmnkLWUSbDJl0IWXH7Y5nfRMK7pGNKI5Ka5KN65iPlwNZLzp5DZJMQsH/xyHpIrIpPxMLzOvB7C1Y+3dXR2ftHx8qPLYeFUUmRVIaapn/nXBixt289S19ZmxKvKJGkmDC9xxLb2ATYb2NmMOMVkOAOG+t854r9/eZjjz9fA7DQaklYJQwvrutjCJxfDpCKVogpgqP6Oo/5g3c89fYNsOLgUJl7SuTUY7uEhPcyft16/AMAFK7d08pBDy6DS3CTkQdrHMR+vhHTz+xz1YwNUuSQEYFjBhr7FUK3rY91bUJVTxDhIb7D0Kkyau1m3HqoxROSDoamfpYFrYXJZNws99VAUEVEAhmWb2978rPsYR+2D2Y39LDwDRRlRRhhxqi+64e6WF1/b+81amLWycHg+pHA6ZcO2uv0s3AmFhybCvsdY2AmFl6bCvkVHOaIHiilUAgf2sLAE0iyaDQdeYOEOSEHS4MA6Fh6GVEkhOHA7Cy2Q5lIIDqxmYTOkuaTBgftY2AipkmbDgSdZuAtSkErgwC4WroE0i/ywr/oXjjhyPqTJNAEmCx/66BYksoaFDijyKRtSzdpdfzPvRiJ7WXgCCg9lhGG49DhHnFgFa2tYONoIKZxOFIDUzsL3C2Bl4QEWtkNRSkQ+SCsGWXi7BsPV7mHhxJVQFBLRWCi2s27HfMSra2fdK1CNpogApIafWPfBhTBb8inruuqhKCchD4rbjrHu8CPzINW09LLun1uhyiXBrUHx4CBH/dB6CaIuf/YARw3cD5XmJl0BVJsGOebg7m1bd7xziGMGNsDES1FpFVA9cISt/XUvTM5LpSGnw+S6r9nKV1fBLIcMM2BSu+lPjtfbUgOzYpKyqmC2+OkuVn371CLEqcokRTbiVa967r1eFn57d8tN1RjGQyY+WKlruqKxFpYKKc45cMSfQnFc0+HANBcNc9LZsG2yi6wUwZ5wISVwsgYb5oynhDKLkVRxJo0kpwIj0s6kJFK9GhKq9KZScqNyA7AUyB1FNo0pKgvDJFxWOJocSffk+0uCWiikBUum5HvSKYH/AUiSxpA/XUvpAAAAAElFTkSuQmCC",{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.view._stage&&this.view._stage.add(this.rotateManipulatorTexture),this.rotateManipulator=function(e,t){const i=new $n({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:16}),a=40,s=27*1.1,r=e=>{const t=new Uint32Array([0,1,2,2,3,0]);return new wa([["position",{size:3,data:[a-e,-e,0,a+e,-e,0,a+e,e,0,a-e,e,0],exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1]}]],[["position",t],["uv0",t]])},n=Ae.createPolylineGeometry([[0,0,0],[13,0,0]]),o=Ae.createPolylineGeometry([[0,0,0],[a-s,0,0]]),l=new Ka({color:Fn,renderOccluded:4}),h=[{geometry:r(27),material:i,stateMask:1|po},{geometry:n,material:l,stateMask:1|po},{geometry:r(s),material:i,stateMask:2|po},{geometry:o,material:l,stateMask:2|po}];return new ir({view:e,renderObjects:h,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},collisionPriority:1,radius:13.5,state:po})}(this.view,this.rotateManipulatorTexture),this.handles.add(this.watch("enableRotation",(()=>this.updateManipulatorAvailability(this.rotateManipulator,3)))),this.rotateManipulator.events.on("grab-changed",(e=>{this._onRotateGrab(e)})),this.handles.add(this._createRotateDragPipeline(this.rotateManipulator)),this.manipulators.add(this.rotateManipulator),this.calculateMapBounds(),this.updateDisplayBounds(this.mapBounds);const t=zr({view:this.view,graphic:this.graphic,forEachManipulator:e=>this.forEachManipulator(e),onManipulatorsChanged:()=>Oi()});y(t)&&(this.outlineVisualElement=t.visualElement instanceof Rs?t.visualElement:null),y(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",(()=>this.updateDisplayBounds(this.mapBounds)))),this.handles.add(t),this.handles.add([this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.graphicState.watch("displaying",(()=>this.updateAllManipulatorAvailability())),je(this.graphicState,"isDraped",(()=>this.graphicDrapedChanged())),this.view.trackGraphicState(this.graphicState)]);const i=this.view.pointsOfInterest;i&&this.handles.add(i.focus.watch("location",(()=>this.updateDisplayBounds(this.mapBounds))));const a=e=>{this.handles.add(e.events.on("grab-changed",(()=>{this.grabbing=e.grabbing,this.updateAllManipulatorAvailability()})))};this.forEachManipulator(a),this.graphicMoveManipulation.forEachManipulator(a);const s=(e,t)=>{this.handles.add(e.events.on("immediate-click",(e=>{1===t&&this.emit("immediate-click",l(o({},e),{graphic:this.graphic})),e.stopPropagation()})))};this.forEachManipulator(s),this.graphicMoveManipulation.forEachManipulator(s),this.onGeometryChanged(),this.updateAllManipulatorAvailability(),this.complete()}graphicDrapedChanged(){this.handles.remove(So),this.updateDisplayBounds(this.mapBounds),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",(e=>{y(this.attachmentOrigin)&&Nt(e.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this.updateDisplayBounds(this.mapBounds)})),So)}updateAllManipulatorAvailability(){this.forEachManipulator(((e,t)=>this.updateManipulatorAvailability(e,t)))}updateManipulatorAvailability(e,t){const i=this.graphicState.displaying,a=this.grabbing&&!e.grabbing;e.interactive=!a;const s=this.enableZ&&xr(this.graphic);switch(t){case 3:e.available=i&&this.enableRotation;break;case 2:e.available=i&&(this.enableScaling||this.enableRotation||s),e.interactive=!a&&this.enableScaling,e.state=this.enableScaling?mo:vo;break;case 0:e.available=i&&s;break;default:e.available=i}}forEachManipulator(e){this.resizeManipulators.forEach((t=>e(t,2))),e(this.rotateManipulator,3),e(this.moveZManipulator,0)}destroy(){this.view._stage&&this.view._stage.remove(this.rotateManipulatorTexture),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryHelper.destroy(),this._set("view",null),this._set("graphic",null)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}reset(){}onDetach(){this.mapBounds=null,this.displayBounds=null}onGeometryChanged(){this.updateDisplayBounds(this.mapBounds)}calculateMapBounds(){const e=this.graphic.geometry,t=this.editGeometryHelper.editGeometry,i=t.components[0].edges[0],a=Oa(Kt.get(),i.left.pos,i.right.pos);ka(a,a);const s=Te(wr(this.view,this.graphic),e.extent.center);let r=Eo*this.view.pixelSizeAt(s);const n=this.view.spatialReference;n!==e.spatialReference&&(r*=ja(n)/ja(e.spatialReference)),function(e,t,i,a){a||(a=ls());const s=Aa(Kt.get(),e[1],-e[0]),r=Aa(Kt.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),n=Aa(Kt.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),o=Kt.get();t.components.forEach((t=>t.vertices.forEach((t=>{const i=t.pos;Aa(o,Ia(e,i),Ia(s,i)),Va(r,r,o),La(n,n,o)}))));const l=1e-6,h=Aa(Kt.get(),n[0]-r[0]<l?i/2:0,n[1]-r[1]<l?i/2:0);Oa(r,r,h),Da(n,n,h),Ga(a.basis1,e,(n[0]-r[0])/2),Ga(a.basis2,s,(n[1]-r[1])/2),Aa(a.origin,r[0]*e[0]+r[1]*s[0],r[0]*e[1]+r[1]*s[1]),Da(a.origin,a.origin,a.basis1),Da(a.origin,a.origin,a.basis2)}(a,t,r,this.mapBounds)}updateDisplayBounds(e){const t=this.graphic.geometry,i=y(this.outlineVisualElement)&&!this.graphicState.isDraped&&y(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:wr(this.view,this.graphic);this.attachmentOrigin=Te(i,t.extent.center);const a=y(i)?i.z:Wt(e.origin,this.view.elevationProvider,F.fromElevationInfo(Lt(this.graphic)),this.view.renderCoordsHelper),s=hs(e);A(s.origin,e.origin[0],e.origin[1],a),function(e,t,i,a=0,s){s||(s=ls()),t.toRenderCoords(e.origin,i,s.origin);const r=Ue.get();T(r,e.origin,e.basis1),T(r,r,e.basis2),t.toRenderCoords(r,i,r);const n=Ue.get();T(n,e.origin,e.basis1),Ze(n,n,e.basis2),t.toRenderCoords(n,i,n);const o=Ue.get();Ze(o,e.origin,e.basis1),Ze(o,o,e.basis2),t.toRenderCoords(o,i,o);const l=Ue.get();Ze(l,e.origin,e.basis1),T(l,l,e.basis2),t.toRenderCoords(l,i,l);const h=Ui(Ue.get(),r,n,.5);Ze(h,h,s.origin);const c=Ui(Ue.get(),o,l,.5);Ze(c,s.origin,c),Ui(s.basis1,h,c,.5);const p=Ui(Ue.get(),l,r,.5);Ze(p,p,s.origin);const d=Ui(Ue.get(),n,o,.5);Ze(d,s.origin,d),Ui(s.basis2,p,d,.5);const u=zt(Ue.get(),s.basis1,s.basis2),g=zt(u,u,s.basis1);ve(g,g),C(s.basis2,g,ii(s.basis2,g)),C(s.basis1,s.basis1,1+a/$t(s.basis1)),C(s.basis2,s.basis2,1+a/$t(s.basis2)),os(s)}(s,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin(),this.displayBounds),this.updateManipulators()}displayBoundsMargin(){const e=this.view.pointsOfInterest,t=e?e.focus.location:this.editGeometryHelper.geometry.extent.center;return xo*this.view.pixelSizeAt(t)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline(((e,t,i)=>this.applyGraphicMoveSteps(t,i)))}_createMoveZDragPipeline(){const e=this.view,t=this.editGeometryHelper.geometry.spatialReference;return ni(this.moveZManipulator,((i,a,s)=>{const r=Ni(i.renderLocation),n=a.next(qr(e,r,t)).next(hi());this.applyGraphicMoveSteps(n,s)}))}applyGraphicMoveSteps(e,t){const i=e.next((e=>("start"===e.action&&(this.inputState={type:"move"},hs(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY})),e))).next(wi()).next(this._moveDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY};switch(e.action){case"start":case"update":(e.mapEnd.x-e.mapStart.x||e.mapEnd.y-e.mapStart.y||e.mapEnd.z-e.mapStart.z)&&this.emit("graphic-translate",t);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",t)}return e}));return t.next((()=>{y(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this.cancel()})),i}_moveDragUpdateGeometry(){return e=>{if(_(this.inputState)||"move"!==this.inputState.type)return e;const t=[];for(const a of this.editGeometryHelper.editGeometry.components)t.push(...a.vertices);const i="start"===e.action?0:1;return yo(this.editGeometryHelper.moveVertices(t,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.mapBounds),this.graphic.geometry=this.editGeometryHelper.geometry,e}}_onResizeGrab(e){if("start"!==e.action)return;const t=this._calculatePickRay(e.screenPoint);ot(this.displayBounds.plane,t,Ue.get())&&(hs(this.displayBounds,this.displayBoundsStart),hs(this.mapBounds,this.mapBoundsStart),this.displayBoundsMarginStart=this.displayBoundsMargin(),this.inputState={type:"resize"})}_createResizeDragPipeline(e,t){return ni(e,((e,i,a)=>{_(this.inputState)||(i.next((e=>("start"===e.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),e))).next(jr(this.view,this.displayBoundsStart.plane)).next((e=>l(o({},e),{handle:t}))).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,xScale:e.factor1,yScale:e.factor2};switch(e.action){case"start":case"update":this.emit("graphic-scale",t);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",t)}return e})),a.next((()=>{y(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this.cancel()})))}))}_resizeDragRenderPlaneToFactors(){return e=>{const t=this.displayBoundsStart,i=e.handle.direction,a=this.displayBoundsMargin(),s=this.displayBoundsMarginStart,r=dt(Ue.get(),t.origin);Ba(r,r,t.basis1,-i[0]),Ba(r,r,t.basis2,-i[1]);const n=Ze(Ue.get(),e.renderEnd,r),h=Ze(Ue.get(),e.renderStart,r),c=oo(e.handle),p=no(t),d=no(this.displayBounds)/p,u=(e,t)=>{if(0===e)return 1;let i=$t(t),r=.5*e*ii(t,n)/i;const o=r<0?-1:1;c&&(r+=(i-.5*e*ii(t,h)/i)*o*d);const l=i<1.5*s?1:Oo;return i=Math.max(i-s,Oo),o>0&&(r-=a),o*Math.max(o*(r/i),l)};return l(o({},e),{factor1:u(i[0],t.basis1),factor2:u(i[1],t.basis2)})}}_resizeDragUpdateGeometry(){return e=>{const t=dt(B(),this.mapBoundsStart.origin);Ba(t,t,this.mapBoundsStart.basis1,-e.handle.direction[0]),Ba(t,t,this.mapBoundsStart.basis2,-e.handle.direction[1]);const i=Aa(Ua(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);ka(i,i);const a=[];for(const n of this.editGeometryHelper.editGeometry.components)a.push(...n.vertices);const s="start"===e.action?0:1,r=this.editGeometryHelper.scaleVertices(a,this.editGeometryHelper.editGeometry.coordinateHelper.fromXYZ(t),i,e.factor1,e.factor2,s,1);return hs(this.mapBoundsStart,this.mapBounds),yo(r,this.mapBounds),this.graphic.geometry=this.editGeometryHelper.geometry,e}}_onRotateGrab(e){if("start"!==e.action)return;const t=function(e,t,i,a){const s=t.worldUpAtPosition(e.origin,Ue.get()),r=Ue.get();switch(i){case 1:dt(r,s);break;case 2:dt(r,e.basis1)}return nt(e.origin,r,a)}(this.displayBounds,this.view.renderCoordsHelper,1,Ye()),i=this._calculatePickRay(e.screenPoint);ot(t,i,Ue.get())&&(hs(this.displayBounds,this.displayBoundsStart),hs(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:t})}_createRotateDragPipeline(e){return ni(e,((e,t,i)=>{const a=this.inputState;_(a)||(t.next((e=>("start"===e.action&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),e))).next(jr(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,angle:Xi(e.rotateAngle)};switch(e.action){case"start":case"update":this.emit("graphic-rotate",t);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",t)}return e})),i.next((()=>{y(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this.cancel()})))}))}_rotateDragRenderPlaneToRotate(e){return t=>{const i=Ii(e.rotatePlane),a=Mr(t.renderStart,t.renderEnd,this.displayBounds.origin,i);return l(o({},t),{rotateAxis:i,rotateAngle:a})}}_rotateDragUpdateGeometry(){return e=>{const t=dt(B(),this.mapBoundsStart.origin),i=[];for(const r of this.editGeometryHelper.editGeometry.components)i.push(...r.vertices);const a="start"===e.action?0:1,s=this.editGeometryHelper.rotateVertices(i,this.editGeometryHelper.editGeometry.coordinateHelper.fromXYZ(t),e.rotateAngle,a,1);return hs(this.mapBoundsStart,this.mapBounds),yo(s,this.mapBounds),this.graphic.geometry=this.editGeometryHelper.geometry,e}}_calculatePickRay(e){const t=We(),i=it(e);return tr(this.view.state.camera,i,t),ve(t.direction,t.direction),t}updateManipulators(){if(!this.visible)return;const e=function(e,t){return br(e.basis1,e.basis2,e.origin,t)}(this.displayBounds,Ct.get());so(this.rotateManipulator,e,this.displayBounds,this.view.renderCoordsHelper),this.updateZMoveHandle(this.moveZManipulator,e),this.resizeManipulators.forEach(((t,i)=>{!function(e,t,i,a){const s=$t(a.basis1),r=$t(a.basis2),n=ro(a),o=no(a),l=A(Ue.get(),0,0,0);T(l,C(Ue.get(),a.basis1,t.direction[0]),C(Ue.get(),a.basis2,t.direction[1])),T(l,a.origin,l);let h=0,c=1;if(oo(t))1===t.direction[0]&&-1===t.direction[1]?h=go:1===t.direction[0]&&1===t.direction[1]?h=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(h=3*Math.PI/2),c=o;else{const e=0!==t.direction[0]?1:2;h=1===e?go:0,c=(1===e?r:s)-n}const p=At(Ct.get());Ma(p,p,h),fi(p,p,A(Ue.get(),c,c,c)),xt(p,i,p),p[12]=0,p[13]=0,p[14]=0,e.modelTransform=p,e.renderLocation=l}(t,this.resizeHandles[i],e,this.displayBounds)}))}updateZMoveHandle(e,t){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:Ze(Ue.get(),i.origin,i.basis1),edge:2},s=Ct.get();Ma(s,t,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}cancel(){const e=this.editGeometryHelper.editGeometry.lastOperation;_(e)||(this.editGeometryHelper.undo(),this.graphic.geometry=this.editGeometryHelper.geometry,_o(e,this.mapBounds),this.updateDisplayBounds(this.mapBounds),this.inputState=null)}get canUndo(){return this.editGeometryHelper.canUndo}undo(){if(y(this.inputState))this.view.activeTool=null;else if(this.canUndo){const e=this.editGeometryHelper.undo();this.graphic.geometry=this.editGeometryHelper.geometry,_o(R(e),this.mapBounds),this.updateDisplayBounds(this.mapBounds)}}get canRedo(){return this.editGeometryHelper.canRedo}redo(){if(this.canRedo){const e=this.editGeometryHelper.redo();this.graphic.geometry=this.editGeometryHelper.geometry,yo(R(e),this.mapBounds),this.updateDisplayBounds(this.mapBounds)}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator}}};g([m({constructOnly:!0,nonNullable:!0})],wo.prototype,"view",void 0),g([m({constructOnly:!0,nonNullable:!0})],wo.prototype,"graphic",void 0),g([m({constructOnly:!0,nonNullable:!0})],wo.prototype,"enableZ",void 0),g([m()],wo.prototype,"enableRotation",void 0),g([m()],wo.prototype,"enableScaling",void 0),g([m()],wo.prototype,"preserveAspectRatio",null),g([m()],wo.prototype,"grabbing",void 0),g([m()],wo.prototype,"inputState",void 0),g([m({readOnly:!0})],wo.prototype,"type",void 0),wo=g([v("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],wo);const So="draped-elevation-changes",xo=10,Eo=80,Oo=1e-6;var Do=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",get DrawGraphicTool(){return Ks},get DrawOperation(){return ze},get GraphicMoveTool(){return dn},get GraphicReshapeTool(){return En},get GraphicTransformTool(){return Vn},get ExtentTransformTool(){return wo}});export{Do as e,qn as r,Yn as s,Is as t};
