import{ae as t,ab as e,am as r,j3 as o,kY as n,fL as s,lk as a,lO as i,li as l,J as c,gA as u,c2 as f,kW as m,gy as p,mO as d,mP as x,mQ as g,s3 as b}from"./vendor.9770a310.js";import{m as v,c as h,y as w,f as y}from"./MeshComponent.39d8495e.js";import{e as C,f as A,t as M,r as j,a as T,n as B}from"./vec33.fc83c3d5.js";import{n as F,l as I,r as O,o as E,a as R,t as S,b as k,g as L,f as D,e as N,h as q,i as G,c as P,d as Q}from"./DefaultMaterial_COLOR_GAMMA.293927da.js";import{k as _}from"./georeference.0e6c263d.js";import"./axisAngleDegrees.427db55f.js";import"./projection.9c98dd23.js";async function z(m,p,d){const x=new F(function(r){return null!=r&&r.resolveFile?{busy:!1,request:async(o,n,s)=>{const a=r.resolveFile(o),i="image"===n?"image":"binary"===n?"array-buffer":"json";return(await t(a,{responseType:i,signal:e(s)?s.signal:null})).data}}:null}(d)),g=(await I(x,p,d,!0)).model,b=g.lods.shift(),y=new Map,C=new Map;g.textures.forEach(((t,e)=>y.set(e,function(t){return new v({data:t.data,wrap:U(t.parameters.wrap)})}(t)))),g.materials.forEach(((t,e)=>C.set(e,function(t,e){const n=new c(function(t,e){return u(Y(t[0]),Y(t[1]),Y(t[2]),e)}(t.color,t.opacity)),s=t.emissiveFactor?new c((a=t.emissiveFactor,f(Y(a[0]),Y(a[1]),Y(a[2])))):null;var a;return new h({color:n,colorTexture:r(o(t.textureColor,(t=>e.get(t)))),normalTexture:r(o(t.textureNormal,(t=>e.get(t)))),emissiveColor:s,emissiveTexture:r(o(t.textureEmissive,(t=>e.get(t)))),occlusionTexture:r(o(t.textureOcclusion,(t=>e.get(t)))),alphaMode:K(t.alphaMode),alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,metallic:t.metallicFactor,roughness:t.roughnessFactor,metallicRoughnessTexture:r(o(t.textureMetallicRoughness,(t=>e.get(t))))})}(t,y))));const A=function(t){let e=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1};for(const{attributes:{position:o,normal:n,color:s,tangent:a,texCoord0:i}}of t.parts)e+=o.count,n&&(r.normal=!0),s&&(r.color=!0),a&&(r.tangent=!0),i&&(r.texCoord0=!0);return{writeIndex:0,vertexAttributes:{position:O(n,e),normal:r.normal?O(s,e):null,tangent:r.tangent?O(a,e):null,color:r.color?O(i,e):null,texCoord0:r.texCoord0?O(l,e):null},components:[]}}(b);for(const t of b.parts)J(A,t,C);const{position:M,normal:j,tangent:T,color:B,texCoord0:E}=A.vertexAttributes,R={position:M.typedBuffer,normal:e(j)?j.typedBuffer:null,tangent:e(T)?T.typedBuffer:null,uv:e(E)?E.typedBuffer:null,color:e(B)?B.typedBuffer:null},S=_(R,m,d);return{transform:S.transform,components:A.components,spatialReference:m.spatialReference,vertexAttributes:new w({position:S.vertexAttributes.position,normal:S.vertexAttributes.normal,tangent:S.vertexAttributes.tangent,color:R.color,uv:R.uv})}}function J(t,r,o){const{position:n,normal:l,tangent:c,color:u,texCoord0:f}=t.vertexAttributes,v=t.writeIndex,h=r.attributes.position.count;if(C(n.slice(v,h),r.attributes.position,r.transform),e(r.attributes.normal)&&e(l)){const t=m(p(),r.transform);A(l.slice(v,h),r.attributes.normal,t)}else e(l)&&M(l,0,0,1,{dstIndex:v,count:h});if(e(r.attributes.tangent)&&e(c)){const t=m(p(),r.transform);R(c.slice(v,h),r.attributes.tangent,t)}else e(c)&&S(c,0,0,1,1,{dstIndex:v,count:h});if(e(r.attributes.texCoord0)&&e(f)?k(f.slice(v,h),r.attributes.texCoord0):e(f)&&L(f,0,0,{dstIndex:v,count:h}),e(r.attributes.color)&&e(u)){const t=r.attributes.color,e=u.slice(v,h);if(4===t.elementCount)t instanceof a?D(e,t,255):t instanceof i?N(e,t):t instanceof d&&q(e,t,8);else{S(e,255,255,255,255);const r=x.fromTypedArray(e.typedBuffer,e.typedBufferStride);t instanceof s?j(r,t,255):t instanceof x?T(r,t):t instanceof g&&B(r,t,8)}}else e(u)&&S(u.slice(v,h),255,255,255,255);const w=function(t,e){switch(e){case 4:return Q(t,b);case 5:return P(t);case 6:return G(t)}}(r.indices||h,r.primitiveType);if(v)for(let e=0;e<w.length;e++)w[e]+=v;t.components.push(new y({faces:w,material:o.get(r.material).clone(),trustSourceNormals:!0})),t.writeIndex+=h}function K(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function U(t){return{horizontal:W(t.s),vertical:W(t.t)}}function W(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function Y(t){return t**(1/E)*255}export{z as loadGLTFMesh};
