var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,a=(t,n,o)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[n]=o;import{n as i}from"./deduplicate.ccd23651.js";import{oG as c,lf as l,fI as f,lh as u,le as g,oH as d,oI as p,oJ as m,kV as h,lg as w,lN as v,ld as y,li as A,n8 as b,mL as I,lL as L,n3 as S,n6 as V,mM as N,mK as x,n2 as E,n5 as O,oK as U,oL as P,oM as D,n9 as W,oN as k,oO as F,oP as M,n7 as j,oQ as B,oR as T,oS as z,oT as H,oU as R,oV as C,fF as K,i_ as $,f0 as _,fA as q,bU as G,e4 as J,gt as Q,oW as X,oX as Y,bV as Z,ge as ee,gU as te,gz as ne,io as oe,hk as se,fY as re,il as ae}from"./vendor.c9efa5f2.js";function ie(e,t,n){const o=t/3,s=new Uint32Array(n+1),r=new Uint32Array(n+1),a=(e,t)=>{e<t?s[e+1]++:r[t+1]++};for(let w=0;w<o;w++){const t=e[3*w],n=e[3*w+1],o=e[3*w+2];a(t,n),a(n,o),a(o,t)}let i=0,c=0;for(let w=0;w<n;w++){const e=s[w+1],t=r[w+1];s[w+1]=i,r[w+1]=c,i+=e,c+=t}const l=new Uint32Array(6*o),f=s[n],u=(e,t,n)=>{if(e<t){const o=s[e+1]++;l[2*o]=t,l[2*o+1]=n}else{const o=r[t+1]++;l[2*f+2*o]=e,l[2*f+2*o+1]=n}};for(let w=0;w<o;w++){const t=e[3*w],n=e[3*w+1],o=e[3*w+2];u(t,n,w),u(n,o,w),u(o,t,w)}const g=(e,t)=>{const n=2*e,o=t-e;for(let s=1;s<o;s++){const e=l[n+2*s],t=l[n+2*s+1];let o=s-1;for(;o>=0&&l[n+2*o]>e;o--)l[n+2*o+2]=l[n+2*o],l[n+2*o+3]=l[n+2*o+1];l[n+2*o+2]=e,l[n+2*o+3]=t}};for(let w=0;w<n;w++)g(s[w],s[w+1]),g(f+r[w],f+r[w+1]);const d=new Int32Array(3*o),p=(t,n)=>t===e[3*n]?0:t===e[3*n+1]?1:t===e[3*n+2]?2:-1,m=(e,t)=>{const n=p(e,t);d[3*t+n]=-1},h=(e,t,n,o)=>{const s=p(e,t);d[3*t+s]=o;const r=p(n,o);d[3*o+r]=t};for(let w=0;w<n;w++){let e=s[w];const t=s[w+1];let n=r[w];const o=r[w+1];for(;e<t&&n<o;){const t=l[2*e],o=l[2*f+2*n];t===o?(h(w,l[2*e+1],o,l[2*f+2*n+1]),e++,n++):t<o?(m(w,l[2*e+1]),e++):(m(o,l[2*f+2*n+1]),n++)}for(;e<t;)m(w,l[2*e+1]),e++;for(;n<o;)m(l[2*f+2*n],l[2*f+2*n+1]),n++}return d}function ce(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:le(e.layout)}}function le(e){const i=new Array;return e.fields.forEach(((e,c)=>{const l=(f=((e,t)=>{for(var n in t||(t={}))s.call(t,n)&&a(e,n,t[n]);if(o)for(var n of o(t))r.call(t,n)&&a(e,n,t[n]);return e})({},e),u={constructor:ue(e.constructor)},t(f,n(u)));var f,u;i.push([c,l])})),{stride:e.stride,fields:i,fieldNames:e.fieldNames}}const fe=[c,l,f,u,g,d,p,m,h,w,v,y,A,b,I,L,S,V,N,x,E,O,U,P,D,W,k,F,M,j,B,T,z,H,R,C];function ue(e){return`${e.ElementType}_${e.ElementCount}`}const ge=new Map;fe.forEach((e=>ge.set(ue(e),e)));const de=K().vec3f("position").u16("componentIndex").u16("u16padding");$(K().vec2u8("sideness"));const pe=K().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("u8padding",{glPadding:!0}).u16("u16padding",{glPadding:!0}),me=pe.clone().vec3f("normal"),he=pe.clone().vec3f("normalA").vec3f("normalB");class we{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?Ie:be}write(e,t,n){const o=this.edgeHashFunction(n);xe.seed=o;const s=xe.getIntRange(0,255),r=xe.getIntRange(0,this.settings.variants-1),a=xe.getFloat(),i=255*(.5*function(e,t){const n=e<0?-1:1;return Math.abs(e)**t*n}(-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7),1.2)+.5);e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex),e.variantOffset.set(t,s),e.variantStroke.set(t,r),e.variantExtension.set(t,i)}trim(e,t){return e.slice(0,t)}}const ve=new Float32Array(6),ye=new Uint32Array(ve.buffer),Ae=new Uint32Array(1);function be(e){const t=ve;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],Ae[0]=5381;for(let n=0;n<ye.length;n++)Ae[0]=31*Ae[0]+ye[n];return Ae[0]}function Ie(e){const t=ve;t[0]=Le(e.position0[0]),t[1]=Le(e.position0[1]),t[2]=Le(e.position0[2]),t[3]=Le(e.position1[0]),t[4]=Le(e.position1[1]),t[5]=Le(e.position1[2]),Ae[0]=5381;for(let n=0;n<ye.length;n++)Ae[0]=31*Ae[0]+ye[n];return Ae[0]}function Le(e){return Math.round(1e4*e)/1e4}class Se{constructor(){this.commonWriter=new we}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return me.createBuffer(e)}write(e,t,n){this.commonWriter.write(e,t,n),_(Ne,n.faceNormal0,n.faceNormal1),q(Ne,Ne),e.normal.setVec(t,Ne)}trim(e,t){return this.commonWriter.trim(e,t)}}Se.Layout=me,Se.glLayout=$(me,1);class Ve{constructor(){this.commonWriter=new we}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return he.createBuffer(e)}write(e,t,n){this.commonWriter.write(e,t,n),e.normalA.setVec(t,n.faceNormal0),e.normalB.setVec(t,n.faceNormal1)}trim(e,t){return this.commonWriter.trim(e,t)}}Ve.Layout=he,Ve.glLayout=$(he,1);const Ne=G(),xe=new J,Ee=-1;function Oe(e,t,n,o=Fe){const s=e.vertices.position,r=e.vertices.componentIndex,a=Q(o.anglePlanar),i=Q(o.angleSignificantEdge),c=Math.cos(i),l=Math.cos(a),f=We.edge,u=f.position0,g=f.position1,d=f.faceNormal0,p=f.faceNormal1,m=function(e){const t=e.faces.length/3,n=e.vertices.position,o=e.faces,s=ke.v0,r=ke.v1,a=ke.v2,i=new Float32Array(3*t);for(let c=0;c<t;c++){const e=o[3*c+0],t=o[3*c+1],l=o[3*c+2];n.getVec(e,s),n.getVec(t,r),n.getVec(l,a),re(r,r,s),re(a,a,s),ne(s,r,a),q(s,s),i[3*c+0]=s[0],i[3*c+1]=s[1],i[3*c+2]=s[2]}return i}(e),h=function(e){const t=e.faces.length/3,n=e.faces,o=e.neighbors;let s=0;for(let i=0;i<t;i++){const e=o[3*i+0],t=o[3*i+1],r=o[3*i+2],a=n[3*i+0],c=n[3*i+1],l=n[3*i+2];s+=e===Ee||a<c?1:0,s+=t===Ee||c<l?1:0,s+=r===Ee||l<a?1:0}const r=new Int32Array(4*s);let a=0;for(let i=0;i<t;i++){const e=o[3*i+0],t=o[3*i+1],s=o[3*i+2],c=n[3*i+0],l=n[3*i+1],f=n[3*i+2];(e===Ee||c<l)&&(r[a++]=c,r[a++]=l,r[a++]=i,r[a++]=e),(t===Ee||l<f)&&(r[a++]=l,r[a++]=f,r[a++]=i,r[a++]=t),(s===Ee||f<c)&&(r[a++]=f,r[a++]=c,r[a++]=i,r[a++]=s)}return r}(e),w=h.length/4,v=t.allocate(w);let y=0;const A=w,b=n.allocate(A);let I=0,L=0,S=0;const V=X(0,w),N=new Float32Array(w);Y(N,((e,t,n)=>{s.getVec(h[4*t+0],u),s.getVec(h[4*t+1],g),n[t]=ae(u,g)})),V.sort(((e,t)=>N[t]-N[e]));const x=new Array,E=new Array;for(let P=0;P<w;P++){const e=V[P],o=N[e],i=h[4*e+0],w=h[4*e+1],A=h[4*e+2],O=h[4*e+3],U=O===Ee;if(s.getVec(i,u),s.getVec(w,g),U)Z(d,m[3*A+0],m[3*A+1],m[3*A+2]),ee(p,d),f.componentIndex=r.get(i),f.cosAngle=te(d,p);else{if(Z(d,m[3*A+0],m[3*A+1],m[3*A+2]),Z(p,m[3*O+0],m[3*O+1],m[3*O+2]),f.componentIndex=r.get(i),f.cosAngle=te(d,p),Pe(f,l))continue;f.cosAngle<-.9999&&ee(p,d)}L+=o,S++,U||Ue(f,c)?(t.write(v,y++,f),x.push(o)):De(f,a)&&(n.write(b,I++,f),E.push(o))}const O=new Float32Array(x.reverse()),U=new Float32Array(E.reverse());return{regular:{instancesData:t.trim(v,y),lodInfo:{lengths:O}},silhouette:{instancesData:n.trim(b,I),lodInfo:{lengths:U}},averageEdgeLength:L/S}}function Ue(e,t){return e.cosAngle<t}function Pe(e,t){return e.cosAngle>t}function De(e,t){const n=oe(e.cosAngle),o=We.fwd,s=We.ortho;return se(o,e.position1,e.position0),n*(te(ne(s,e.faceNormal0,e.faceNormal1),o)>0?-1:1)>t}const We={edge:{position0:G(),position1:G(),faceNormal0:G(),faceNormal1:G(),componentIndex:0,cosAngle:0},ortho:G(),fwd:G()},ke={v0:G(),v1:G(),v2:G()},Fe={anglePlanar:4,angleSignificantEdge:35};async function Me(e){const t=(s=e,{data:de.createView(s.dataBuffer),indices:"Uint32Array"===s.indicesType?new Uint32Array(s.indicesBuffer):"Uint16Array"===s.indicesType?new Uint16Array(s.indicesBuffer):void 0,indicesLength:s.indicesLength,writerSettings:s.writerSettings,skipDeduplicate:s.skipDeduplicate}),n=je(t),o=[t.data.buffer];var s;return{result:Be(n,o),transferList:o}}function je(e){const t=function(e,t,n,o){if(t)return{faces:n,facesLength:o,neighbors:ie(n,o,e.count),vertices:e};const s=i(e.buffer,e.stride/4,{originalIndices:n,originalIndicesLength:o}),r=ie(s.indices,o,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:r,vertices:de.createView(s.buffer)}}(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return Te.updateSettings(e.writerSettings),ze.updateSettings(e.writerSettings),Oe(t,Te,ze)}function Be(e,t){return t.push(e.regular.lodInfo.lengths.buffer),t.push(e.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:ce(e.regular.instancesData,t),lodInfo:{lengths:e.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:ce(e.silhouette.instancesData,t),lodInfo:{lengths:e.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:e.averageEdgeLength}}const Te=new Se,ze=new Ve;export{je as work,Me as wrappedWork};
