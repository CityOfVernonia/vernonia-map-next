import{bT as e,p as t,nR as s,z as i,ab as r,q2 as a,bh as o,cd as n,d7 as d,H as p,gn as c,eH as u,kd as l,df as h,pL as y,a6 as m,y as f,n as g,q3 as S}from"./vendor.9770a310.js";import{l as w}from"./normalizeUtilsSync.5fc15c7c.js";import{u as v}from"./FeatureStore.3f0ef149.js";import{H as k}from"./QueryEngine.1ed35f1d.js";import{r as j}from"./queryEngineUtils.ee46e883.js";import"./PooledRBush.0543bc18.js";import"./quickselect.c0fda8e0.js";import"./optimizedFeatureQueryEngineAdapter.32b8979d.js";import"./centroid.f7592ee4.js";import"./WhereClause.4ea114a9.js";import"./projectionSupport.12e8a92c.js";import"./json.df9e51f4.js";import"./QueryEngineCapabilities.54eb86f4.js";import"./utils.13f35172.js";import"./spatialQuerySupport.2891a9d3.js";let b=class extends(e(t)){constructor(e){super(e),this.availability=1,this.sources={multipoint:null,point:null,polygon:null,polyline:null},this.loadedWkids=new Set,this.loadedWkts=new Set,this.pendingAdds=[]}get updating(){return this.updatingHandles.updating}get layer(){return this.layerSource.layer}destroy(){const e=this.pendingAdds;this.pendingAdds.length=0;for(const t of e)t.task.abort();this.mapSources((e=>this.destroySource(e)))}initialize(){this.handles.add([this.layer.on("graphic-update",(e=>this.onGraphicUpdate(e))),this.updatingHandles.addOnCollectionChange(this.layer.graphics,(e=>this.onGraphicsChanged(e)))]),this.addMany(this.layer.graphics.toArray())}async fetchCandidates(e,t){const o=(await s(this.mapSources((s=>s.queryEngine.executeQueryForSnapping({point:e.coordinateHelper.toPoint(e.point,new i).toJSON(),distance:e.distance,types:e.types,query:r(e.filter)?e.filter.createQuery().toJSON():{where:"1=1"}},t).then((({candidates:e})=>e)))))).flat().map((t=>j(t,e.coordinateHelper)));return a(e.point,o),o}refresh(){}onGraphicUpdate(e){switch(e.property){case"geometry":case"visible":this.remove(e.graphic),this.addMany([e.graphic])}}onGraphicsChanged(e){for(const t of e.removed)this.remove(t);this.addMany(e.added)}addMany(e){const t=[],s=new Map;for(const i of e)o(i.geometry)||(this.needsInitializeProjection(i.geometry.spatialReference)?(t.push(i.geometry.spatialReference),s.set(i.uid,i)):this.add(i));this.createPendingAdd(t,s)}createPendingAdd(e,t){if(!e.length)return;const s=n((async s=>{await d(e.map((e=>({source:e,dest:this.spatialReference}))),{signal:s}),this.markLoadedSpatialReferences(e);for(const[,e]of t)this.add(e)}));this.updatingHandles.addPromise(s.promise);const i={task:s,graphics:t},r=()=>S(this.pendingAdds,i);s.promise.then(r,r),this.pendingAdds.push(i)}markLoadedSpatialReferences(e){for(const t of e)null!=t.wkid&&this.loadedWkids.add(t.wkid),null!=t.wkt&&this.loadedWkts.add(t.wkt)}add(e){if(o(e.geometry)||!e.visible)return;let t=e.geometry;if("mesh"===t.type)return;"extent"===t.type&&(t=p.fromExtent(t));const s=this.ensureSource(t.type);if(o(s))return;const i=this.createOptimizedFeature(e.uid,t);r(i)&&s.featureStore.add(i)}needsInitializeProjection(e){return!(null!=e.wkid&&this.loadedWkids.has(e.wkid)||null!=e.wkt&&this.loadedWkts.has(e.wkt)||c(e,this.spatialReference))}createOptimizedFeature(e,t){const s=u(w(t),this.spatialReference);return s?new l(h(s,!1,!1),{[O]:e},null,e):null}ensureSource(e){const t=this.sources[e];if(r(t))return t;const s=this.createSource(e);return this.sources[e]=s,s}createSource(e){const t=y.toJSON(e),s=new v({geometryType:t,hasZ:!1,hasM:!1});return{featureStore:s,queryEngine:new k({featureStore:s,fields:[{name:O,type:"esriFieldTypeOID",alias:O}],geometryType:t,hasM:!1,hasZ:!1,objectIdField:O,spatialReference:this.spatialReference,scheduler:r(this.view)&&"3d"===this.view.type?this.view.resourceController.scheduler:null}),type:e}}remove(e){this.mapSources((t=>this.removeFromSource(t,e)));for(const t of this.pendingAdds)t.graphics.delete(e.uid),0===t.graphics.size&&t.task.abort()}removeFromSource(e,t){const s=t.uid;e.featureStore.has(s)&&e.featureStore.removeById(t.uid)}destroySource(e){e.queryEngine.destroy(),this.sources[e.type]=null}mapSources(e){const{point:t,polygon:s,polyline:i,multipoint:a}=this.sources,o=[];return r(t)&&o.push(e(t)),r(s)&&o.push(e(s)),r(i)&&o.push(e(i)),r(a)&&o.push(e(a)),o}};m([f({constructOnly:!0})],b.prototype,"spatialReference",void 0),m([f({constructOnly:!0})],b.prototype,"layerSource",void 0),m([f({constructOnly:!0})],b.prototype,"view",void 0),m([f({readOnly:!0})],b.prototype,"updating",null),m([f({readOnly:!0})],b.prototype,"availability",void 0),b=m([g("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],b);const O="OBJECTID";export{b as GraphicsSnappingSource};
