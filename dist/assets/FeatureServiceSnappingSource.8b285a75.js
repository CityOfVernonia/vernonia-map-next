var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,a=(t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s;import{bV as l,fz as o,bQ as d,p as u,a8 as h,mn as p,be as c,a3 as y,y as f,n as g,hm as v,bC as w,S as b,B as m,H as I,j$ as O,pT as S,O as H,iN as k,c9 as T,aC as P,E as _,eB as z,v as C,eG as E,pH as M,cw as j,nS as x,pU as F,gG as N,hz as R,pV as U}from"./vendor.c9efa5f2.js";import{G as D,Z as J,o as A}from"./boundedPlane.227d3612.js";import{r as V}from"./queryEngineUtils.9c65683e.js";import{n as $}from"./WorkerHandle.233e44e4.js";function L(e,t){return J(t.extent,W),A(W,l(G,e.x,e.y,0))}const W=D(),G=o();let Q=class extends(d(u)){constructor(e){super(e),this.pointOfInterest=null}get tiles(){const e=this.tilesCoveringView,t=h(this.pointOfInterest)?this.pointOfInterest:this.view.center;return e.sort(((e,i)=>L(t,e)-L(t,i))),e}scaleEnabled(){return p(this.view.scale,this.layer.minScale||0,this.layer.maxScale||0)}get tilesCoveringView(){if(!this.view.ready||!this.view.featuresTilingScheme||!this.view.state||c(this.tileInfo))return[];if(!this.scaleEnabled)return[];const{spans:e,lodInfo:t}=this.view.featuresTilingScheme.getTileCoverage(this.view.state,0),{level:i}=t,s=[];for(const{row:r,colFrom:n,colTo:a}of e)for(let e=n;e<=a;e++){const n={id:null,level:i,row:r,col:t.normalizeCol(e)};this.tileInfo.updateTileInfo(n),s.push(n)}return s}get tileInfo(){var e,t;return null!=(e=null==(t=this.view.featuresTilingScheme)?void 0:t.tileInfo)?e:null}get tileSize(){return h(this.tileInfo)?this.tileInfo.size[0]:256}initialize(){this.handles.add(this.watch("view.state.viewpoint",(()=>this.notifyChange("tilesCoveringView")),!0))}};y([f({readOnly:!0})],Q.prototype,"tiles",null),y([f({readOnly:!0})],Q.prototype,"scaleEnabled",null),y([f({readOnly:!0})],Q.prototype,"tilesCoveringView",null),y([f({readOnly:!0})],Q.prototype,"tileInfo",null),y([f({readOnly:!0})],Q.prototype,"tileSize",null),y([f({constructOnly:!0})],Q.prototype,"view",void 0),y([f({constructOnly:!0})],Q.prototype,"layer",void 0),y([f()],Q.prototype,"pointOfInterest",void 0),Q=y([g("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles2D")],Q);let B=class extends v{constructor(e){super(e),this.pointOfInterest=null}get tiles(){const e=this.tilesCoveringView,t=this.effectivePointOfInterest;if(h(t)){const i=e.map((e=>L(t,e)));for(let s=1;s<i.length;s++)if(i[s-1]>i[s])return e.sort(((e,i)=>L(t,e)-L(t,i))),e.slice()}return e}get tilesCoveringView(){var e,t;return this.filterTiles(null==(e=this.view.featureTiles)||null==(t=e.tiles)?void 0:t.toArray()).map(q)}get tileInfo(){var e,t;return null!=(e=null==(t=this.view.featureTiles)?void 0:t.tilingScheme.toTileInfo())?e:null}get tileSize(){var e,t;return null!=(e=null==(t=this.view.featureTiles)?void 0:t.tileSize)?e:256}get effectivePointOfInterest(){var e;const t=this.pointOfInterest;return h(t)?t:null==(e=this.view.pointsOfInterest)?void 0:e.focus.location}initialize(){this.handles.add(w(this.view,"featureTiles",(e=>{this.handles.remove(X),e&&this.handles.add(e.addClient(),X)})))}filterTiles(e){return c(e)?[]:e.filter((e=>Math.abs(e.measures.screenRect[3]-e.measures.screenRect[1])>K&&2===e.measures.visibility))}};function q({lij:[e,t,i],extent:s}){return{id:`${e}/${t}/${i}`,level:e,row:t,col:i,extent:s}}y([f({readOnly:!0})],B.prototype,"tiles",null),y([f({readOnly:!0})],B.prototype,"tilesCoveringView",null),y([f({readOnly:!0})],B.prototype,"tileInfo",null),y([f({readOnly:!0})],B.prototype,"tileSize",null),y([f({constructOnly:!0})],B.prototype,"view",void 0),y([f()],B.prototype,"pointOfInterest",void 0),y([f()],B.prototype,"effectivePointOfInterest",null),B=y([g("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles3D")],B);const K=50,X="feature-tiles",Y=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];let Z=class extends u{constructor(e){super(e),this.updating=!1,this.enablePolygons=!0,this.enableLabels=!0,this._polygons=new Map,this._labels=new Map,this._enabled=!0}initialize(){this._symbols=Y.map((e=>new b({color:[e[0],e[1],e[2],.6],outline:{color:"black",width:1}}))),this.update()}destroy(){this._enabled=!1,this.clear()}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.update())}update(){if(!this._enabled)return void this.clear();const e=this.getTiles(),t=new Array,i=new Set((this._labels.size,this._labels.keys()));e.forEach(((s,r)=>{const n=s.lij.toString();i.delete(n);const a=s.lij[0],l=s.geometry;if(this.enablePolygons&&!this._polygons.has(n)){const e=new m({geometry:l,symbol:this._symbols[a%this._symbols.length]});this._polygons.set(n,e),t.push(e)}if(this.enableLabels){const i=(e=>{if(h(e.label))return e.label;let t=e.lij.toString();return h(e.loadPriority)&&(t+=` (${e.loadPriority})`),t})(s),a=r/(e.length-1),o=k(0,200,a),d=k(20,6,a)/.75,u=h(s.loadPriority)&&s.loadPriority>=e.length,p=new I([o,u?0:o,u?0:o]),y="3d"===this.view.type?()=>new O({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new S({text:i,halo:{color:"white",size:1/.75},material:{color:p},size:d})]}):()=>new H({text:i,haloColor:"white",haloSize:1/.75,color:p,size:d});if(this._labels.has(n)){const e=this._labels.get(n),t=y();(c(e.symbol)||JSON.stringify(t)!==JSON.stringify(e.symbol))&&(e.symbol=t)}else{const e=new m({geometry:l.extent.center,symbol:y()});this._labels.set(n,e),t.push(e)}}}));const s=new Array;i.forEach((e=>{this._polygons.has(e)&&(s.push(this._polygons.get(e)),this._polygons.delete(e)),this._labels.has(e)&&(s.push(this._labels.get(e)),this._labels.delete(e))})),this.view.graphics.removeMany(s),this.view.graphics.addMany(t)}clear(){this.view.graphics.removeMany(Array.from(this._polygons.values())),this.view.graphics.removeMany(Array.from(this._labels.values())),this._polygons.clear(),this._labels.clear()}};y([f({constructOnly:!0})],Z.prototype,"view",void 0),y([f({readOnly:!0})],Z.prototype,"updating",void 0),y([f()],Z.prototype,"enabled",null),Z=y([g("esri.views.support.TileTreeDebugger")],Z);let ee=class extends Z{constructor(e){super(e),this.handles=new T}initialize(){const e=setInterval((()=>this.fetchDebugInfo()),2e3);this.handles.add(P((()=>clearInterval(e))))}destroy(){this.handles.destroy()}getTiles(){if(!this.debugInfo)return[];const e=new Map,t=new Map;this.debugInfo.storedTiles.forEach((t=>{e.set(t.data.id,t.featureCount)})),this.debugInfo.pendingTiles.forEach((i=>{e.set(i.data.id,i.featureCount),t.set(i.data.id,i.state)}));const i=i=>{var s;const r=t.get(i),n=null!=(s=e.get(i))?s:"?";return r?`${r}:${n}\n${i}`:`store:${n}\n${i}`},s=new Map;return this.debugInfo.storedTiles.forEach((e=>{s.set(e.data.id,e.data)})),this.debugInfo.pendingTiles.forEach((e=>{s.set(e.data.id,e.data)})),Array.from(s.values()).map((e=>({lij:[e.level,e.row,e.col],geometry:_.fromExtent(z(e.extent,this.view.spatialReference)),label:i(e.id)})))}fetchDebugInfo(){this.handle.getDebugInfo(null).then((e=>{this.debugInfo=e,this.update()}))}};y([f({constructOnly:!0})],ee.prototype,"handle",void 0),ee=y([g("esri.views.interactive.snapping.featureSources.WorkerTileTreeDebugger")],ee);let te=class extends v{constructor(e){super(e),this.availability=0,this.workerHandleUpdating=!0,this.editId=0}get updating(){return this.updatingHandles.updating||this.workerHandleUpdating}destroy(){this.workerHandle.destroy()}initialize(){this.workerHandle=new ie(this.schedule),this.handles.add([this.workerHandle.on("notify-updating",(({updating:e})=>this.workerHandleUpdating=e)),this.workerHandle.on("notify-availability",(({availability:e})=>this._set("availability",e)))])}async setup(e,t){const i=this.serviceInfoFromLayer(e.layer);if(c(i))return;const s={configuration:this.convertConfiguration(e.configuration),serviceInfo:i,spatialReference:e.spatialReference.toJSON()};await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("setup",s,t)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},t))}async configure(e,t){const i=this.convertConfiguration(e);await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("configure",i,t)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},t))}async refresh(e){await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("refresh",{},e)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},e))}async fetchCandidates(e,t){const i={distance:e.distance,point:e.coordinateHelper.toPoint(e.point,new C).toJSON(),types:e.types,filter:h(e.filter)?e.filter.createQuery().toJSON():null};return this.workerHandle.invoke(i,t)}async updateTiles(e,t){const i={tiles:e.tiles,tileInfo:h(e.tileInfo)?e.tileInfo.toJSON():null,tileSize:e.tileSize};await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("updateTiles",i,t)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},t))}async applyEdits(e,t){var i,s,r,n,a,l;const o=this.editId++,d={id:o};await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("beginApplyEdits",d,t)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},t));const u=await this.updatingHandles.addPromise(E(e.result,t)),h={id:o,edits:{addedFeatures:null!=(i=null==(s=u.addedFeatures)?void 0:s.map((({objectId:e})=>e)))?i:[],deletedFeatures:null!=(r=null==(n=u.deletedFeatures)?void 0:n.map((({objectId:e,globalId:t})=>({objectId:e,globalId:t}))))?r:[],updatedFeatures:null!=(a=null==(l=u.updatedFeatures)?void 0:l.map((({objectId:e})=>e)))?a:[]}};await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("endApplyEdits",h,t)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},t))}getDebugInfo(e){return this.workerHandle.invokeMethod("getDebugInfo",{},e)}convertConfiguration(e){return{filter:h(e.filter)?e.filter.toJSON():null,customParameters:e.customParameters}}serviceInfoFromLayer(e){var t;return"multipatch"===e.geometryType||"mesh"===e.geometryType?null:{url:e.parsedUrl.path,fields:e.fields.map((e=>e.toJSON())),geometryType:M.toJSON(e.geometryType),capabilities:e.capabilities,objectIdField:e.objectIdField,globalIdField:e.globalIdField,spatialReference:e.spatialReference.toJSON(),timeInfo:null==(t=e.timeInfo)?void 0:t.toJSON()}}};y([f({constructOnly:!0})],te.prototype,"schedule",void 0),y([f({readOnly:!0})],te.prototype,"updating",null),y([f({readOnly:!0})],te.prototype,"availability",void 0),y([f()],te.prototype,"workerHandleUpdating",void 0),te=y([g("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorkerHandle")],te);class ie extends ${constructor(e){super("FeatureServiceSnappingSourceWorker","fetchCandidates",e,{strategy:"dedicated"})}getTransferList(){return[]}}let se=class extends u{constructor(e){super(e),this.pointOfInterest=null}get tiles(){return[{id:"0/0/0",level:0,row:0,col:0,extent:j(-1e8,-1e8,1e8,1e8)}]}get tileInfo(){return new x({origin:new C({x:-1e8,y:1e8,spatialReference:this.layer.spatialReference}),size:[512,512],lods:[new F({level:0,scale:1,resolution:390625})],spatialReference:this.layer.spatialReference})}get tileSize(){return this.tileInfo.size[0]}};y([f({readOnly:!0})],se.prototype,"tiles",null),y([f({readOnly:!0})],se.prototype,"tileInfo",null),y([f({readOnly:!0})],se.prototype,"tileSize",null),y([f({constructOnly:!0})],se.prototype,"layer",void 0),y([f()],se.prototype,"pointOfInterest",void 0),se=y([g("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTilesSimple")],se);let re=class extends(d(u)){constructor(e){super(e)}get updateTilesParameters(){return{tiles:this.tilesOfInterest.tiles,tileInfo:this.tilesOfInterest.tileInfo,tileSize:this.tilesOfInterest.tileSize}}get updating(){return this.workerHandle.updating||this.updatingHandles.updating}get configuration(){return{filter:this.layer.createQuery(),customParameters:this.layer.customParameters}}get availability(){return this.workerHandle.availability}get layer(){return this.layerSource.layer}initialize(){const e=this.view;if(h(e))switch(e.type){case"2d":this.tilesOfInterest=new Q({view:e,layer:this.layer}),this.workerHandle=new te;break;case"3d":{const t=e.resourceController;this.tilesOfInterest=new B({view:e}),this.workerHandle=new te({schedule:e=>t.schedule(e)});break}}else this.tilesOfInterest=new se({layer:this.layer}),this.workerHandle=new te;this.handles.add([N(this.workerHandle)]),this.workerHandle.setup({layer:this.layer,spatialReference:this.spatialReference,configuration:this.configuration},null),this.updatingHandles.add(this,"updateTilesParameters",(()=>this.workerHandle.updateTiles(this.updateTilesParameters,null)),2),this.handles.add([R((()=>this.configuration),(e=>this.workerHandle.configure(e,null)))]),h(e)&&this.handles.add(w(U,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",(t=>{t&&!this.debug?(this.debug=new ee({view:e,handle:this.workerHandle}),this.handles.add(N(this.debug),"debug")):!t&&this.debug&&this.handles.remove("debug")}))),this.handles.add(this.layerSource.layer.on("apply-edits",(e=>{this.workerHandle.applyEdits(e,null)})))}refresh(){this.workerHandle.refresh(null)}async fetchCandidates(e,l){return this.tilesOfInterest.pointOfInterest=e.coordinateHelper.toPoint(e.point,new C),(await this.workerHandle.fetchCandidates((o=((e,t)=>{for(var i in t||(t={}))r.call(t,i)&&a(e,i,t[i]);if(s)for(var i of s(t))n.call(t,i)&&a(e,i,t[i]);return e})({},e),d={filter:null},t(o,i(d))),l)).candidates.map((t=>V(t,e.coordinateHelper)));var o,d}getDebugInfo(e){return this.workerHandle.getDebugInfo(e)}};y([f({constructOnly:!0})],re.prototype,"spatialReference",void 0),y([f({constructOnly:!0})],re.prototype,"layerSource",void 0),y([f({constructOnly:!0})],re.prototype,"view",void 0),y([f()],re.prototype,"tilesOfInterest",void 0),y([f({readOnly:!0})],re.prototype,"updateTilesParameters",null),y([f({readOnly:!0})],re.prototype,"updating",null),y([f({readOnly:!0})],re.prototype,"configuration",null),y([f({readOnly:!0})],re.prototype,"availability",null),re=y([g("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],re);export{re as FeatureServiceSnappingSource};
