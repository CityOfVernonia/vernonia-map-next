var e=Object.defineProperty,t=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,s=(t,i,r)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r;import{bh as a,iy as n,iz as o,a6 as h,y as l,n as d,p as c,c2 as u,ci as p,iA as g,iB as m,f7 as f,bm as _,b1 as v,ce as y,ab as w,aq as x,bX as b,f_ as R,gA as T,iC as S,g2 as E,iD as C,fC as D,gh as O,hw as M,f$ as P,g5 as I,f0 as A,gs as L,iE as j,iF as F,iG as H,iH as V,iI as z,ip as N,gD as U,cQ as G,c9 as W,iJ as B,iw as q,e$ as k,iK as Z,iL as $,gX as Y,iM as X,iN as Q,iO as J,io as K,c1 as ee,iP as te,b_ as ie,iQ as re,bZ as se,bY as ae,gC as ne,fD as oe,hn as he,iR as le,iS as de,g3 as ce,fK as ue,f4 as pe,gm as ge,gr as me,f8 as fe,hW as _e,hs as ve,f3 as ye,iT as we,iU as xe,dn as be,fc as Re,fh as Te,fd as Se,fe as Ee,fj as Ce,fi as De,ff as Oe,fg as Me,iV as Pe,fk as Ie,fl as Ae,fB as Le,fm as je,fn as Fe,hD as He,fo as Ve,fp as ze,iW as Ne,fq as Ue,fr as Ge,fs as We,ft as Be,fu as qe,fv as ke,hI as Ze,fx as $e,fy as Ye,fz as Xe,hM as Qe,fH as Je,iX as Ke,iY as et,iZ as tt,i_ as it,i$ as rt,j0 as st,b6 as at,j1 as nt,b0 as ot,j2 as ht,j3 as lt,j4 as dt,j5 as ct,hE as ut,bP as pt,j6 as gt,b5 as mt,hF as ft,j7 as _t,cc as vt,bF as yt,j8 as wt,bA as xt,j9 as bt,aw as Rt,by as Tt,ja as St,jb as Et,am as Ct,jc as Dt,gx as Ot,h6 as Mt,jd as Pt,je as It,jf as At,jg as Lt,ir as jt,jh as Ft,ji as Ht,gd as Vt,jj as zt,jk as Nt,jl as Ut,jm as Gt,gQ as Wt,jn as Bt,jo as qt,eY as kt,jp as Zt,jq as $t,gE as Yt,jr as Xt,js as Qt,jt as Jt,ju as Kt,jv as ei,hJ as ti,hK as ii,hL as ri,g0 as si,g1 as ai,fF as ni,jw as oi,jx as hi,jy as li,jz as di,hm as ci,ge as ui,gf as pi,jA as gi,f2 as mi,jB as fi,jC as _i,hO as vi,fJ as yi,fL as wi,fE as xi}from"./vendor.9770a310.js";import{l as bi}from"./triangulationUtils.57bae97c.js";import{a as Ri,b as Ti,t as Si,o as Ei,z as Ci,_ as Di}from"./verticalOffsetUtils.af9dc1e7.js";import"./boundedPlane.a89fa710.js";function Oi(e){return a(e)?e:e.slice()}const Mi=1.2,Pi=o,Ii=n;let Ai=class extends c{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,this.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,this.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.ENABLE_PROFILE_DEPTH_RANGE=!1,this.DISABLE_FAST_UPDATES=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1}};h([l()],Ai.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),h([l()],Ai.prototype,"SCENEVIEW_LOCKING_LOG",void 0),h([l()],Ai.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),h([l()],Ai.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),h([l()],Ai.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),h([l()],Ai.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),h([l()],Ai.prototype,"DECONFLICTOR_SHOW_GRID",void 0),h([l()],Ai.prototype,"LABELS_SHOW_BORDER",void 0),h([l()],Ai.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),h([l()],Ai.prototype,"OVERLAY_SHOW_CENTER",void 0),h([l()],Ai.prototype,"SHOW_POI",void 0),h([l()],Ai.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),h([l()],Ai.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),h([l()],Ai.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),h([l()],Ai.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),h([l()],Ai.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),h([l()],Ai.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),h([l()],Ai.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),h([l()],Ai.prototype,"I3S_TREE_SHOW_TILES",void 0),h([l()],Ai.prototype,"I3S_SHOW_MODIFICATIONS",void 0),h([l()],Ai.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),h([l()],Ai.prototype,"DISABLE_FAST_UPDATES",void 0),h([l()],Ai.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),h([l()],Ai.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),h([l()],Ai.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),Ai=h([d("esri.views.3d.support.DebugFlags")],Ai);const Li=new Ai;class ji{constructor(e,t){this.vec3=e,this.id=t}}function Fi(e,t,i,r){return new ji(u(e,t,i),r)}class Hi{constructor(e,t){this.index=e,this.renderTargets=t,this.extent=p(),this.resolution=0,this.viewport=p(),this.renderLocalOrigin=Fi(0,0,0,"O"),this.pixelRatio=1,this.canvasGeometries={extents:[p(),p(),p()],numViews:0},this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(t.renderTargets.length).fill(!1)}getValidTarget(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=1===e?this.renderTargets.getTarget(0):2===e?this.renderTargets.getTarget(2):this.renderTargets.getTarget(4);return t?t.getTexture():null}getNormalTexture(e){const t=1===e?this.renderTargets.getTarget(3):null;return t?t.getTexture():null}draw(e,t){const i=this.computeRenderTargetValidityBitfield(),r=this.needsColorWithoutRasterImage;for(const s of this.renderTargets.renderTargets)1===s.type&&!1===r?this.validTargets[s.type]=!1:this.validTargets[s.type]=e.drawTarget(this,s,t);return i^this.computeRenderTargetValidityBitfield()?0:1}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[0]|+e[1]<<1|+e[2]<<2|+e[3]<<3|+e[4]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this.extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];g(this.extent,e.range,0,t)}if(this.extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];g(this.extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,m(this.canvasGeometries.extents[0],this.extent),f(this.viewport,0,0,this.resolution,this.resolution)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}applyViewport(e){const t=this.viewport;0===this.index?e.setViewport(t[0],t[1],t[2],t[3]):e.setViewport(t[0]+this.resolution,t[1],t[2],t[3])}}class Vi{constructor(e,t){this.size=_(),this._fbo=null,this._fbo=new v(e,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=y(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return null!==this._fbo}resize(e,t){this.size[0]=e,this.size[1]=t,this._fbo.resize(this.size[0],this.size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var e;null==(e=this._fbo)||e.resize(0,0)}get gpuMemoryUsage(){var e,t;return null!=(e=null==(t=this._fbo)?void 0:t.gpuMemoryUsage)?e:0}}class zi{constructor(e){this.renderTargets=null;const t=(t,i,r=!0)=>({type:i,fbo:new Vi(e,r),renderPass:t,valid:!1,lastUsed:1/0});this.renderTargets=[t(0,0),t(0,1),t(5,2,!1),t(3,3),t(0,4)]}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,t,i){if(e)t.lastUsed=i;else if(i-t.lastUsed>Ni)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce(((e,t)=>e+t.fbo.gpuMemoryUsage),0)}}const Ni=1e3;class Ui{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class Gi{constructor(e){this._context=e,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.dispose())))),this._perConstructorInstances.clear()}acquire(e,t){const i=t.key;let r=this._perConstructorInstances.get(e);r||(r=new Map,this._perConstructorInstances.set(e,r));let s=r.get(i);if(void 0===s){const a=new e(this._context,t,(()=>this.release(a)));s=new Ui(a),r.set(i,s)}return++s.refCount,s.technique}releaseAndAcquire(e,t,i){if(w(i)){if(t.key===i.key)return i;i.release()}return this.acquire(e,t)}release(e){if(a(e))return;const t=this._perConstructorInstances.get(e.constructor).get(e.key);--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter)}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((t,i)=>{0===t.refCount&&t.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(t.technique.dispose(),e.delete(i))})),0===e.size&&this._perConstructorInstances.delete(t)}))}async hotReload(){const e=new Array;this._perConstructorInstances.forEach(((t,i)=>{e.push((async(e,t)=>{const i=t.shader;i&&(await i.reload(),e.forEach((e=>{e.technique.reload(this._context)})))})(t,i))})),await Promise.all(e)}}const Wi=x.getLogger("esri.views.3d.webgl-engine.lib.Camera");class Bi{constructor(e=null,t=null,i=null){this._viewUp=b(),this._viewForward=b(),this._viewRight=b(),this._ray=R(),this._viewport=T(0,0,1,1),this._padding=T(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=S(1,1e3),this._viewDirty=!0,this._viewMatrix=E(),this._projectionDirty=!0,this._projectionMatrix=E(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=E(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=E(),this._frustumDirty=!0,this._frustum=C(),this._fullViewport=D(),this.pixelRatio=1,this.relativeElevation=0,w(e)&&O(this._ray.origin,e),this._center=w(t)?M(t):b(),this._up=w(i)?M(i):u(0,0,1)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center)}get ray(){return P(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){I(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){this._padding[0]===e[0]&&this._padding[1]===e[1]&&this._padding[2]===e[2]&&this._padding[3]===e[3]||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),A(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(L(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2),r=i*this.aspect;j(this._projectionMatrix,-r*(1+2*this._padding[3]/e),r*(1+2*this._padding[1]/e),-i*(1+2*this._padding[2]/t),i*(1+2*this._padding[0]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(e){I(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return F(this._fov,this.width,this.height)}set fovX(e){this._fov=H(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return V(this._fov,this.width,this.height)}set fovY(e){this._fov=z(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return N(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(U(this._viewInverseTransposeMatrix,this.viewMatrix),G(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){O(this._ray.origin,e.eye),O(this._center,e.center),O(this._up,e.up),A(this._viewport,e.viewport),A(this._padding,e.padding),W(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(I(this._viewMatrix,e.viewMatrix),O(this._viewRight,e.viewRight),O(this._viewUp,e.viewUp),O(this._viewForward,e.viewForward)),t._projectionDirty?this._projectionDirty=!0:(I(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(B(e.frustum,this._frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(I(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),A(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new Bi).copyFrom(this)}equals(e){return q(this.eye,e.eye)&&q(this._center,e.center)&&q(this._up,e.up)&&k(this._viewport,e.viewport)&&k(this._padding,e.padding)&&Z(this._nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;const t=5e-4;$(Zi,e.eye,e.center),$($i,this.eye,this._center);const i=Y(Zi,$i),r=X(Zi),s=X($i);return i*i>=(1-1e-10)*r*s&&Q(e.eye,this.eye)<Math.max(r,s)*t*t&&J(e.padding,this._padding)<.5&&J(e.viewport,this._viewport)<.5}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(e))}viewDirectionDistance(e){return Math.abs(K(this.viewForward,P(Zi,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=ee()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,i=.5){return e||(e=ce()),e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*i,e.length>2&&(e[2]=.5),e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t,i=!1){e!==qi&&O(qi,e),qi[3]=1,i&&(t[2]=-qi[2]),te(qi,qi,this.projectionMatrix),ie(qi,qi,1/Math.abs(qi[3]));const r=this.fullViewport;return t[0]=re(0,r[0]+r[2],.5+.5*qi[0]),t[1]=re(0,r[1]+r[3],.5+.5*qi[1]),i||(t[2]=.5*(qi[2]+1)),t}projectToScreen(e,t){this.projectToRenderScreen(e,Yi),this.renderToScreen(Yi,t)}projectToRenderScreen(e,t){if(qi[0]=e[0],qi[1]=e[1],qi[2]=e[2],qi[3]=1,te(qi,qi,this.viewProjectionMatrix),0===qi[3])return null;ie(qi,qi,1/Math.abs(qi[3]));const i=this.fullViewport;return"x"in t?(t.x=re(0,i[0]+i[2],.5+.5*qi[0]),t.y=re(0,i[1]+i[3],.5+.5*qi[1])):(t[0]=re(0,i[0]+i[2],.5+.5*qi[0]),t[1]=re(0,i[1]+i[3],.5+.5*qi[1]),t.length>2&&(t[2]=.5*(qi[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,Yi),t)}unprojectFromRenderScreen(e,t){if(L(ki,this.projectionMatrix,this.viewMatrix),!U(ki,ki))return null;const i=this.fullViewport;return qi[0]=2*(e[0]-i[0])/i[2]-1,qi[1]=2*(e[1]-i[1])/i[3]-1,qi[2]=2*e[2]-1,qi[3]=1,te(qi,qi,ki),0===qi[3]?null:(t[0]=qi[0]/qi[3],t[1]=qi[1]/qi[3],t[2]=qi[2]/qi[3],t)}constrainWindowSize(e,t,i,r=i){const s=e*this.pixelRatio,a=t*this.pixelRatio,n=Math.max(s-i/2,0),o=Math.max(this.fullHeight-a-r/2,0),h=-Math.min(s-i/2,0),l=-Math.min(this.fullHeight-a-r/2,0);return[n,o,i-h- -Math.min(this.fullWidth-s-i/2,0),r-l- -Math.min(a-r/2,0)]}computeUp(e){1===e?this.computeUpGlobal():this.computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=i,t[1]=r}computeUpGlobal(){P(Zi,this.center,this.eye);const e=se(this.center);e<1?(ae(this._up,0,0,1),this._markViewDirty()):Math.abs(Y(Zi,this.center))>.9999*se(Zi)*e||(ne(this._up,Zi,this.center),ne(this._up,this._up,Zi),oe(this._up,this._up),this._markViewDirty())}computeUpLocal(){he(Zi,this.eye,this.center),Math.abs(Zi[2])<=.9999&&(ie(Zi,Zi,Zi[2]),ae(this._up,-Zi[0],-Zi[1],1-Zi[2]),oe(this._up,this._up),this._markViewDirty())}_compareAndSetView(e,t){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?q(e,t)||(O(t,e),this._markViewDirty()):Wi.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(le(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(de(this._viewMatrix,this.eye,this._center,this._up),ae(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),ae(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),ae(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const qi=D(),ki=E(),Zi=b(),$i=b(),Yi=ce(),Xi=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function Qi(e,t){return e+"_"+Xi.find((e=>e.output===t)).name}const Ji=x.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep");class Ki{constructor(e){this.refCnt=0,this.glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,ue(this.refCnt>=0)}getRefCnt(){return this.refCnt}getGLMaterial(){return this.glMaterial}}class er{constructor(e,t,i){this._textureRep=e,this._techniqueRep=t,this.onMaterialChanged=i,this._id2glMaterialRef=new Map}dispose(){this._textureRep.dispose()}acquire(e,t){this.ownMaterial(e);const i=Qi(e.id,t);let r=this._id2glMaterialRef.get(i);if(null==r){const s=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return r=new Ki(s),r.incRefCnt(),this._id2glMaterialRef.set(i,r),s}return r.incRefCnt(),r.getGLMaterial()}release(e,t){const i=Qi(e.id,t),r=this._id2glMaterialRef.get(i);if(r.decRefCnt(),0===r.getRefCnt()){const e=r.getGLMaterial();e&&e.dispose(),this._id2glMaterialRef.delete(i)}}materialChanged(e){for(const t of Xi)if(5!==t.output&&6!==t.output){const i=this._id2glMaterialRef.get(Qi(e.id,t.output));if(i&&i.getGLMaterial()){const e=i.getGLMaterial();e.updateParameters&&e.updateParameters()}}this.onMaterialChanged&&this.onMaterialChanged(e)}ownMaterial(e){w(e.materialRepository)&&e.materialRepository!==this&&Ji.error("Material is already owned by a different material repository"),e.materialRepository=this}}let tr=0;class ir{constructor(e){this._originSR=e,this.ROOT_ORIGIN_ID="rg_root_"+tr++,this._origins=new Map,this._gridSize=125e4,this._objects=new Map}getOrigin(e){const t=this._origins.get(this.ROOT_ORIGIN_ID);if(null==t){if(w(rr))return this._origins.set(this.ROOT_ORIGIN_ID,Fi(rr[0],rr[1],rr[2],this.ROOT_ORIGIN_ID)),this.getOrigin(e);const t=Fi(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,t),t}const i=this._gridSize,r=Math.round(e[0]/i),s=Math.round(e[1]/i),a=Math.round(e[2]/i),n=`rg_${r}/${s}/${a}`;let o=this._origins.get(n);const h=.5*i;if(P(sr,e,t.vec3),sr[0]=Math.abs(sr[0]),sr[1]=Math.abs(sr[1]),sr[2]=Math.abs(sr[2]),sr[0]<h&&sr[1]<h&&sr[2]<h){if(o){const t=Math.max(...sr);if(P(sr,e,o.vec3),sr[0]=Math.abs(sr[0]),sr[1]=Math.abs(sr[1]),sr[2]=Math.abs(sr[2]),Math.max(...sr)<t)return o}return t}return o||(o=Fi(r*i,s*i,a*i,n),this._origins.set(n,o)),o}_drawOriginBox(e,t=[1,1,0,1]){const i=window.view,r=i._stage,s=t.toString();if(!this._objects.has(s)){this._material=new pe({width:2,color:t}),r.add(this._material);const e=new ge({isPickable:!1}),i=new me({castShadow:!1});r.add(i),e.add(i),r.add(e),this._objects.set(s,i)}const a=this._objects.get(s),n=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],o=n.length,h=new Array(3*o),l=new Uint16Array(2*(o-1)),d=.5*this._gridSize;for(let u=0;u<o;u++)h[3*u+0]=e[0]+(1&n[u]?d:-d),h[3*u+1]=e[1]+(2&n[u]?d:-d),h[3*u+2]=e[2]+(4&n[u]?d:-d),u>0&&(l[2*u+0]=u-1,l[2*u+1]=u);fe(h,this._originSR,0,h,i.renderSpatialReference,0,o);const c=new _e([["position",{size:3,data:h,exclusive:!0}]],[["position",l]],2);r.add(c),a.addGeometry(c,this._material,ve)}get test(){const e=this;return{get gridSize(){return e._gridSize},set gridSize(t){e._gridSize=t}}}}let rr=null;const sr=b();class ar{constructor(){this.min=new nr,this.max=new nr,this.hud=new nr,this.ground=new nr}init(e){this.min.init(e),this.max.init(e),this.hud.init(e),this.ground.init(e),this.all=[]}}class nr{constructor(e){this.normal=b(),this.transformation=E(),this._ray=R(),this.init(e)}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return ie(or,this.ray.direction,this.dist),se(or)}getIntersectionPoint(e){return!!this.hasIntersectionPoint&&(ie(or,this.ray.direction,this.dist),ye(e,this.ray.origin,or),!0)}getTransformedNormal(e){return O(hr,this.normal),hr[3]=0,te(hr,hr,this.transformation),O(e,hr),oe(e,e),e}init(e){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",e?we(e,this._ray):this._ray=R()}set(e,t,i,r,s,a,n,o,h,l){e instanceof me&&(e={type:"stage",obj:e}),this.dist=i,O(this.normal,r),I(this.transformation,s),this.target=e,this.name=t,this.drapedLayerOrder=a,this.center=n?M(n):null,this.geometryId=o,this.triangleNr=h,this.drapedLayerGraphicOrder=l}copyFrom(e){we(e.ray,this._ray),this.dist=e.dist,this.target=e.target,this.name=e.name,this.drapedLayerOrder=e.drapedLayerOrder,this.center=e.center?M(e.center):null,this.geometryId=e.geometryId,this.triangleNr=e.triangleNr,this.intersector=e.intersector,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,O(this.normal,e.normal),I(this.transformation,e.transformation)}}const or=b(),hr=D();class lr{constructor(e){this.rctx=e,this.camera=null,this.lastFrameCamera=new Bi,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=dr,this.hasOccludees=!1}resetRenderOccludedMask(){this.renderOccludedMask=dr}get isHighlightPass(){return 5===this.pass}}const dr=13;class cr{constructor(){this.adds=new xe,this.removes=new xe,this.updates=new xe({allocator:e=>e||new ur,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class ur{}class pr{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function gr(e){return e.data.indexCount>=1}class mr{constructor(e){null==e?e=16:e<65536&&(e=be(e)),this._array=new Float32Array(e),this._size=0}resize(e,t){if(this._size=e,this._size>this._array.length){let e=this._array.length||1;for(;e<this._size;)e*=2;const i=new Float32Array(e);return t&&i.set(this._array),this._array=i,!0}const i=2*this._size;if(i<=this._array.length){let e=this._array.length;for(;e>=i;)e=Math.floor(e/2);const r=new Float32Array(e);return t&&r.set(this._array.subarray(0,e)),this._array=r,!0}return!1}append(e){const t=this._size;this.resize(this._size+e.length,!0),this._array.set(e,t)}erase(e,t){for(let i=e;i<t;++i)this._array[i]=0}get array(){return this._array}get size(){return this._size}}function fr(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(Re`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function _r(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(Te),e.include(fr),e.fragment.code.add(Re`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function vr(e){e.fragment.code.add(Re`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function yr(e){e.fragment.code.add(Re`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function wr(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(vr),e.fragment.code.add(Re`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function xr(e,t){1===t.viewingMode?e.vertex.code.add(Re`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(Re`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),1===t.viewingMode?e.vertex.code.add(Re`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(Re`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}function br(e){e.fragment.code.add(Re`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}function Rr(e,t){e.include(Ri,t),e.include(br),e.include(yr),t.ssrEnabled&&e.include(_r,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),e.fragment.code.add(Re`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),e.fragment.code.add(Re`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {
float reflectionHit = 0.;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}`),t.ssrEnabled?e.fragment.code.add(Re`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);
float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);
vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;
}
float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);
return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);
}`):e.fragment.code.add(Re`return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);
}`)}function Tr(e){const t=new Se;return t.include(Ee,{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(xr,e),t.include(Ti,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(Re`
      void main(void) {
        if (waterColor.a < ${Re.float(Ce)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${0===e.output?"forwardLinearDepth();":""}
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(Te),t.include(De,e)),7===e.output&&(t.include(Oe,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(Re`
        void main() {
          discardBySlice(vpos);
          ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),0===e.output&&(t.include(wr,e),t.include(Oe,e),e.receiveShadows&&t.include(Si,e),t.include(Rr,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(Me),t.fragment.code.add(Re`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - camPos);
        float shadow = ${e.receiveShadows?Re`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),2===e.output&&(t.include(xr,e),t.include(wr,e),t.include(Oe,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(Re`
        void main(void) {
          if (waterColor.a < ${Re.float(Ce)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(Re`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(Re`
        void main(void) {
          if (waterColor.a < ${Re.float(Ce)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(Re`void main() {
gl_FragColor = waterColor;
}`)),4===e.output&&(t.include(Pe),t.varyings.add("vpos","vec3"),t.vertex.code.add(Re`
      void main(void) {
        if (waterColor.a < ${Re.float(Ce)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(Oe,e),t.fragment.code.add(Re`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}var Sr=Object.freeze({__proto__:null,build:Tr});class Er extends je{constructor(e,t,i){super(e,t,i),this._textureRepository=e.waterTextureRepository}initializeProgram(e){const t=Er.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:i.useSSR,highStepCount:!0,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new Fe(e.rctx,r,He)}ensureResource(e){return this._textureRepository.ready||this._textureRepository.updating||this._textureRepository.loadTextures(e),this._textureRepository.ready?2:1}bindPass(e,t){Ve(this.program,t.camera.projectionMatrix),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),ze(this.program,t)),0===this.configuration.output&&(t.lighting.setUniforms(this.program,!1),function(e,t){var i,r;t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),r=t,(i=e).bindTexture(r.lastFrameColorTexture,"lastFrameColorMap"),i.setUniformMatrix4fv("reprojectionMat",r.reprojectionMat),i.setUniformMatrix4fv("rpProjectionMat",r.camera.projectionMatrix))}(this.program,t)),0!==this.configuration.output&&2!==this.configuration.output||(function(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}(this.program,e),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",e.color),4===this.configuration.output&&Ne(this.program,t)}bindDraw(e){Ue(this.program,e),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||Ge(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Ei(this.program,e),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||We(this.program,this.configuration,e)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e;return Be({blending:2!==t.output&&4!==t.output&&t.transparent?i?qe:ke(e):null,depthTest:{func:Ze(e)},depthWrite:i?t.writeDepth&&$e:Ye(e),colorWrite:Xe,polygonOffset:i||r?null:Qe(t.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Er.shader=new Le(Sr,(()=>import("./WaterSurface.glsl.ff233d18.js")));class Cr extends Ae{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}h([Ie({count:8})],Cr.prototype,"output",void 0),h([Ie()],Cr.prototype,"receiveShadows",void 0),h([Ie()],Cr.prototype,"slicePlaneEnabled",void 0),h([Ie()],Cr.prototype,"transparent",void 0),h([Ie()],Cr.prototype,"enableOffset",void 0),h([Ie()],Cr.prototype,"writeDepth",void 0),h([Ie()],Cr.prototype,"useSSR",void 0),h([Ie()],Cr.prototype,"isDraped",void 0),h([Ie({count:4})],Cr.prototype,"transparencyPassType",void 0),h([Ie()],Cr.prototype,"multipassTerrainEnabled",void 0),h([Ie()],Cr.prototype,"cullAboveGround",void 0);class Dr extends Je{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(Er,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){if(2===this._output)return 22===e;if(5===this._output)return null==e;if(4===this._output)return 3===e;let t=3;return this._material.params.transparent&&(t=this._material.params.writeDepth?5:8),e===t}setElapsedTimeUniform(e){const t=.001*this._material.animation.time;e.setUniform1f("timeElapsed",t*this._material.params.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.params.receiveShadows&&this._material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this._material.params.ssrEnabled&&this._material.setParameterValues({ssrEnabled:e.ssrEnabled})}ensureResources(e){return this._technique.ensureResource(e)}ensureParameters(e){0===this._output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e){this._technique.bindPass(this._material.params,e),2!==this._output&&0!==this._output||this.setElapsedTimeUniform(this._technique.program)}}class Or{constructor(e,t,i,r,s,a){this.from=e,this.to=t,this.isVisible=i,this.hasHighlights=r,this.hasOccludees=s,this.transformation=a,null!=a&&(this.transformationNormal=Ke(a),U(this.transformationNormal,this.transformationNormal),G(this.transformationNormal,this.transformationNormal))}}function Mr(e,t){const i=e=>({first:e.from,count:e.to-e.from});if(0===e.length)return void e.push(i(t));const r=e[e.length-1];if(function(e,t){return e.first+e.count>=t.from}(r,t)){const e=t.from-r.first+t.to-t.from;r.count=e}else e.push(i(t))}function Pr(e,t,i){w(i)&&(i.drawCalls+=e,i.triangles+=t)}class Ir{constructor(e,t,i){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=i,this._materialRep=t,this._glMaterials=et(this._material,this._materialRep),this._bufferWriter=i.createBufferWriter()}dispose(){tt(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&it(this._glMaterials,(e=>e instanceof Dr))}get rendersOccluded(){return!this.isEmpty&&1!==this._material.renderOccluded}modify(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}addAndRemoveGeometries(e,t){const i=this._bufferWriter,r=i.vertexBufferLayout,s=r.stride/4,n=this._dataByOrigin,o=function(e,t,i,r){const s=new Map,n=t.vertexBufferLayout.stride/4,o=(i,r)=>{const o=i.origin;if(a(o))return;const h=e.get(o.id);let l=s.get(o.id);null==l&&(l={optimalCount:null==h?0:h.optimalCount,sparseCount:null==h?0:h.buffer.size,toAdd:[],toRemove:[],origin:o.vec3},s.set(o.id,l));const d=t.elementCount(i.data)*n;r?(l.optimalCount+=d,l.sparseCount+=d,l.toAdd.push(i)):(l.optimalCount-=d,l.toRemove.push(i))};for(const a of i)o(a,!0);for(const a of r)o(a,!1);return s}(n,i,e,t);o.forEach(((e,t)=>{o.delete(t);const i=e.optimalCount,a=e.sparseCount;let h=n.get(t);if(null==h)ue(i>0),h=this.createData(r,i,e.origin),n.set(t,h);else if(0===i)return h.vao.dispose(!0),h.vao=null,void n.delete(t);const l=i<e.sparseCount/2,d=l?i:a,c=Lr,u=h.buffer.size,p=h.buffer.array,g=h.buffer.resize(d,!1);l||g?this.removeAndRebuild(h,e.toRemove,s,p,c):e.toRemove.length>0?(this.removeByErasing(h,e.toRemove,s,c),e.toAdd.length>0&&(c.end=u)):(c.begin=u,c.end=u);const m=jr;rt(m,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(h,e.toAdd,s,m,c);const f=h.vao.vertexBuffers.geometry;if(f.byteSize!==h.buffer.array.buffer.byteLength)f.setData(h.buffer.array);else{const{begin:e,end:t}=c;if(e<t){const i=h.buffer.array,r=4,s=e*r,a=t*r;f.setSubData(i,s,s,a)}}h.drawCommandsDirty=!0}))}updateGeometries(e){const t=this._bufferWriter,i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.updateType,s=r.renderGeometry,a=this._dataByOrigin.get(s.origin.id),n=a&&a.instances.get(s.id);if(!n)return;if(1&e&&(n.isVisible=s.instanceParameters.visible),9&e){const e=s.instanceParameters.visible;n.hasHighlights=!!s.instanceParameters.highlights&&e}if(16&e&&(n.hasOccludees=!!s.instanceParameters.occludees),6&e){const e=a.buffer.array,r=a.vao;st(s,Fr,Hr),t.write({transformation:Fr,invTranspTransformation:Hr},s.data,t.vertexBufferLayout.createView(e.buffer),n.from),ue(n.from+t.elementCount(s.data)===n.to,"material VBO layout has changed"),r.vertexBuffers.geometry.setSubData(e,n.from*i*4,n.from*i*4,n.to*i*4)}a.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,it(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));this._dataByOrigin.forEach((e=>{e.drawCommandsDirty&&((e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0===e.instances.size)return;if(!Ar(e)){const t=4*e.buffer.size/ht(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}const t=function(e){return e.sort(((e,t)=>e.from===t.from?e.to>t.to?1:e.to<t.to?-1:0:e.from>t.from?1:e.from<t.from?-1:0))}([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const r of t)r.isVisible&&(r.hasOccludees?Mr(e.drawCommandsOccludees,r):Mr(e.drawCommandsDefault,r),r.hasHighlights?Mr(e.drawCommandsHighlight,r):Mr(e.drawCommandsShadowHighlightRest,r));const i=e=>{let t=0;for(const i of e)t+=i.count;return t/3};e.stats={default:i(e.drawCommandsDefault),highlight:i(e.drawCommandsHighlight),occludees:i(e.drawCommandsOccludees),shadowHighlightRest:i(e.drawCommandsShadowHighlightRest)}})(e),e.drawCommandsDirty=!1)}))}updateLogic(e){return this._material.update(e)}render(e,t,i,r){const s=this._rctx,n=this._glMaterials.get(t),o=5===t||7===t,h=6===t,l=!(o||h);if(3===t&&null===e&&(e=22),!n||2!==n.ensureResources(s)||null!=e&&!n.beginSlot(e)||o&&!this._hasHighlights)return!1;n.ensureParameters(i);const d=n.getPipelineState(e,!1);s.setPipelineState(d);const c=n.technique;s.useProgram(c.program),n.bind(i);let u=!1;return this._dataByOrigin.forEach((t=>{if(a(t.drawCommandsDefault)&&a(t.drawCommandsHighlight)&&a(t.drawCommandsOccludees)&&a(t.drawCommandsShadowHighlightRest))return;if(o&&!t.hasHighlights)return;i.origin=t.origin,c.bindDraw(i,{},{}),c.ensureAttributeLocations(t.vao),s.bindVAO(t.vao);const p=c.primitiveType,g=o?t.drawCommandsHighlight:h&&Ar(t)?t.drawCommandsShadowHighlightRest:t.drawCommandsDefault;if(w(g)){this.renderCommands(s,p,g);const e=o?t.stats.highlight:h&&Ar(t)?t.stats.shadowHighlightRest:t.stats.default;Pr(g.length,e,r),u=!0}if(l){const i=t.drawCommandsOccludees;if(w(i)){const a=n.getPipelineState(e,!0);s.setPipelineState(a),this.renderCommands(s,p,i),s.setPipelineState(d),Pr(i.length,t.stats.occludees,r),u=!0}}})),u}renderCommands(e,t,i){for(let r=0;r<i.length;r++)e.drawArrays(t,i[r].first,i[r].count)}createData(e,t,i){return{instances:new Map,vao:new at(this._rctx,this._material.vertexAttributeLocations,{geometry:nt(e)},{geometry:ot.createVertex(this._rctx,35044)}),buffer:new mr(t),optimalCount:0,origin:i,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}removeAndRebuild(e,t,i,r,s){for(const d of t){const t=d.id,r=e.instances.get(t);e.optimalCount-=(r.to-r.from)*i,e.instances.delete(t)}let a=0;const n=e.buffer.array;s.begin=0,s.end=0;let o=-1,h=-1,l=0;e.instances.forEach((e=>{const t=e.from*i,s=e.to*i,d=s-t;o!==h&&h!==t?(n.set(r.subarray(o,h),l),l+=h-o,o=t):-1===o&&(o=t),h=s,e.from=a/i,a+=d,e.to=a/i})),o!==h&&n.set(r.subarray(o,h),l),s.end=a}removeByErasing(e,t,i,r){r.begin=1/0,r.end=-1/0;let s=-1,a=-1;for(const n of t){const t=n.id,o=e.instances.get(t),h=o.from*i,l=o.to*i;s!==a&&a!==h?(e.buffer.erase(s,a),s=h):-1===s&&(s=h),a=l,e.instances.delete(t),e.optimalCount-=l-h,h<r.begin&&(r.begin=h),l>r.end&&(r.end=l)}s!==a&&e.buffer.erase(s,a)}append(e,t,i,r,s){const a=this._bufferWriter;for(const n of t){const t=w(n.transformation)?L(Fr,r,n.transformation):r;U(Hr,t),G(Hr,Hr);const o=s.end;a.write({transformation:t,invTranspTransformation:Hr},n.data,a.vertexBufferLayout.createView(e.buffer.array.buffer),s.end/i);const h=a.elementCount(n.data)*i,l=o+h;ue(null==e.instances.get(n.id));const d=n.instanceParameters.visible,c=!!n.instanceParameters.highlights&&d,u=!!n.instanceParameters.occludees,p=new Or(o/i,l/i,d,c,u);e.instances.set(n.id,p),e.optimalCount+=h,s.end+=h}}get test(){return{material:this._material,glMaterials:this._glMaterials}}}function Ar(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}const Lr={begin:0,end:0},jr=E(),Fr=E(),Hr=E();let Vr=class extends c{constructor(){super(...arguments),this._pending=new zr,this._changes=new cr,this._materialRenderers=new Map,this._sortedMaterialRenderers=new xe,this._hasHighlights=!1,this._hasWater=!1}dispose(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return it(this._materialRenderers,(e=>e.rendersOccluded))}stopAnimationsAtTime(e){this._sortedMaterialRenderers.forAll((t=>lt(t.material.animation,(t=>t.stopAtTime(e)))))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=function(e){const t=new Map,i=e=>{let i=t.get(e);return i||(i=new pr,t.set(e,i)),i};return e.adds.forAll((e=>{gr(e)&&i(e.material).adds.push(e)})),e.removes.forAll((e=>{gr(e)&&i(e.material).removes.push(e)})),e.updates.forAll((e=>{gr(e.renderGeometry)&&i(e.renderGeometry.material).updates.push(e)})),t}(this._changes);let t=!1,i=!1,r=!1;return e.forEach(((e,s)=>{let a=this._materialRenderers.get(s);if(!a&&e.adds.length>0&&(a=new Ir(this.rctx,this.materialRepository,s),this._materialRenderers.set(s,a),t=!0,i=!0,r=!0),!a)return;const n=i||a.hasHighlights,o=r||a.hasWater;a.modify(e),i=i||n!==a.hasHighlights,r=r||o!==a.hasWater,a.isEmpty&&(this._materialRenderers.delete(s),a.dispose(),t=!0)})),this._changes.clear(),t&&this.updateSortedMaterialRenderers(),i&&(this._hasHighlights=it(this._materialRenderers,(e=>e.hasHighlights))),r&&(this._hasWater=it(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}add(e){if(0===e.length)return;const t=this._pending.empty;for(const i of e)this._pending.adds.add(i);t&&this.notifyChange("updating")}remove(e){const t=this._pending.empty;for(const i of e)this._pending.adds.has(i)?(this._pending.removed.add(i),this._pending.adds.delete(i)):this._pending.removed.has(i)||this._pending.removes.add(i);t&&!this._pending.empty&&this.notifyChange("updating")}modify(e,t){const i=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=r,e.updateType=t}i&&this._changes.updates.length>0&&this.notifyChange("updating")}updateLogic(e){let t=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:i})=>{i.updateLogic&&i.updateLogic(e)&&(t=!0)})),t}render(e,t){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];dt(r.material,e)&&r.materialRenderer.render(null,e.pass,t,null)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((t,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push({material:i,materialRenderer:t})})),this._sortedMaterialRenderers.sort(((e,t)=>{const i=t.material.renderPriority-e.material.renderPriority;return 0!==i?i:e.material.insertOrder-t.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};h([l()],Vr.prototype,"rctx",void 0),h([l()],Vr.prototype,"materialRepository",void 0),h([l()],Vr.prototype,"updating",null),Vr=h([d("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Vr);class zr{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}function Nr(){const e=new Se;return e.include(ct),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(Re`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * color;
}`),e}var Ur=Object.freeze({__proto__:null,build:Nr});class Gr extends je{initializeProgram(e){const t=Gr.shader.get().build();return new Fe(e.rctx,t,He)}initializePipeline(){return this.configuration.hasAlpha?Be({blending:ut(770,1,771,771),colorWrite:Xe}):Be({colorWrite:Xe})}}Gr.shader=new Le(Ur,(()=>import("./TextureOnly.glsl.ecabad2e.js")));class Wr extends Ae{constructor(){super(...arguments),this.hasAlpha=!1}}h([Ie()],Wr.prototype,"hasAlpha",void 0);class Br{constructor(e=b()){this.intensity=e}}class qr{constructor(e=b(),t=u(.57735,.57735,.57735)){this.intensity=e,this.direction=t}}class kr{constructor(e=b(),t=u(.57735,.57735,.57735),i=!0){this.intensity=e,this.direction=t,this.castShadows=i}}class Zr{constructor(){this.r=[0],this.g=[0],this.b=[0]}}function $r(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function Yr(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function Xr(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function Qr(e){return(e+1)*(e+1)}function Jr(e,t,i){const r=e[0],s=e[1],a=e[2],n=i||[];return n.length=Qr(t),t>=0&&(n[0]=.28209479177),t>=1&&(n[1]=.4886025119*r,n[2]=.4886025119*a,n[3]=.4886025119*s),t>=2&&(n[4]=1.09254843059*r*s,n[5]=1.09254843059*s*a,n[6]=.31539156525*(3*a*a-1),n[7]=1.09254843059*r*a,n[8]=.54627421529*(r*r-s*s)),n}function Kr(e,t){const i=(r=t.r.length,pt(Math.floor(Math.sqrt(r)-1),0,2));var r;for(const s of e)gt(ns,s.direction),Jr(ns,i,ss),$r(ss,os),Yr(ss,s.intensity[0],as),Xr(t.r,as),Yr(ss,s.intensity[1],as),Xr(t.g,as),Yr(ss,s.intensity[2],as),Xr(t.b,as);return t}function es(e,t,i,r){(function(e,t){const i=Qr(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let s=0;s<i;s++)r.r[s]=r.g[s]=r.b[s]=0})(t,r),ae(i.intensity,0,0,0);let s=!1;const a=ts,n=is,o=rs;a.length=0,n.length=0,o.length=0;for(const h of e)h instanceof kr&&!s?(O(i.direction,h.direction),i.intensity[0]=h.intensity[0],i.intensity[1]=h.intensity[1],i.intensity[2]=h.intensity[2],i.castShadows=h.castShadows,s=!0):h instanceof kr||h instanceof qr?a.push(h):h instanceof Br?n.push(h):h instanceof Zr&&o.push(h);Kr(a,r),function(e,t){Jr(ns,0,ss);for(const i of e)t.r[0]+=ss[0]*os[0]*i.intensity[0]*4*Math.PI,t.g[0]+=ss[0]*os[0]*i.intensity[1]*4*Math.PI,t.b[0]+=ss[0]*os[0]*i.intensity[2]*4*Math.PI}(n,r);for(const h of o)Xr(r.r,h.r),Xr(r.g,h.g),Xr(r.b,h.b)}const ts=[],is=[],rs=[],ss=[0],as=[0],ns=b(),os=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class hs{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:b(),ambient:{color:b(),intensity:1},diffuse:{color:b(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new Zr,this._mainLight={intensity:b(),direction:u(1,0,0),castShadows:!1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(e,t=!1){const i=t?(1-this.groundLightingFactor)*(1-this.globalFactor):0;e.setUniform1f("lightingFixedFactor",i),e.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),e.setUniform1f("ambientBoostFactor",this._ambientBoost);const r=this._sphericalHarmonics;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",r.r[0],r.g[0],r.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",r.r[0],r.r[1],r.r[2],r.r[3]),e.setUniform4f("lightingAmbientSH_G",r.g[0],r.g[1],r.g[2],r.g[3]),e.setUniform4f("lightingAmbientSH_B",r.b[0],r.b[1],r.b[2],r.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",r.r[0],r.g[0],r.b[0]),e.setUniform4f("lightingAmbientSH_R1",r.r[1],r.r[2],r.r[3],r.r[4]),e.setUniform4f("lightingAmbientSH_G1",r.g[1],r.g[2],r.g[3],r.g[4]),e.setUniform4f("lightingAmbientSH_B1",r.b[1],r.b[2],r.b[3],r.b[4]),e.setUniform4f("lightingAmbientSH_R2",r.r[5],r.r[6],r.r[7],r.r[8]),e.setUniform4f("lightingAmbientSH_G2",r.g[5],r.g[6],r.g[7],r.g[8]),e.setUniform4f("lightingAmbientSH_B2",r.b[5],r.b[6],r.b[7],r.b[8]))}set(e){es(e,this._shOrder,this._mainLight,this._sphericalHarmonics),O(this._oldSunlight.direction,this._mainLight.direction);const t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,ie(this._oldSunlight.diffuse.color,this._mainLight.intensity,t),O(ls,this._oldSunlight.diffuse.color),ie(ls,ls,this._ambientBoost*this.globalFactor),ye(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,ls)}get old(){return this._oldSunlight}}const ls=b();class ds{constructor(e){this._rctx=e,this.cache=new Map}dispose(){this.cache.forEach((e=>e.texture=y(e.texture))),this.cache.clear()}acquire(e){if(a(e))return null;const t=this.patternId(e),i=this.cache.get(t);if(i)return i.refCount++,i.bind;const r=this.patternToTextureData(e,2),s=r.length/2,n={refCount:1,texture:null,bind:e=>(a(n.texture)&&(n.texture=new mt(this._rctx,{width:r.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},r)),e.bindTexture(n.texture,"stipplePatternTexture"),s)};return this.cache.set(t,n),n.bind}release(e){if(a(e))return;const t=this.patternId(e),i=this.cache.get(t);i&&(i.refCount--,0===i.refCount&&(w(i.texture)&&i.texture.dispose(),this.cache.delete(t)))}swap(e,t){const i=this.acquire(t);return this.release(e),i}patternId(e){return e.join(",")}patternToTextureData(e,t){const i=e.reduce(((e,t)=>e+t))*t,r=new Uint8Array(i);let s=!0,a=0;for(const n of e){for(let e=0;e<n*t;e++)r[a++]=s?255:0;s=!s}return r}}const cs=x.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let us=class extends(_t(c)){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new hs,this._handles=new vt,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new xe,this._geometries=new Map,this.globalUnitScale=1,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new lr(this._rctx);const t=e.waterTextureRepository;this._stippleTextureRepository=new ds(e.renderingContext),this._shaderTechniqueRepository=new Gi({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._handles.add([yt(t,"loadingState",(()=>this.emitContentChanged())),yt(this,"spatialReference",(e=>this._localOrigins=new ir(e)))]),this._materialRepository=new er(e.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&ys)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange("updating")},this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new Br(u(1,1,1))]),this._bindParameters={slot:null,highlightDepthTexture:wt(this._rctx),camera:ms,inverseViewport:xt(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._handles.add(this.view.resourceController.scheduler.registerTask(bt.STAGE,this))}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._debugTextureTechnique=Rt(this._debugTextureTechnique),this._debugPatternTexture=y(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=y(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=y(this._shaderTechniqueRepository),this._temporaryFBO=y(this._temporaryFBO),this._quadVAO=y(this._quadVAO),this._overlayRenderTarget=y(this._overlayRenderTarget)}get updating(){return this._sortedLayerRenderersDirty||it(this._layerRenderers,(e=>e.updating))}get hasOverlays(){return w(this._overlays)&&w(this._overlayRenderTarget)}get gpuMemoryUsage(){return w(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let t=!1;if(w(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const r=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];t=this._overlayRenderTarget.validateUsageForTarget(r,i,e)||t}return t}get overlays(){return Tt(this._overlays,[])}ensureDrapeTargets(e){w(this._overlays)&&this._overlays.forEach((t=>{t.hasTargetWithoutRasterImage=St(e,(e=>1===e.drapeTargetType))}))}ensureDrapeSources(e){w(this._overlays)&&this._overlays.forEach((t=>{t.hasDrapedFeatureSource=it(e,((e,t)=>1===t.drapeSourceType)),t.hasDrapedRasterSource=it(e,((e,t)=>0===t.drapeSourceType))}))}ensureOverlays(e,t){a(this._overlays)&&(this._overlayRenderTarget=new zi(this._rctx),this._overlays=[new Hi(0,this._overlayRenderTarget),new Hi(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){w(this._overlayRenderTarget)&&this._overlayRenderTarget.disposeRenderTargetMemory()}get running(){return this.updating}runTask(e,t=(()=>!0)){let i=!1;for(const[r,s]of this._layerRenderers){if(e.done)break;t(r)&&(s.commitChanges()&&(i=!0,e.madeProgress()),s.isEmpty&&(this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(r),this._handles.remove(r)))}this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),i=!0),i&&(w(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}processSyncLayers(){this.runTask(Et,(e=>1===e.updatePolicy))}addGeometries(e,t,i){for(const r of e)a(r.origin)&&(r.origin=this._localOrigins.getOrigin(r.boundingSphere)),this._geometries.set(r.id,r);this.ensureLayerRenderer(t).add(e),2===i&&this.notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,i){for(const s of e)this._geometries.delete(Ct(s.id));const r=this._layerRenderers.get(t);r&&(r.remove(e),2===i&&this.notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,i){const r=this._layerRenderers.get(t);if(r)switch(r.modify(e,i),i){case 4:case 2:return this.notifyGraphicGeometryChanged(e,t);case 1:return this.notifyGraphicVisibilityChanged(e,t)}else cs.warn("Attempted to update geometry for nonexistent layer")}notifyGraphicGeometryChanged(e,t){if(a(t.notifyGraphicGeometryChanged))return;let i;for(const r of e){const e=r.graphicUid;w(e)&&e!==i&&(t.notifyGraphicGeometryChanged(e),i=e)}}notifyGraphicVisibilityChanged(e,t){if(a(t.notifyGraphicVisibilityChanged))return;let i;for(const r of e){const e=r.graphicUid;w(e)&&e!==i&&(t.notifyGraphicVisibilityChanged(e),i=e)}}updateHighlights(e,t){const i=this._layerRenderers.get(t);i?i.modify(e,8):cs.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!Li.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(e){let t=!1;return this._layerRenderers.forEach((i=>{i.updateLogic(e)&&(t=!0)})),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(e,t,i){const r=e.canvasGeometries;if(0===r.numViews)return!1;const s=e.pixelRatio*i;this._screenToWorldRatio=s*Math.abs(r.extents[0][2]-r.extents[0][0])/Math.abs(e.viewport[2]-e.viewport[0]);const a=t.renderPass;if(this.isEmpty()||5===a&&!this.hasHighlights||3===a&&!this.hasWater)return!1;if(!e.hasSomeSizedView())return!1;const n=t.fbo,o=2*e.resolution,h=e.resolution,l=1===t.type?2:4===t.type?1:0;if(!n.isValid())return!1;n.resize(o,h);const d=this._rctx;if(ms.pixelRatio=s||1,this._renderContext.pass=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,e.applyViewport(this._rctx),n.bind(d),0===e.index&&(d.setClearColor(0,0,0,0),d.clearSafe(16384)),1===l&&(this._renderContext.renderOccludedMask=ys),Li.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==l)for(let c=0;c<r.numViews;c++)this.setViewParameters(r.extents[c],e,ms),this.drawDebugTexture(e.resolution,gs[e.index%gs.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:t,renderer:i})=>{if(2===l&&w(t)&&0===t.drapeSourceType)return;const s=w(t)&&w(t.fullOpacity)&&t.fullOpacity<1&&0===a;s&&(this.bindTemporaryFramebuffer(this._rctx,o,h),d.clearSafe(16384));for(let a=0;a<r.numViews;a++)this.setViewParameters(r.extents[a],e,ms),i.render(this._renderContext,this._bindParameters);s&&w(this._temporaryFBO)&&(n.bind(d),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,Ct(Ct(t).fullOpacity),3,e.index))})),d.bindFramebuffer(null),n.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,i){a(this._temporaryFBO)&&(this._temporaryFBO=new Vi(e,!1)),this._temporaryFBO.resize(t,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.hotReload()}intersect(e,t,i){let r=0;this._geometries.forEach((s=>{if(i&&!i(s))return;this.intersectRenderGeometry(s,t,0,e,r);const a=this.longitudeCyclical;a&&(s.boundingSphere[0]-s.boundingSphere[3]<a.min&&this.intersectRenderGeometry(s,t,a.range,e,r),s.boundingSphere[0]+s.boundingSphere[3]>a.max&&this.intersectRenderGeometry(s,t,-a.range,e,r)),r++}))}intersectRenderGeometry(e,t,i,r,s){if(!e.instanceParameters.visible)return;let a=0;w(e.transformation)&&(i+=e.transformation[12],a=e.transformation[13]),fs[0]=t[0]-i,fs[1]=t[1]-a,fs[2]=1,_s[0]=t[0]-i,_s[1]=t[1]-a,_s[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),r,fs,_s,((t,i,a)=>{this.addIntersectionResult(a,e.material.renderPriority,s,r,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,!0)}addIntersectionResult(e,t,i,r,s,a){const n={type:"external",metadata:{layerUid:s,graphicUid:a}},o=s=>{s.set(n,null,r.results.ground.dist,r.results.ground.normal,r.results.ground.transformation,t,null,null,e,i),s.intersector="OverlayRenderer"};if((null==r.results.min.drapedLayerOrder||t>=r.results.min.drapedLayerOrder)&&(null==r.results.min.dist||r.results.ground.dist<=r.results.min.dist)&&o(r.results.min),0!==r.options.store&&(null==r.results.max.drapedLayerOrder||t<r.results.max.drapedLayerOrder)&&(null==r.results.max.dist||r.results.ground.dist>r.results.max.dist)&&o(r.results.max),2===r.options.store){const e=new nr(r.ray);o(e),r.results.all.push(e)}}stopAnimationsAtTime(e){this._sortedLayerRenderers.forAll((t=>t.renderer.stopAnimationsAtTime(e)))}ensureLayerRenderer(e){let t=this._layerRenderers.get(e);return t||(t=new Vr({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.emitContentChanged())),e),this._handles.add(yt(t,"updating",(()=>this.notifyChange("updating"))),e)),t}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((t=>{const i=t,r=this._layerRenderers.get(i);r&&(this._sortedLayerRenderers.push(new ps(i,r)),e.delete(r))})),e.forEach((e=>this._sortedLayerRenderers.push(new ps(null,e))))}setViewParameters(e,t,i){i.viewport=t.viewport,Dt(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),Ot(i.viewMatrix),Mt(i.viewMatrix,i.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=i,this._bindParameters.camera=i,this._bindParameters.inverseViewport[0]=1/i.fullViewport[2],this._bindParameters.inverseViewport[1]=1/i.fullViewport[3]}emitContentChanged(){this.onContentChanged&&this.onContentChanged()}updateHasWater(){const e=it(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.onHasWaterChanged&&this.onHasWaterChanged(e))}updateHasHighlights(){const e=it(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}updateRendersOccluded(){const e=it(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}drawDebugTexture(e,t){const i=this._rctx;this.ensureDebugPatternResources(e,e);const r=this._debugTextureTechnique.program;i.useProgram(r),i.setPipelineState(this._debugTextureTechnique.pipeline),r.setUniform4f("color",t[0],t[1],t[2],1),r.bindTexture(this._debugPatternTexture,"tex"),i.bindVAO(this._quadVAO),i.drawArrays(5,0,Pt(this._quadVAO,"geometry"))}ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const i=new Uint8Array(e*t*4);let r=0;for(let a=0;a<t;a++)for(let s=0;s<e;s++){const n=Math.floor(s/10),o=Math.floor(a/10);n<2||o<2||10*n>e-20||10*o>t-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&n&&1&o?1&s^1&a?0:255:1&n^1&o?0:128)}this._debugPatternTexture=new mt(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},i);const s=new Wr;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(Gr,s),this._quadVAO=It(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};h([ft()],us.prototype,"_shaderTechniqueRepository",void 0),h([ft()],us.prototype,"_stippleTextureRepository",void 0),h([l({constructOnly:!0})],us.prototype,"view",void 0),h([l()],us.prototype,"globalUnitScale",void 0),h([l()],us.prototype,"spatialReference",void 0),h([l({type:Boolean,readOnly:!0})],us.prototype,"updating",null),us=h([d("esri.views.3d.terrain.OverlayRenderer")],us);class ps{constructor(e,t){this.layerView=e,this.renderer=t}}const gs=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],ms=new Bi;ms.near=1,ms.far=1e4,ms.relativeElevation=null;const fs=b(),_s=b(),vs=-2,ys=4;function ws(e){const t=[],i=[];!function(e,t,i){const{attributeData:{position:r},removeDuplicateStartEnd:s}=e,a=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(r)&&1===s,n=r.length/3-(a?1:0),o=new Uint32Array(2*(n-1)),h=a?Lt(r,0,r.length-3):r;let l=0;for(let d=0;d<n-1;d++)o[l++]=d,o[l++]=d+1;t.push(["position",{size:3,data:h,exclusive:a}]),i.push(["position",o])}(e,i,t);const r=i[0][1].data,s=t[0][1].length,n=new Uint16Array(s);return function(e,t,i){const r=e.attributeData.mapPosition;a(r)||(i.push(["mapPos",i[0][1]]),t.push(["mapPos",{size:3,data:r}]))}(e,i,t),function(e,t,i,r){if(w(e.attributeData.colorFeature))return;const s=e.attributeData.color;t.push(["color",{size:4,data:Tt(s,Ii)}]),i.push(["color",r])}(e,i,t,n),function(e,t,i,r){if(w(e.attributeData.sizeFeature))return;const s=e.attributeData.size;t.push(["size",{size:1,data:[Tt(s,1)]}]),i.push(["size",r])}(e,i,t,n),function(e,t,i,r){const s=e.attributeData.colorFeature;a(s)||(t.push(["colorFeatureAttribute",{size:1,data:new Float32Array([s])}]),i.push(["color",r]))}(e,i,t,n),function(e,t,i,r){const s=e.attributeData.sizeFeature;a(s)||(t.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([s])}]),i.push(["sizeFeatureAttribute",r]))}(e,i,t,n),function(e,t,i,r){const s=e.attributeData.opacityFeature;a(s)||(t.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([s])}]),i.push(["opacityFeatureAttribute",r]))}(e,i,t,n),function(e,t,i,r){if("round"!==e.join)return;const s=r.length/3,a=new Float32Array(s),n=Ss,o=Es;ae(n,0,0,0);const h=Tt(e.uniformSize,1);for(let l=-1;l<s;++l){const e=l<0?s+l:l,t=(l+1)%s;if(ae(o,r[3*t+0]-r[3*e+0],r[3*t+1]-r[3*e+1],r[3*t+2]-r[3*e+2]),oe(o,o),l>=0){const e=(Math.PI-jt(Y(n,o)))*Cs*1*Ts(h);a[l]=Math.max(Math.floor(e),0)}ie(n,o,-1)}t.push(["subdivisions",{size:1,data:a}]),i.push(["subdivisions",i[0][1]])}(e,i,t,r),new _e(i,t,2)}function xs(e,t,i,r){const s="polygon"===e.type?1:0,a="polygon"===e.type?e.rings:e.paths,{position:n,outlines:o}=bi(a,e.hasZ,s),h=new Float64Array(n.length),l=At(n,e.spatialReference,0,h,0,n,0,n.length/3,t,i,r),d=null!=l;return{lines:d?bs(o,n,h):[],projectionSuccess:d,sampledElevation:l}}function bs(e,t,i){const r=new Array;for(const{index:s,count:a}of e){if(a<=1)continue;const e=3*s,n=e+3*a;r.push({position:t.subarray(e,n),mapPosition:i?i.subarray(e,n):void 0})}return r}function Rs(e,t){const i="polygon"===e.type?1:0,r="polygon"===e.type?e.rings:e.paths,{position:s,outlines:a}=bi(r,!1,i),n=fe(s,e.spatialReference,0,s,t,0,s.length/3);for(let o=2;o<s.length;o+=3)s[o]=-2;return{lines:n?bs(a,s):[],projectionSuccess:n}}function Ts(e){return 1.863798+-2.0062872/(1+e/18.2313)**.8856294}const Ss=b(),Es=b(),Cs=4/Math.PI;class Ds{constructor(e,t,i=null,r=null,s=Ft(),a=null,n=null,o=!1){this.data=e,this.material=t,this.layerUid=i,this.graphicUid=r,this.id=s,this.boundingInfo=a,this.calculateShaderTransformation=n,this.castShadow=o,this.boundingSphere=D(),this.instanceParameters={highlights:null,occludees:null,visible:!0},this._transformation=E(),this._shaderTransformationDirty=!0}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,t,i=Ht(e)){a(this.boundingInfo)||(Vt(t,this.boundingInfo.getCenter(),e),t[3]=this.boundingInfo.getBSRadius()*i)}get hasShaderTransformation(){return w(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return a(this.calculateShaderTransformation)?Tt(this.transformation,ve):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=E()),I(this._shaderTransformation,this.calculateShaderTransformation(Tt(this.transformation,ve))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&(w(this._transformation)&&Vt(e,e,this._transformation),!0);const t=this.indices.get("position"),i=this.vertexAttributes.get("position");return!!zt(i,t,e)&&(w(this._transformation)&&Vt(e,e,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const e=new Nt(0),t=this.instanceParameters;return t.highlights=Ut(t.highlights,e),e}removeHighlight(e){const t=this.instanceParameters;t.highlights=Gt(t.highlights,e)}}const Os=b();function Ms(e,t,i,r,s,a,n,o,h,l){const d=i?i.length:0,c=e.clippingExtent;if(Wt(t,Os,e.elevationProvider.spatialReference),w(c)&&!Bt(c,Os))return null;const u=e.renderCoordsHelper.spatialReference;Wt(t,Os,u);const p=e.localOriginFactory.getOrigin(Os),g=new me({castShadow:!1,metadata:{layerUid:o,graphicUid:h,usesVerticalDistanceToGround:!0}});for(let m=0;m<d;m++){const e=s?s[m]:ve;g.addGeometry(i[m],r[m],e,a,p,l)}return{object:g,sampledElevation:qt(g,t,e.elevationProvider,e.renderCoordsHelper,n)}}function Ps(e,t,i){const r=e.elevationContext,s=i.spatialReference;Wt(t,Os,s),r.centerPointInElevationSR=kt(Os[0],Os[1],t.hasZ?Os[2]:0,s)}function Is(e){switch(e.type){case"point":return e;case"polygon":case"extent":return Yt(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const i=Zt(t,$t(t)/2);return kt(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.origin}return null}function As(e,t,i,r,s){const a=new Float64Array(3*e.length),n=new Float64Array(a.length);e.forEach(((e,t)=>{a[3*t+0]=e[0],a[3*t+1]=e[1],a[3*t+2]=e.length>2?e[2]:0}));const o=At(a,t,0,n,0,a,0,a.length/3,i,r,s),h=null!=o;return{numVertices:e.length,position:a,mapPosition:n,projectionSuccess:h,sampledElevation:o}}class Ls{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}const js=1e-5;class Fs{constructor(e){this.options=new Ls,this.results=new ar,this.transform=new Ci,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=js,this.verticalOffset=null,this._ray={origin:b(),direction:b()},this._rayEndPoint=b(),this._rayStartPointTransformed=b(),this._rayEndPointTransformed=b(),this.viewingMode=null==e?1:e}get ray(){return this._ray}get rayBeginPoint(){return this._ray.origin}get rayEndPoint(){return this._rayEndPoint}reset(e,t){this.resetWithRay(Xt(e,t,this._ray))}resetWithRay(e){e!==this._ray&&we(e,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,ye(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}intersect(e=null,t,i,r,s,a){this.point=t,this.camera=i,this.filterPredicate=s,this.tolerance=null==r?js:r;const n=Di(this.verticalOffset);if(w(e)&&e.length>0){const t=a?e=>{a(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const i of e){const e=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();w(e)?(w(n)?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,n):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):i.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){this._numObjectsTested++;const t=e.geometryRecords;if(!t)return;const i=e.id,r=e.transformation;let s;const a=Di(this.verticalOffset);for(const n of t){const{geometry:t,material:o,instanceParameters:h}=n;if(Qt(h))continue;s=t.id,this.transform.setAndInvalidateLazyTransforms(r,n.getShaderTransformation()),Vt(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),Vt(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const l=this.transform.transform;w(a)&&(a.objectTransform=this.transform),o.intersect(t,h,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,((t,r,a,n,o,h)=>{if(t>=0){if(w(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,t))return;const d=`Object3D ${i}`;if(o)return void((null==this.results.hud.dist||t<this.results.hud.dist)&&this.results.hud.set(e,d,t,r,ve,n,h,s,a));const c=i=>i.set(e,d,t,r,l,n,null,s,a);if((null==this.results.min.drapedLayerOrder||n>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||t<this.results.min.dist)&&c(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||n<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||t>this.results.max.dist)&&c(this.results.max),2===this.options.store){const e=new nr(this._ray);c(e),this.results.all.push(e)}}}),n.shaderTransformation)}}sortResults(){this.results.all.sort(((e,t)=>e.dist!==t.dist?e.dist-t.dist:e.drapedLayerOrder!==t.drapedLayerOrder?(void 0!==e.drapedLayerOrder?e.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE):(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==e.drapedLayerGraphicOrder?e.drapedLayerGraphicOrder:Number.MIN_VALUE)))}}function Hs(e){const t=new Se;return t.include(Ee,{linearDepth:!1}),t.include(Jt,e),t.include(Kt,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(Re`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(t.attributes.add("auxpos1","vec3"),t.vertex.uniforms.add("ndcToPixel","vec2"),t.vertex.code.add(Re`
    vec4 vpos2 = transformPosition(proj, view, auxpos1);
    float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);

    stipplePatternUv = lineSegmentPixelSize * stipplePatternPixelSizeInv;
    ${e.stippleIntegerRepeatsEnabled?"stipplePatternUv = floor(stipplePatternUv + 0.5);":""}

    // Cancel out perspective correct interpolation because we want this length the really represent
    // the screen distance
    stipplePatternUv *= gl_Position.w;
    `)),t.vertex.code.add(Re`}`),4===e.output&&t.include(Pe),t.include(Oe,e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(Re`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${Re.float(Ce)}) {
      discard;
    }

    ${0===e.output?Re`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${4===e.output?Re`outputHighlight();`:""}
  }
  `),t}Fs.DEFAULT_TOLERANCE=js;var Vs=Object.freeze({__proto__:null,build:Hs});class zs extends je{constructor(e,t,i){super(e,t,i),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=zs.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:!1,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled});return new Fe(e.rctx,r,He)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if(Ve(this.program,t.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.configuration.stippleEnabled){const e=w(this.stippleTextureBind)?this.stippleTextureBind(this.program)*t.camera.pixelRatio:1;this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/e),this.program.setUniform2f("ndcToPixel",t.camera.fullViewport[2]/2,t.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*t.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const t=Ct(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}4===this.configuration.output&&Ne(this.program,t)}bindDraw(e){Ue(this.program,e),We(this.program,this.configuration,e),this.program.rebindTextures()}initializePipeline(){const e=this.configuration,t=ut(770,1,771,771),i=(t,i=null,r=null)=>Be({blending:i,depthTest:ei,depthWrite:r,colorWrite:Xe,stencilWrite:e.sceneHasOcludees?ti:null,stencilTest:e.sceneHasOcludees?t?ii:ri:null});return 0===e.output?(this._occludeePipelineState=i(!0,e.transparent||e.stippleEnabled?t:null,$e),i(!1,e.transparent||e.stippleEnabled?t:null,$e)):i(!1)}get primitiveType(){return 1}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}zs.shader=new Le(Vs,(()=>import("./NativeLine.glsl.cbd17773.js")));class Ns extends Ae{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.sceneHasOcludees=!1}}h([Ie({count:8})],Ns.prototype,"output",void 0),h([Ie()],Ns.prototype,"slicePlaneEnabled",void 0),h([Ie()],Ns.prototype,"vertexColors",void 0),h([Ie()],Ns.prototype,"transparent",void 0),h([Ie()],Ns.prototype,"stippleEnabled",void 0),h([Ie()],Ns.prototype,"stippleOffColorEnabled",void 0),h([Ie()],Ns.prototype,"stippleIntegerRepeatsEnabled",void 0),h([Ie()],Ns.prototype,"sceneHasOcludees",void 0);const Us=x.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");class Gs extends ni{constructor(e){super(e,qs),this.techniqueConfig=new Ns}getTechniqueConfig(e){this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;const t=w(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleOffColorEnabled=t&&w(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,r,s,a,n,o,h){h?oi(e,r,a,1,n):this.intersectLineGeometry(e,t,i,r,n)}intersectLineGeometry(e,t,i,r,s){if(!r.options.selectionMode||Qt(t))return;if(!hi(i))return void Us.error("intersection assumes a translation-only matrix");const a=e.vertexAttributes.get("position").data,n=r.camera,o=ia;W(o,r.point);ae(ra[0],o[0]-2,o[1]+2,0),ae(ra[1],o[0]+2,o[1]+2,0),ae(ra[2],o[0]+2,o[1]-2,0),ae(ra[3],o[0]-2,o[1]-2,0);for(let c=0;c<4;c++)if(!n.unprojectFromRenderScreen(ra[c],sa[c]))return;li(n.eye,sa[0],sa[1],aa),li(n.eye,sa[1],sa[2],na),li(n.eye,sa[2],sa[3],oa),li(n.eye,sa[3],sa[0],ha);let h=Number.MAX_VALUE;for(let c=0;c<a.length-5;c+=3){if(ks[0]=a[c]+i[12],ks[1]=a[c+1]+i[13],ks[2]=a[c+2]+i[14],Zs[0]=a[c+3]+i[12],Zs[1]=a[c+4]+i[13],Zs[2]=a[c+5]+i[14],di(aa,ks)<0&&di(aa,Zs)<0||di(na,ks)<0&&di(na,Zs)<0||di(oa,ks)<0&&di(oa,Zs)<0||di(ha,ks)<0&&di(ha,Zs)<0)continue;if(n.projectToRenderScreen(ks,Xs),n.projectToRenderScreen(Zs,Qs),Xs[2]<0&&Qs[2]>0){P($s,ks,Zs);const e=n.frustum,t=-di(e[4],ks)/Y($s,ci(e[4]));ie($s,$s,t),ye(ks,ks,$s),n.projectToRenderScreen(ks,Xs)}else if(Xs[2]>0&&Qs[2]<0){P($s,Zs,ks);const e=n.frustum,t=-di(e[4],Zs)/Y($s,ci(e[4]));ie($s,$s,t),ye(Zs,Zs,$s),n.projectToRenderScreen(Zs,Qs)}else if(Xs[2]<0&&Qs[2]<0)continue;Xs[2]=0,Qs[2]=0;const e=ui(pi(Xs,Qs,ea),o);e<h&&(h=e,O(Js,ks),O(Ks,Zs))}const l=r.rayBeginPoint,d=r.rayEndPoint;if(h<4){let e=Number.MAX_VALUE;if(gi(pi(Js,Ks,ea),pi(l,d,ta),Ys)){P(Ys,Ys,l);const t=se(Ys);ie(Ys,Ys,1/t),e=t/N(l,d)}s(e,Ys)}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return!1;const r=i.get("position");return mi(r,null,!1,t)}createBufferWriter(){const e=this.params.vertexColors?fi:_i;return a(this.params.stipplePattern)?new vi(e):new Bs(e.clone().vec3f("auxpos1"))}getGLMaterial(e){return 0===e.output||4===e.output?new Ws(e):void 0}}class Ws extends Je{constructor(e){super(e),this.updateParameters()}updateParameters(){this._technique=this._techniqueRep.releaseAndAcquire(zs,this._material.getTechniqueConfig(this._output),this._technique)}beginSlot(e){return 3===e}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())}ensureParameters(e){0===this._output&&this._updateOccludeeState(e)}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}getPipelineState(e,t){return this._technique.getPipelineState(t)}}class Bs{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){yi(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r),this.writeAuxpos1(e,t,i,r)}writeAuxpos1(e,t,i,r){const s=i.getField("auxpos1",wi),a=t.indices.get("position"),n=t.vertexAttributes.get("position").data,o=e.transformation,h=s.typedBufferStride,l=s.typedBuffer;r*=h;for(let d=0;d<a.length;d+=2){const e=3*a[d],t=n[e],i=n[e+1],s=n[e+2],c=o[0]*t+o[4]*i+o[8]*s+o[12],u=o[1]*t+o[5]*i+o[9]*s+o[13],p=o[2]*t+o[6]*i+o[10]*s+o[14];for(let a=0;a<2;++a)l[r]=c,l[r+1]=u,l[r+2]=p,r+=h}}}const qs=((e,a)=>{for(var n in a||(a={}))i.call(a,n)&&s(e,n,a[n]);if(t)for(var n of t(a))r.call(a,n)&&s(e,n,a[n]);return e})({color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1},xi),ks=b(),Zs=b(),$s=b(),Ys=b(),Xs=ce(),Qs=ce(),Js=b(),Ks=b(),ea=si(),ta=si(),ia=b(),ra=[ce(),ce(),ce(),ce()],sa=[b(),b(),b(),b()],aa=ai(),na=ai(),oa=ai(),ha=ai();export{vs as $,Gs as H,Bi as J,Cr as R,Li as T,Ps as a,ws as b,Dr as c,Is as d,Oi as e,Ms as f,xs as g,As as h,ir as i,nr as j,Nr as k,Ds as l,Hs as m,xr as n,Tr as p,Mi as r,Pi as t,Fs as u,Rs as z};
