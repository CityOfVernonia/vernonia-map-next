var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,s=(t,n,a)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[n]=a,o=(e,t)=>{for(var n in t||(t={}))i.call(t,n)&&s(e,n,t[n]);if(a)for(var n of a(t))r.call(t,n)&&s(e,n,t[n]);return e},l=(e,a)=>t(e,n(a));import{t as c}from"./_rollupPluginBabelHelpers.1eead684.js";import{an as d,be as u,a as f,ab as p,pa as m,dR as g,a7 as y,a6 as w,pu as b,bv as h,d0 as I,dH as j,dc as F,eC as T,om as k,a8 as v,pv as O}from"./vendor.c9efa5f2.js";import{I as x,T as S,k as N}from"./geojson.a7aaa7d9.js";import{u as P}from"./clientSideDefaults.c1d61e72.js";const q=d.getLogger("esri.layers.graphics.sources.ogcfeature");async function M(e,t,n={},a=5){const{links:i}=e,r=A(i,"items","application/geo+json")||A(i,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(u(r))throw new f("ogc-feature-layer:missing-items-page","Missing items url");const{data:s}=await p(r.href,{signal:n.signal,query:l(o({limit:a},n.customParameters),{token:n.apiKey}),headers:{accept:"application/geo+json"}});await x(s);const c=S(s,{geometryType:t.geometryType}),d=t.fields||c.fields||[],y=null!=t.hasZ?t.hasZ:c.hasZ,w=c.geometryType,b=t.objectIdField||c.objectIdFieldName||"OBJECTID";let h=t.timeInfo;const I=d.find((e=>e.name===b));if(I)I.type="esriFieldTypeOID",I.editable=!1,I.nullable=!1;else{if(!c.objectIdFieldType)throw new f("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");d.unshift({name:b,alias:b,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(b!==c.objectIdFieldName){const e=d.find((e=>e.name===c.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}if(!w)throw new f("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");d===c.fields&&c.unknownFields.length>0&&q.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:c.unknownFields}});for(const o of d){if(null==o.name&&(o.name=o.alias),null==o.alias&&(o.alias=o.name),"esriFieldTypeOID"!==o.type&&"esriFieldTypeGlobalID"!==o.type&&(o.editable=null==o.editable||!!o.editable,o.nullable=null==o.nullable||!!o.nullable),!o.name)throw new f("ogc-feature-layer:invalid-field-name","field name is missing",{field:o});if(-1===m.jsonValues.indexOf(o.type))throw new f("ogc-feature-layer:invalid-field-type",`invalid type for field "${o.name}"`,{field:o})}if(h){const e=new g(d);if(h.startTimeField){const t=e.get(h.startTimeField);t?(h.startTimeField=t.name,t.type="esriFieldTypeDate"):h.startTimeField=null}if(h.endTimeField){const t=e.get(h.endTimeField);t?(h.endTimeField=t.name,t.type="esriFieldTypeDate"):h.endTimeField=null}if(h.trackIdField){const t=e.get(h.trackIdField);t?h.trackIdField=t.name:(h.trackIdField=null,q.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:h}}))}h.startTimeField||h.endTimeField||(q.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:h}}),h=null)}return{drawingInfo:P(w),geometryType:w,fields:d,hasZ:!!y,objectIdField:b,timeInfo:h}}async function D(e,t={}){const{links:n}=e,a=A(n,"data","application/json")||A(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(u(a))throw new f("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:i,customParameters:r,signal:s}=t,{data:c}=await p(a.href,{signal:s,headers:{accept:"application/json"},query:l(o({},r),{token:i})});return c}async function C(e,t={}){const{links:n}=e,a=A(n,"conformance","application/json")||A(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(u(a))throw new f("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:i,customParameters:r,signal:s}=t,{data:c}=await p(a.href,{signal:s,headers:{accept:"application/json"},query:l(o({},r),{token:i})});return c}async function R(e,t={}){const{apiKey:n,customParameters:a,signal:i}=t,{data:r}=await p(e,{signal:i,headers:{accept:"application/json"},query:l(o({},a),{token:n})});return r}async function W(e,t={}){const n="application/vnd.oai.openapi+json;version=3.0",a=A(e.links,"service-desc",n);if(u(a))return q.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:i,customParameters:r,signal:s}=t,{data:c}=await p(a.href,{signal:s,headers:{accept:n},query:l(o({},r),{token:i})});return c}function G(e){const t=c(/^http:\/\/www\.opengis.net\/def\/crs\/(.*)\/(.*)\/(.*)$/i,{authority:1,version:2,code:3}).exec(e),n=null==t?void 0:t.groups;if(!n)return null;const{authority:a,code:i}=n;switch(a.toLowerCase()){case"ogc":switch(i.toLowerCase()){case"crs27":return y.GCS_NAD_1927;case"crs83":return new y({wkid:4269});case"crs84":case"crs84h":return y.WGS84;default:return null}case"esri":case"epsg":{const e=Number.parseInt(i,10);return Number.isNaN(e)?null:900913===e?y.WebMercator:new y({wkid:e})}default:return null}}async function $(e,t,n){const a=await Z(e,t,n);return w.fromJSON(a)}async function Z(e,t,n){const a=await K(e,t,n);return b(a)}async function K(e,t,n){const{capabilities:{query:{maxRecordCount:a}},collection:i,layerDefinition:r,queryParameters:{apiKey:s,customParameters:c},spatialReference:d,supportedCrs:m}=e,{links:g}=i,w=A(g,"items","application/geo+json")||A(g,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(u(w))throw new f("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:b,num:I,start:x,timeExtent:S,where:P}=t;if(t.objectIds)throw new f("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const q=y.fromJSON(d),M=h(t.outSpatialReference,q),D=M.isWGS84?null:J(M,m),C=function(e,t){if(!function(e){return v(e)&&"extent"===e.type}(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:L(e)};const a=J(n,t);return a?{bbox:L(e),"bbox-crs":a}:n.isWebMercator?{bbox:L(T(e,y.WGS84))}:null}(b,m),R=function(e){if(u(e))return null;const{start:t,end:n}=e;return`${v(t)?t.toISOString():".."}/${v(n)?n.toISOString():".."}`}(S),W=function(e){return u(e)||!e||"1=1"===e?null:e}(P),G=null!=I?I:null!=x&&void 0!==x?10:a,{data:$}=await p(w.href,l(o({},n),{query:l(o(o({},c),C),{crs:D,datetime:R,query:W,limit:G,startindex:x,token:s}),headers:{accept:"application/geo+json"}}));let Z=!1;$.links&&(Z=!!$.links.find((e=>"next"===e.rel))),!Z&&Number.isInteger($.numberMatched)&&Number.isInteger($.numberReturned)&&(Z=$.numberReturned<$.numberMatched);const{fields:K,globalIdField:E,hasM:_,hasZ:B,objectIdField:H}=r,Q=r.geometryType,V=N($,{geometryType:Q,hasZ:B,objectIdField:H});if(!D&&M.isWebMercator)for(const o of V)if(o.geometry){const e=j(o.geometry,Q,B,!1);e.spatialReference=y.WGS84,o.geometry=F(T(e,M))}for(const o of V)o.objectId=o.attributes[H];const z=D||!D&&M.isWebMercator?M.toJSON():k,U=new O;return U.exceededTransferLimit=Z,U.features=V,U.fields=K,U.geometryType=Q,U.globalIdFieldName=E,U.hasM=_,U.hasZ=B,U.objectIdFieldName=H,U.spatialReference=z,U}function J(e,t){return t.find((t=>{const n=G(t);return I(n,e)}))}function L(e){const{xmin:t,ymin:n,xmax:a,ymax:i}=e;return`${t},${n},${a},${i}`}function A(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}export{Z as M,G as N,K as O,C as S,M as T,D as k,$ as q,W as v,R as x};
